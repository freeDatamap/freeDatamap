/*-------------------------
http://www.freedatamap.com/
---------------------------

freeDatamap no-charge License

Copyright 2013-2016, freeDatamap / Patrick Duverger
All rights reserved.

--------------
PLAIN SUMMARY:
--------------

You may use freeDatamap at no charge in non-commercial apps, web sites, components, and other software as long as end users are not charged a fee of any kind to use your product or gain access to any part of it. If your client pays you for your site/product using the freeDatamap technology, you should have signed up for the freeDatamap commercial licence before. You can ask for the full commercial license here freedatamap@gmail.com.

Use at your own risk. No warranties are offered.

Respect the copyright.

Redistributions of source code in non-commercial usage must retain the above copyright notice, the plain summary and the following list of conditions.

Redistributions in binary form must reproduce the above copyright notice, the plain summary and the following list of conditions in the documentation and/or other materials provided with the distribution.

The name freeDatamap may not be used to endorse or promote products derived from this software without specific prior written permission. Ask freedatamap@gmail.com for details.

---------
LEGALESE:
---------

This is a legal agreement between you (either an individual or a single entity) and freeDatamap, for the proprietary freeDatamap code and all other files that are available for download at http://www.freedatamap.com (this code and documentation, as well as any updates which may at freeDatamap's sole discretion be provided to you from time to time, are referred to in this Agreement as "PROGRAM"). By downloading, copying, or otherwise using the PROGRAM, you agree to the terms and conditions of this Agreement.
If you do not agree to the terms and conditions of this Agreement, please do not download or use the PROGRAM.

I. LICENSE

A. Subject to the terms and conditions of this Agreement, freeDatamap hereby grants you a non-exclusive, worldwide, non-transferable right to use the PROGRAM in apps, web sites, games, components and other software applications ("Developed Works") for which the end user is NOT charged any fees.
If you would like to use the code in a commercially licensed Developed Work for which end users are charged a fee (either for usage or access), simply sign up for the appropriate commercial freeDatamap License by asking at freedatamap@gmail.com.

II. LIMITATION OF LICENSE AND RESTRICTIONS

A. You agree that you will not sell, rent, or license the PROGRAM's source code or any derivative works thereof to any third party without the prior written consent of freeDatamap. Distribution of the PROGRAM as part of your Developed Work is acceptable so long as it is used exclusively as a part of your Developed Work without any charge for the end user. You agree not to modify or delete freeDatamap's existing copyright notices located in the source code.

B. You may use, duplicate, and distribute the compiled object code as embedded in Developed Works created by you, either for your own use or for distribution to a third party so long as end users of the Developed Work are not charged a fee for usage of or access to any portion of the Developed Work.

C. You may make modifications to the source code exclusively for your own use in order to perform bug fixes or other minor edits required to operate the PROGRAM as originally intended.

III. CONSIDERATION

A. The license rights granted to you under this Agreement are at no charge, but only in the following circumstances: If on your own behalf or on behalf of a third party you incorporate the PROGRAM into a web site, app, game, program or any component thereof (collectively, "Developed Work"), which in the case of a web site, must be accessible to internet users without payment of a fee of any kind, and in the case of a software application, game, program or component, neither you nor anyone to whom you distribute the Developed Work charges a user a fee of any kind to use such Developed Work or application, game, program or component into which such Developed Work is embedded. The foregoing shall apply regardless of whether you are paid to create such Developed Work.

B. In the event your intended use of the PROGRAM does not meet the criteria for the "no charge" license rights set forth in the immediately preceding paragraph, then you are not licensed to use the PROGRAM under this Agreement and must license the PROGRAM under freeDatamap's commercial license and ask freeDatamap for that at freedatamap@gmail.com.

C. You may make modifications to the source code exclusively for your own use in order to perform bug fixes or other minor edits required to operate the PROGRAM as originally intended.

IV. TITLE AND OWNERSHIP

In the scope of this present non-commercial license, the PROGRAM is licensed, not sold, and is protected by copyright laws and international treaty provisions. You acknowledge that no title to the intellectual property in the PROGRAM is transferred to you. You further acknowledge that title and full ownership rights to the PROGRAM, including all intellectual property rights therein, will remain the exclusive property of freeDatamap and you will not acquire any rights to the PROGRAM except as expressly set forth in this Agreement. You agree that any copies of the PROGRAM you make will contain the same proprietary notices which appear on and in the PROGRAM. You agree that freeDatamap may identify you as a licensee unless you make a written request otherwise. freeDatamap hereby grants to you the right to disclose that your product, game, software application, component, or other Developed Work makes use of freeDatamap code (for example, "Powered by freeDatamap").

V. DISCLAIMER OF WARRANTY AND LIMITATION OF LIABILITY

A. THE PROGRAM IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. freeDatamap DOES NOT WARRANT THAT THE FUNCTIONS CONTAINED IN THE PROGRAM WILL MEET YOUR REQUIREMENTS OR THAT OPERATION WILL BE UNINTERRUPTED OR ERROR FREE.
IN NO EVENT SHALL FREEDATAMAP BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

B. freeDatamap may, at its sole discretion, provide support services, but has no obligation to do so.

VI. TERMINATION

If you at any time fail to abide by the terms of this Agreement, freeDatamap shall have the right to immediately terminate the license granted herein and pursue any other legal or equitable remedies available.

VII. MISCELLANEOUS

A. This agreement represents the complete and exclusive statement of the agreement between freeDatamap and you and supersedes all prior agreements, proposals, representations and other communications, verbal or written, between them with respect to use of the program. This agreement may be modified only with the mutual written approval of authorized representatives of the parties.

B. The terms and conditions of this Agreement shall prevail notwithstanding any different, conflicting, or additional terms or conditions which may appear in any purchase order or other document submitted by you. You agree that such additional or inconsistent terms are deemed rejected by freeDatamap.

C. freeDatamap and you agree that any xerographically or electronically reproduced copy of this Agreement shall have the same legal force and effect as any copy bearing original signatures of the parties.*/


function dm_ServerTools(){}function dm_tools_NameIdList(){this.listByName={},this.listByUniqueId={};var a=this;this.updateName=function(b){var c=a.listByName[b.name];c||(c=[],a.listByName[b.name]=c),c.push(b)},this.addObject=function(b){b&&(a.updateName(b),a.listByUniqueId[b.dm_uniqueId]=b)},this.updateNames=function(){a.listByName={};var b;for(var c in a.listByUniqueId)b=a.listByUniqueId[c],a.updateName(b)},this.removeObject=function(b){var c;if(delete a.listByUniqueId[b.dm_uniqueId],b.name){var d=a.listByName[b.name];d&&(c=d.indexOf(b),c>=0&&d.splice(c,1))}},this.getObject=function(b){return a.listByUniqueId[b]},this.getObjects=function(b){return a.listByName[b]},this.getFirstObject=function(b){var c,d=a.listByName[b];return d&&d.length>0&&(c=d[0]),c},this.updateAndGetNames=function(){return a.updateNames(),a.getNames()},this.getNames=function(){var b=[];for(var c in a.listByName)b.push(c);return b},this.setAll=function(b){var c;for(var d in a.listByUniqueId){c=a.listByUniqueId[d];for(var e in b)c[e]=b[e]}},this.getAll=function(){var b=[];for(var c in a.listByUniqueId)b.push(a.listByUniqueId[c]);return b},this.concat=function(b){for(id in b.listByUniqueId)a.addObject(b.listByUniqueId[id]);return a}}function dm_Tools(){}function dm_Csv(a,b,c){this.dataTable,this.root,this.nodes=new dm_tools_NameIdList;var d=b.columns,e=b.root,f=b.setColumns2node,g=b.styles,h=b.options;this.options=h||{};var i=this,j={},k=function(a){var b=j[a.dm_uniqueId];return b||(b=dm_Tools.getNodePath(a),j[a.dm_uniqueId]=b),b},l=function(a){var b=a;return b&&(b=b.replace(/\./g," ").replace(/'/g,"").replace(/"/g,""),b=b.trim()),b},m=function(){for(var c,e,f,g=[],h=1;h<a.length;h++){if(c=a[h],g.length<c.length)for(var i=g.length;i<c.length;i++)f={},f.dm_columnName=l(a[0][i]),f.dm_columnIndex=i,f.dm_rejectIt=!1,g.push(f);for(var i=0;i<c.length;i++)e=c[i],e&&""!=e?(g[i][e]||(g[i][e]=0),g[i][e]++):(g[i].dm_numberOfEmpty||(g[i].dm_numberOfEmpty=2),g[i].dm_numberOfEmpty++)}var j=dm_Tools.clone(g),k=function(a){var b=Object.keys(a).length;return b-=3},m=function(a){var b=k(a);return 1==b&&(b=Number.MAX_VALUE),b==Number.MAX_VALUE&&(a.dm_rejectIt=!0),b},n=function(a,b){var c=a.dm_numberOfEmpty,d=.9*m(a)+.1*(c>0?c:1);return d};g.sort(function(b,c){return n(b,a.length)==n(c,a.length)?0:n(b,a.length)<n(c,a.length)?-1:1}),j.sort(function(a,b){return k(a)==k(b)?0:k(a)<k(b)?1:-1});for(var o=j[0],h=0;h<j.length&&0==o.dm_columnName.indexOf("dm_");h++)o=j[h];console.log("chosen column for leaves : "+o.dm_columnName);var p=b.maxNbOfColumns2tree||10;p=Math.min(p,g.length),b.columns=[];for(var q,r=!1,h=0;p>h;h++)q=g[h].dm_columnName,q==o.dm_columnName&&(r=!0),q||(q="column_"+h),0==q.indexOf("dm_")||2!=a.length&&g[h].dm_rejectIt||b.columns.push({columnIndex:g[h].dm_columnIndex,name:q});r||b.columns.splice(b.columns.length>0?b.columns.length-1:0,1,{columnIndex:o.dm_columnIndex,name:o.dm_columnName}),d=b.columns},n=function(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d];a[e]&&(c=d)}return c},o=function(a,b){for(var c=-1,d=0;0>c&&d<b.length;d++){var e=b[d];a[e]||(c=d)}return c},p=function(a){var b=a;return dm_Tools.isArray(a)||"object"==typeof a&&(null!==a.columnIndex&&void 0!==a.columnIndex?b=a.columnIndex:a.name?b=a.name:a.children&&(b=a.children)),b},q=function(){var c,h,j,k,l,q,u,w,y,z,A;for(d&&0!=d.length||m(),k=1;k<a.length;k++)if(c=a[k],h=e,j=null,z=n(c,d),A=o(c,d),d){b.styles&&d.length<b.styles.length&&b.styles.splice(d.length,b.styles.length-d.length-1),b.displayProps&&d.length<b.displayProps.length&&b.displayProps.splice(d.length,b.displayProps.length-d.length-1),y=null;var B,C=!1;if("rejectHolesInRows"==i.options.readMode){var D=!1;for(l=0;!D&&l<d.length;l++)B=p(d[l]),c[B]||(D=!0);C=D}else"rejectHolesInBranch"==i.options.readMode&&A>=0&&z>A&&(C=!0);for(l=0;l<d.length;l++){if(B=p(d[l]),dm_Tools.isArray(B))for(w=B,u="",q=0;q<w.length;q++){q>0&&(u+=" ");var E=w[q];u+=null==E?c[0]:"string"==typeof E?c[E]:"object"==typeof E?void 0!=E.columnIndex?c[E.columnIndex]:c[E.name]:c[E]}else u=c[B];if(u||b.emptyFieldsAsNodes){var F=!1;if(u||(F=!0,u=b.emptyFieldsAsNodes),y=u,C)j=v(h,j,!0);else{var G=t(h,u,c,g[l+1],j,f);j=G.parent;var H=G.child;if(b.displayColumnsAsAttributes&&s(H,d,l),F&&b.emptyFieldsAsNodes){var I=r(d,l);(!H.rawNode.displayName||H.rawNode.displayName.indexOf(I+": ")<0)&&(H.rawNode.displayName=I+": "+H.name)}}h=u}else if(l==n(c,d)+1&&j){var H=v(y,j,!0);H&&x(H,c,f,!1)}}}},r=function(a,b){var c=a[b],d=c.name;if(!d&&c.children){d="";for(var e=0;e<c.children.length;e++)d+=c.children[e].name}return d},s=function(a,b,c){var d=r(b,c);a.rawNode||(a.rawNode={}),a.rawNode.dm_columnName=d,a.rawNode["dm_columnName.dm_props"]||(a.rawNode["dm_columnName.dm_props"]={}),a.rawNode["dm_columnName.dm_props"].visible=!1,a.rawNode["dm_columnName.dm_props"].edit=!1;for(var e,f=0;c>=f;f++)e=b[f],a.rawNode[e.name+".dm_props"]||(a.rawNode[e.name+".dm_props"]={}),a.rawNode[e.name+".dm_props"].order=10+f,a.rawNode[e.name+".dm_props"].visible=!0},t=function(a,b,c,d,e,f){var g,h,i;return g=w(e,a,c,f),h=w(g,b,c,f,d),i=g.children||(g.children=[]),i.indexOf(h)<0&&i.push(h),{parent:g,child:h}},u=function(a,b){return node={name:a,parent:b},i.nodes.addObject(node),node},v=function(a,b,c){a=dm_Tools.decodeValue(a,i.options.decodeURI);var d,e;if(b){var f=dm_Tools.getChildren(b,a);f&&f.length>0?1==f.length?e=f[0]:d=f:e||c||(e=u(a,b))}if(!e&&(d||(d=i.nodes.getObjects(a)),d))if(!b&&d.length>0)e=d[0];else for(var g,h=k(b),j=d.length-1;!e&&j>=0;j--)g=d[j],g.parent&&g.parent.name==b.name&&k(g.parent)==h&&(e=g);return e||c||(e=u(a,b,c)),e},w=function(a,b,c,d,e){var f;return f=v(b,a),e&&(f.level||(f.level=e.level,x(f,c,d))),i.root||(f.level=0,i.root=f),f},x=function(b,d,e,f){if(d){var g,h,j,k=a[0],m=function(a,b){c&&(j=c[b],j&&j.indexOf(a)<0&&j.push(a))};if(!b.rawNode||f)if(b.rawNode={},e&&e[b.level])for(var n,o=e[b.level].length,p=0;o>p;p++)n=e[b.level][p],isNaN(n)?(g=n,n=k.indexOf(n)):g=l(k[n]),h=d[n],b.rawNode[g]=dm_Tools.decodeValue(h,i.options.decodeURI),m(h,g);else for(var g,o=k.length,p=0;o>p;p++)g=l(k[p]),h=d[p],b.rawNode[g]=dm_Tools.decodeValue(h,i.options.decodeURI),m(h,g)}};q()}function dm_LDIF(){}function dm_Freemind(){}function dm_Json2tree(a,b){this.nodes=new dm_tools_NameIdList;var c=this,d=function(a){var e,f;dm_Tools.bestEffortLevel(a);for(e in a)dm_Json2tree.reservedProps.indexOf(e)<0&&(a.rawNode||(a.rawNode={}),a.rawNode[e]=a[e]);if(a.rawNode)for(e in a.rawNode)f=a.rawNode[e],listValue=b[e],listValue&&listValue.indexOf(f)<0&&listValue.push(f);c.nodes.addObject(a),a.children&&a.children.forEach(function(b){b&&(b.parent=a,d(b))})};d(a)}dm_ServerTools.ARRAY_PROPS={length:"number",sort:"function",slice:"function",splice:"function"},dm_ServerTools.isArray=function(a){if(!a||"number"==typeof a||"string"==typeof a||"boolean"==typeof a)return!1;if(a instanceof Array)return!0;for(var b in dm_ServerTools.ARRAY_PROPS)if(!(b in a&&typeof a[b]==dm_ServerTools.ARRAY_PROPS[b]))return!1;return!0},dm_ServerTools.parseAtomic=function(a){var b=a;if("true"==b)b=!0;else if("false"==b)b=!1;else if(b&&!isNaN(b))try{var c=parseFloat(b);isNaN(c)||(b=c)}catch(d){}return b},dm_ServerTools.getUrlFirstArg=function(a){var b={},c=a.lastIndexOf("?");0>c&&(c=0),a=a.substring(c+1);var d=a.indexOf("&");d>0&&(a=a.substring(0,d));var e=a.indexOf("=");return e>0?(b.command=a.substring(0,e),b.value=a.substring(e+1)):b.command=a,b},dm_ServerTools.replaceAll=function(a,b,c){return a.split(b).join(c)},dm_ServerTools.getUrlParams=function(a){var b,c=a.lastIndexOf("?");0>c&&(c=0),a=a.substring(c+1);for(var d=function(a){for(var b,c=0;2>c;c++)0==c&&(b||(b={}),b.name=a[c]),1==c&&(b.value=a[c]);return b},e=a.split("&"),f=0;f<e.length;f++){var g=e[f].split("=");b?dm_ServerTools.isArray(b)?b.push(d(g)):b=[b,d(g)]:b=d(g)}return b},dm_ServerTools.getUrlParam=function(a,b){var c,d=dm_ServerTools.getUrlParams(a);if(dm_ServerTools.isArray(d))for(var e,f=0;!c&&f<d.length;f++)e=d[f],e.name==b&&(c=e.value);else b==d.name&&(c=d.value);return c=dm_ServerTools.parseAtomic(c)},dm_ServerTools.defaultDiacriticsRemovalap=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],dm_ServerTools.diacriticsMap={},dm_ServerTools.createDiacriticsMap=function(){for(var a=0;a<dm_ServerTools.defaultDiacriticsRemovalap.length;a++)for(var b=dm_ServerTools.defaultDiacriticsRemovalap[a].letters.split(""),c=0;c<b.length;c++)dm_ServerTools.diacriticsMap[b[c]]=dm_ServerTools.defaultDiacriticsRemovalap[a].base},dm_ServerTools.createDiacriticsMap(),dm_ServerTools.removeDiacritics=function(a){function b(a){return dm_ServerTools.diacriticsMap[a]||a}if(a)return(""+a).replace(/[^\u0000-\u007E]/g,b)},dm_ServerTools.removeSpecialChars=function(a,b){return a=b?a.replace(/[`~!@#$%^&*()_|+\-=?;:'",<>\{\}\[\]\\\/]/gi,"_"):a.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"_")},dm_ServerTools.formatJSVarName=function(a,b){if(!a)return void console.log("Warning : giving null to dm_ServerTools.formatJSVarName");var a=dm_ServerTools.removeDiacritics(a);return a=dm_ServerTools.removeSpecialChars(a,b),a=a.replace(/\ /g,"_")},dm_ServerTools.equalsOrRexgexpMatch=function(a,b,c){var d=a==b;if(!d&&c)try{var e=new RegExp(a);d=e.test(b),d&&a.length!=b.length&&(a.indexOf(b)>=0||b.indexOf(a)>=0)&&(d=!1)}catch(f){}return d},dm_ServerTools.getChildIndexAndObj=function(a,b){var c;if(a){var d,e;if(a.children)for(d=0;!c&&d<a.children.length;d++)e=a.children[d],e&&dm_ServerTools.equalsOrRexgexpMatch(b,e.name)&&(c={index:d,obj:e})}return c},dm_ServerTools.getChild=function(a,b,c){var d=dm_ServerTools.getChildIndexAndObj(a,b,c);return d&&(d=d.obj),d},dm_ServerTools.encode_utf8=function(a){return encode_latin1(unescape(encodeURIComponent(a)))},dm_ServerTools.encode_latin1=function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++){var d=a.charCodeAt(c);if((255&d)!==d)throw{message:"Cannot encode string in Latin1",str:a};b[c]=255&d}return b},dm_ServerTools.decode_utf8=function(a){return decodeURIComponent(escape(decode_latin1(a)))},dm_ServerTools.decode_latin1=function(a){for(var b=[],c=0;c<a.length;c++)b.push(String.fromCharCode(a[c]));return b.join("")},dm_ServerTools.to_hex=function(a){for(var b=[],c=0;c<a.length;c++)b.push("0123456789abcdef"[a[c]>>4&15]),b.push("0123456789abcdef"[15&a[c]]);return b.join("")},dm_ServerTools.from_hex=function(a){for(var b=new Uint8Array(a.length/2),c=0;c<a.length/2;c++)b[c]=parseInt(a.substr(2*c,2),16);return b},dm_ServerTools.hexEncode=function(a){var b,c,d="";for(c=0;c<a.length;c++)b=a.charCodeAt(c).toString(16),1==b.length&&(b="0"+b),0==b.length&&(b="00"),d+=b;return d},dm_ServerTools.hexDecode=function(a){var b,c=a.match(/.{1,2}/g)||[],d="";for(b=0;b<c.length;b++)d+=String.fromCharCode(parseInt(c[b],16));return d},dm_ServerTools.formatStr2fileName=function(a){return a=a.replace(/@/g,"_at_"),a=a.replace(/\./g,"_dot_")},dm_ServerTools.zip=function(a,b){var c,b=b||"data";try{c=new nodeZip}catch(d){c=new JSZip}c.file(b,a);var e=c.generate({base64:!1,compression:"DEFLATE"});return e},dm_ServerTools.unzip=function(a,b){var c,d,b=b||"data";try{c=new nodeZip(a,{base64:!1,checkCRC32:!0}),d=c.files[b]._data}catch(e){c=new JSZip,c.load(a,{base64:!1}),d=c.file(b).asText()}return d},dm_tools_NameIdList.forceId=!1,dm_tools_NameIdList.startedTime=(new Date).getTime(),dm_tools_NameIdList.lastDateNow,dm_tools_NameIdList.counter4sameDates,dm_tools_NameIdList.isPerformance,function(){dm_tools_NameIdList.isPerformance=this.performance&&performance.now?!0:!1}(),function(){try{Object.defineProperty(Object.prototype,"__dm_uniqueId",{writable:!0,enumerable:!1}),Object.defineProperty(Object.prototype,"dm_uniqueId",{get:function(){if(void 0==this.__dm_uniqueId){var a=(new Date).getTime();dm_tools_NameIdList.lastDateNow!=a&&(dm_tools_NameIdList.lastDateNow=a,dm_tools_NameIdList.counter4sameDates=0),this.__dm_uniqueId=(""+a+dm_tools_NameIdList.counter4sameDates++).replace(".","")}return this.__dm_uniqueId}})}catch(a){}}(),dm_Tools.fakeFranceLabs=!0,dm_Tools.FranceLabsIntegration=!1,dm_Tools.now=(new Date).getTime(),dm_Tools.timers={},dm_Tools_dm_config_name="dm_config",dm_Tools_constantDmConfigTreeRootName="_"+dm_Tools_dm_config_name,dm_Tools_connected="connected",dm_Tools_aggregatedConnected="aggregatedConnected",dm_Tools_defaultTxtFontSize=12,dm_Tools.delayTimeoutId,dm_Tools.delay=function(a,b){clearTimeout(dm_Tools.delayTimeoutId),dm_Tools.delayTimeoutId=setTimeout(a,b||300)},dm_Tools.getDelay=function(a){var b=(new Date).getTime(),c=b-dm_Tools.now;return a?(dm_Tools.timers[a]&&(c=b-dm_Tools.timers[a]),dm_Tools.timers[a]=b):dm_Tools.now=b,c},dm_Tools.isInAvoidProps=function(a,b){var c=!1;return b&&("string"==typeof b&&a==b?c=!0:b.indexOf(a)>=0&&(c=!0)),c},dm_Tools.setUniqueID=function(a){if(a){for(var a,b,c,d,e={},f={},g=[a],h=0,i=!1,j=function(a){a&&"object"==typeof a&&!e[a.dm_uniqueId]&&(e[a.dm_uniqueId]=a,g.push(a))};g.length>0;){a=g.pop(),i=!1,a.__dm_uniqueId||(i=!0);var k=e[a.dm_uniqueId];if(k&&(i?(d={},a.__dm_uniqueId=d.dm_uniqueId):f[k.dm_uniqueId]&&(d={},k.__dm_uniqueId=d.dm_uniqueId)),i&&(f[a.dm_uniqueId]=a),h=Math.max(h,a.dm_uniqueId),dm_Tools.isArray(a))for(b=a.length-1;b>=0;b--)j(a[b]);else for(c in a)j(a[c])}return h}},dm_Tools.deepCopyDmNode=function(a,b){var c=["parent","aggregatedConnectedTo","aggregatedConnectedFrom"];return b&&("string"==typeof b?c.push(b):dm_Tools.isArray(b)&&c.concat(b)),dm_Tools.clone(a,c)},dm_Tools.deepCopy=function(a,b){dm_Tools.clone(a,b)},dm_Tools.deepCopy_deprecated=function(a,b,c,d,e,f,g,h,i){var j=!h,k=a;if(j){h=a;dm_Tools.setUniqueID(h)}if(g===!0)g=dm_Tools.getDepth(a);else if((0===g||g>0)&&a!=h&&a.parent&&dm_Tools.getDepth(a)<=g)return;if(a&&"object"==typeof a){var l;if(d&&(l=d[a.dm_uniqueId]),d&&l){var m=e[a.dm_uniqueId];c?(k="$ref_"+m.dm_uniqueId,f||(f=[]),f.push(k)):k=l}else{var n;d||(d={}),d[a.dm_uniqueId]=a;var o,p=dm_Tools.isArray(a);if(p?(o=a.length,k=new Array(o)):k={},e||(e={}),e[a.dm_uniqueId]=k,p)for(var q=0;o>q;q++)n=a[q],n&&"object"==typeof n?k[q]=dm_Tools.deepCopy(n,b,c,d,e,f,g,h):k[q]=n;else{a.prototype&&(k.prototype=a.prototype);for(var r in a)if("__dm_uniqueId"!=r&&"dm_uniqueId"!=r){var s=!0;dm_Tools.isInAvoidProps(r,b)&&(s=!1),i&&dm_Tools.isInAvoidProps(r,i)&&(s=!1),n=a[r],s&&(n&&"object"==typeof n?k[r]=dm_Tools.deepCopy(n,b,c,d,e,f,g,h):k[r]=n)}}}}return k},dm_Tools.cloneAndFixCircularRefs_deprecated=function(a,b,c){console.log("clone and fix circular refs  : start "+dm_Tools.getDelay());var d=[],e=dm_Tools.cloneObj(a,b,!0);return e&&d.length>0&&(e.$circularRefs=!0),console.log("clone and fix circular refs  : end "+dm_Tools.getDelay()),e},dm_Tools.stringify_deprecated_old=function(a,b,c){var d;try{d=JSON.stringify(a)}catch(e){var f=dm_Tools.cloneAndFixCircularRefs(a,b,c);d=JSON.stringify(f)}return d},dm_Tools.stringify_deprecated=function(a,b,c,d){var e;try{e=JSON.stringify(a)}catch(f){var g=dm_Tools.clone(a,b,null,null,c,d);e=JSON.stringify(g)}return e},dm_Tools.stringify=function(a,b){if(void 0==a)return"";var c;return b&&(c=function(a,c){return"string"==typeof b?a!==b?c:void 0:!a||b.indexOf(a)<0?c:void 0}),JSON.stringify(a,c)},dm_Tools.stringifyNodeWithFilterOnRootObjOnly=function(a,b,c){var d="{",b=b||[];"string"==typeof b&&(b=[b]);var e=!0;for(var f in a)b.indexOf(f)<0&&(d+=(e?"":", ")+'"'+f+'": '+dm_Tools.stringify(a[f],c),e=!1);return d+="}"},dm_Tools.getMaxUniqueId=function(a){for(var b,c,d,e=[a],f=0;e.length>0;)if(b=e.pop(),b&&"object"==typeof b){d=b.__dm_uniqueId,d&&(f=Math.max(f,d));for(c in b)e.push(b[c])}return f},dm_Tools.removeProps=function(a,b){if(a&&"object"==typeof a){var c,d,e,f,g=[a],h={},i=[a];for(h[a.dm_uniqueId]=a;g.length>0;){c=g.pop(),h[c.dm_uniqueId]=c;for(var d in c)e=c[d],e&&"object"==typeof e&&!h[e.dm_uniqueId]&&(g.push(e),i.push(e))}for(;i.length>0;)if(c=i.pop(),"string"==typeof b)delete c[b];else for(f=b.length-1;f>=0;f--)delete c[b[f]]}},dm_Tools.allObj=function(a,b,c,d,e){dm_tools_NameIdList.idCounter=dm_Tools.getMaxUniqueId(a)+1,dm_Tools.setUniqueID(a);var b=b||{},c=c||[],d=d||[],e=e||[],f=!1,g=[];g.push(a);for(var h=function(h){f="string"==typeof i&&0==i.indexOf("$ref_"),i&&(f||"object"==typeof i&&!b[i.__dm_uniqueId])&&(f&&(c.push(i),d.push(a),e.push(h)),g.push(i))};g.length>0;)if(a=g.pop(),a&&"object"==typeof a){var i;if(dm_Tools.isArray(a))for(var j=a.length,k=0;j>k;k++)i=a[k],h(k);else{b[a.__dm_uniqueId]=a;for(var l in a)i=a[l],h(l)}}return{list:b,refs:{refsList:c,parents:d,keys:e}}},dm_Tools.replaceRef=function(a,b){var c;if(a&&"string"==typeof a&&0==a.indexOf("$ref_")){var d=a.substring("$ref_".length);c=b[d]}return c},dm_Tools.rebuildRefs=function(a){console.log("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ WARNING : START rebuild refs ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"),console.log("rebuildRefs start "+dm_Tools.getDelay());for(var b,c,d,e,f=dm_Tools.allObj(a),g=f.list,h=f.refs.refsList,i=f.refs.parents,j=f.refs.keys,k=h.length-1;k>=0;k--)b=h[k],e=dm_Tools.replaceRef(b,g),e&&(c=i[k],d=j[k],c[d]=e);return delete a.$circularRefs,dm_Tools.removeProps(a,"__dm_uniqueId"),console.log("rebuildRefs end "+dm_Tools.getDelay()),console.log("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ WARNING : END rebuild refs ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"),a},dm_Tools.changeNewLinesFromJSONStrings=function(a,b){for(var c=0,d=c,e=-1,f="";c>=0;)d=c,c=a.indexOf('"',c+1),c>=0?"\\"!=a[c-1]&&(e>=0?(f+='"',f+=b?a.substring(e+1,c).replace(/\\n/g,"\n"):a.substring(e+1,c).replace(/\r\n/g,"\\n").replace(/\n/g,"\\n").replace(/\r/g,"\\n").replace(/\t/g," "),f+='"',c++,e=-1):(f+=a.substring(d,c),e=c)):f+=a.substring(d,a.length);return f},dm_Tools.parseStringified=function(a,b){var c=a;if("string"==typeof a){var a=a.replace(/\/\*[\s\S]+?\*\//g,"");try{c=JSON.parse(a)}catch(d){a=dm_Tools.changeNewLinesFromJSONStrings(a);try{c=JSON.parse(a)}catch(d){console.log("JSON parsing error : ",d),console.log(a)}}b!==!1&&(1==b||c.$circularRefs)}return c},dm_Tools.ARRAY_PROPS={length:"number",sort:"function",slice:"function",splice:"function"},dm_Tools.isArray=function(a){if(!a||"number"==typeof a||"string"==typeof a||"boolean"==typeof a)return!1;if(a instanceof Array)return!0;for(var b in dm_Tools.ARRAY_PROPS)if(!(b in a&&typeof a[b]==dm_Tools.ARRAY_PROPS[b]))return!1;return!0},dm_Tools.indent=function(a){var b="";for(i=0;a>i;i++)b+="  ";return b},dm_Tools.restoreParentsInTree=function(a,b){if(a){if(a.parent=b,a.children)for(var c,d=a.children.length,e=0;d>e;e++)c=a.children[e],dm_Tools.restoreParentsInTree(c,a);return a}},dm_Tools.getNodesFromRoot=function(a,b){return a?(b||(b=new dm_tools_NameIdList),dm_Tools.scanNodes(a,function(a){b.addObject(a)}),b):void 0},dm_Tools.isAdminConfigTreeNode=function(a){var b;return a&&a.name&&(""+a.name).lastIndexOf(dm_Tools_constantDmConfigTreeRootName)>=0&&(b=a),b},dm_Tools.node2string=function(a,b,c,d,e,f,g){var h,i,j,k="",l=!0,m=!0;if(b=b||0,!a)return k;if(g&&dm_Tools.isAdminConfigTreeNode(a))return k;if(e>=b&&(a.children||!f))if("number"==typeof a||"string"==typeof a)k+=dm_Tools.indent(b+d),k+='"'+a+'"';else{k+=dm_Tools.indent(b+d),k+="{",l=!0;for(var n in a){i="";var o=!1;if(c)for(h=0;!o&&h<c.length;h++)c[h]==n&&(o=!0);"parent"==n?a.parent&&a.parent.name&&(i='"parent": '+(a.parent?'"'+a.parent.name+(a.parent.id?"("+a.parent.id+")":"")+'"':null)):"children"==n||o||(j=dm_Tools.stringify(a[n]),j||(j="null"),i='"'+n+'": '+j),""!=i&&(l||(k+=","),k+="\n",k+=dm_Tools.indent(b+d),k+=i,l=!1)}if(a.children){for(l||(k+=","),k+="\n",k+=dm_Tools.indent(b+d),l=!1,k+='"children": [',m=!0,h=0;h<a.children.length;h++)m=!1,k+="\n",k+=dm_Tools.node2string(a.children[h],b+1,c,d,e,f),h<a.children.length-1&&(k+=",");m||(k+="\n"+dm_Tools.indent(b+d)),k+="]\n"}l||(a.children||(k+="\n"),k+=dm_Tools.indent(b+d)),k+="}"}return k},dm_Tools.nodes2string=function(a,b,c,d){var e="{\n";for(var f in a)e+=dm_Tools.indent(1)+f+":\n",e+=dm_Tools.node2string(a[f],1,b,1,c,d);return e+="}"},dm_Tools.getAbsoluteLevel=function(a,b){if(a.parent){var c=1;return a.dm_isReducedNode&&b&&(c=0),dm_Tools.getAbsoluteLevel(a.parent,b)+c}return 0},dm_Tools.getLevelInternal=function(a,b){if(!a.parent||a[dm_Tools_dm_config_name]&&!b)return 0;var c=0;return a.dm_isReducedNode||(c=1),dm_Tools.getLevelInternal(a.parent)+c},dm_Tools.getLevel=function(a){return dm_Tools.getLevelInternal(a)},dm_Tools.bestEffortLevel=function(a){if(a){var b=a.level,c=dm_Tools.getLevel(a);return b||((null==b||c>b)&&!a[dm_Tools_dm_config_name]&&(b=c),null==b&&a.style&&(b=a.style.level),null!=b||a.parent||(b=0)),a.level=b||0,b}},dm_Tools.links2string=function(a,b){for(var c,d="[\n",e=a.length,f=0;e>f;f++){c=a[f],d+=dm_Tools.indent(1);var g=!0,h=!1;for(var i in c)g||(d+=", "),"source"==i||"target"==i?(d+=i+":\n"+(b?c[i].name+"\n":dm_Tools.node2string(c[i],2)),d+=dm_Tools.indent(1),g=!0,h=!0):(d+=i+": "+dm_Tools.stringify(c[i]),g=!1);h&&f<a.length-1&&(d+="\n",h=!1),d+="\n"}return d+="]"},dm_Tools.removeSpaces=function(a){var b;return a&&(b=a.replace(/ /g,""),b=a.replace(/\./g,"_")),b},dm_Tools.compare=function(a,b){var c=!1;return a&&b&&(a=dm_Tools.removeSpaces(a.toLowerCase()),b=dm_Tools.removeSpaces(b.toLowerCase()),c=a==b),c},dm_Tools.saveFile=function(a,b,c,d,e){if(e===!1){for(var f=new Uint8Array(a.length),g=0;g<a.length;g++)f[g]=255&a.charCodeAt(g);a=f}try{saveAs(new Blob([a],{type:c+(d?";charset="+d:""),charset:d}),b),console.log("finished normal saveAs")}catch(h){try{var i=new BlobBuilder;i.append(a),saveAs(i.getBlob("data:"+c+(d?";charset="+d:"")),b),console.log("finished saveAs using blobs")}catch(h){window.open("data:"+c+(d?";charset="+d:"")+encodeURIComponent(a)),console.log("finished saveAs using window.open(encodeURIComponent(filecontent))")}}},dm_Tools.color2rgb=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null},dm_Tools.rgbParse=function(a){var b=/^rgb\(?[ ]*([0-9]*),[ ]*([0-9]*),[ ]*([0-9]*)\)/i.exec(a);return b?{r:parseInt(b[1]),g:parseInt(b[2]),b:parseInt(b[3])}:null},dm_Tools.rgb2hex=function(a){var b=function(a){for(var b=a.toString(16);b.length<2;)b="0"+b;return b};return"#"+b(a.r)+b(a.g)+b(a.b)};var d3_scale_category20_range=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],d3_scale_category20b_range=["#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6"],myPalette=["#8C2C0E","#DDA289","#00668E","#6DB8DB","#3A8F8A","#AFE5D5","#842B5B","#EA77AF","#676462","#CAC7C4","#F28A35","#F3D4B5","#1890C2","#9AD3E5","#885242","#F3BEAE","#69643C","#B7B691","#534741","#B7B0A7"];dm_Tools.colors=d3_scale_category20_range;for(var i=0;20>=i;i++)dm_Tools.colors=dm_Tools.colors.concat(myPalette);dm_Tools.colorsRGB=[];for(var i=0;i<dm_Tools.colors.length;i++)dm_Tools.colorsRGB.push(dm_Tools.color2rgb(dm_Tools.colors[i]));dm_Tools.getColor=function(a){var b=dm_Tools.colors[a%dm_Tools.colors.length];return b||console.log(),b},dm_Tools.modifiedCategory20b=function(){var a=d3.scale.category20b().range(),b=d3.scale.category20c().range(),c=[a[0],a[1],a[2],a[3],a[12],a[13],a[14],a[15],b[16],b[17],b[18],a[16],a[17],a[18],a[19]];return c=d3.scale.ordinal().range(c)},dm_Tools.colors2=dm_Tools.colors,dm_Tools.colorsRGB2=dm_Tools.colorsRGB,dm_Tools.convertNumber=function(a,b,c){var d,e,f=a;return"number"==typeof a&&(b||(b=2,a>1e3?b=1:1e-4>a?b=8:.01>a?b=6:1>a&&(b=4)),f=""+f,c&&(a>=1e6&&(e="M",a/=1e6),a>=1e3&&(e="k",a/=1e3)),f=a,a!=Math.round(a)&&(f=""+a.toFixed(b),d=f.lastIndexOf("."),d>=0&&0==parseInt(f.substr(d+1,b))&&(f=f.substring(0,d))),f=(""+f).replace(/\,/g," "),f=(""+f).replace(/\./g,","),a>=1e3&&(f=(""+f).replace(/\B(?=(\d{3})+(?!\d))/g," "),c&&e&&(f+=" "+e))),f},dm_Tools.sortArray=function(a,b,c){if(dm_Tools.isArray(a)){var b=b||[];dm_Tools.isArray(b)||(b=[b]),b.push("array index"),b.push("order"),b.push("name");var d=function(a,b){if(a){var c;return c="name"==b?a[b]:a.rawNode?a.rawNode[b]:a[b]}},e=function(a,f,g){if(g>b.length-1)return 0;var h=b;dm_Tools.isArray(b)&&(h=b[g]);var i=0,j=d(a,h),k=d(f,h),l=-1,m=1;return"name"==h||1!=c&&"true"!=c||(l=1,m=-1),i=j==k?e(a,f,g+1):k>j?l:m};a.sort(function(a,b){return e(a,b,0)})}},dm_Tools.sortTree=function(a,b){var b=b||dm_Tools.getConfig(a);if(a){var c,d,e,f,g,h=[];d=dm_Tools.bestEffortLevel(a);for(var c=0;10>c;c++)g="sort"+(c>0?c:""),e=b.styles[d+1]&&null!=b.styles[d+1][g]?b.styles[d+1][g]:b[g],e&&("string"==typeof e?h.push(e):dm_Tools.isArray(e)&&(h=h.concat(e)));if(h&&(f=b.styles[d+1]&&null!=b.styles[d+1].sortDescendant?b.styles[d+1].sortDescendant:b.sortDescendant,a.children&&a.children.length>0)){for(c=0;c<a.children.length;c++)dm_Tools.sortTree(a.children[c],b);dm_Tools.sortArray(a.children,h,f)}}},dm_Tools.rtfFontSize=function(a){var b=[8,10,12,14,18,24],c=10;return a&&a>=1&&(c=a-1<b.length?b[a-1]:b[b.length-1]),c=2*c},dm_Tools.getIndexOfFirstPipe=function(a,b){var c=-1,d=a.indexOf("|",b),e=a.indexOf("%7C",b);return c=0>d&&e>=0?e:0>e&&d>=0?d:Math.min(d,e)},dm_Tools.getFileExtension=function(a){var b,c=a.lastIndexOf("."),d=dm_Tools.getIndexOfFirstPipe(a,c);return c>=0&&(b=d>=0?a.substring(c+1,d):a.substring(c+1)),b&&(b=(""+b).toLowerCase()),b},dm_Tools.getDatamapNameAndPathFromFullPath=function(a){var b={name:null,path:null,url:null};if(0==a.indexOf("http:"))b.url=a,b.name=a;else{var c=dm_Tools.getIndexOfFirstPipe(a);0>c?b.name=a:(b.name=a.substring(0,c),a.length>c+1&&(b.path=a.substring(c+1)))}return b},dm_Tools.getGotoTarget=function(a){return a&&a.rawNode&&a.rawNode.dm_goto&&""!=a.rawNode.dm_goto?dm_Tools.getDatamapNameAndPathFromFullPath(a.rawNode.dm_goto):void 0},dm_Tools.getChildAt=function(a,b){var c;return a&&a.children&&b<a.children.length&&(c=a.children[b]),c},dm_Tools.getChildNameAt=function(a,b){var c,d=dm_Tools.getChildAt(a,b);return d&&(c=d.name),c},dm_Tools.getChildIndexAndObj=function(a,b){return dm_ServerTools.getChildIndexAndObj(a,b)},dm_Tools.getBrother=function(a,b){var c,d,e=a.parent;a.rawNode&&(d=a.rawNode["array index"]),null===d&&e&&e.children&&(d=e.children.indexOf(a));var f=d+b,g=e.children.length;if(f>=0&&g>f){for(var h,i=0;!c&&g>i;i++)h=e.children[i],h&&h.rawNode&&h.rawNode["array index"]===f&&(c=h);c||(c=e.children[d+b])}return c},dm_Tools.getPrevBrother=function(a){return dm_Tools.getBrother(a,-1)},dm_Tools.getNextBrother=function(a){return dm_Tools.getBrother(a,1)},dm_Tools.getChild=function(a,b,c){return dm_ServerTools.getChild(a,b,c)},dm_Tools.getDepth=function(a){for(var b=0,c=a;c.parent;)c.dm_isReducedNode||b++,c=c.parent;return b},dm_Tools.getLocalDepth=function(a,b){for(var c=0,b=b||dm_Tools.getParentNode4Config(a),d=a;d&&d!=b;)d.dm_isReducedNode||c++,d=d.parent;return c},dm_Tools.getDepthUntilNode=function(a,b){for(var c=0,d=a;d&&d!=b;)c++,d=d.parent;return c},dm_Tools.getNumberOfNodes=function(a,b){var c=0;return dm_Tools.scanNodes(a,function(d){var e;if(b){var f=dm_Tools.getDepthUntilNode(d,a);b>=f&&c++,f>=b&&(e={skipChildrenOnly:!0})}else c++;return e}),c},dm_Tools.getChildren=function(a,b,c,d,e){var f,g;if(a&&(g=e!==!1?dm_Tools.getNonReducedChildren(a):a.children)){var h,i;for(h=0;h<g.length;h++)if(i=g[h],i&&dm_Tools.equalsOrRexgexpMatch(b,i.name,d)&&(f||(f=[]),f.push(i)),c){var j=dm_Tools.getChildren(i,b,c,d,e);j&&(f=f?j.concat(f):j)}}return f},dm_Tools.getChildIndex=function(a,b,c){var d=dm_Tools.getChildIndexAndObj(a,b,c);return d&&!d.isDmChild&&(d=d.index),d},dm_Tools.getParent=function(a,b){var c;return a&&(c=a.name==b?a:dm_Tools.getParent(a.parent,b)),c},dm_Tools.getNodePathNames=function(a){var b;return a.parent?(b=dm_Tools.getNodePathNames(a.parent),b.push(a.name)):b=[a.name],b},dm_Tools.getNodePathNamesRespectingLevels=function(a){var b;if(a.parent){b=dm_Tools.getNodePathNames(a.parent);var c=a.level;a.style&&a.style.level&&(c=a.level);for(var d=b.length;c>d;d++)b.push("");b.push(a.name)}else b=[a.name];return b},dm_Tools.getNodePath=function(a,b,c,d,e,f,g){var h,e=e?e:0,b=null==b?"|":b;if(a)if(a.dm_isReducedNode||(d&&(h=a.rawNode[d]),h||(h=a.name)),a.parent&&(0==e||a.level&&a.level>=e)){if(!c||!a.dm_config){var i=dm_Tools.getNodePath(a.parent,b,c,d,e,!0,g);h=i?h?i+b+h:i:h}}else!f||g&&!a.parent||(h=null);return h},dm_Tools.getNodeUrl=function(a,b,c,d){var c=c;if(!c){for(var e=a;e&&e.parent;)e=e.parent;var f;e&&(f=e.dm_DatamapName);var g=dm_Datamap.currentDatamap.name;c=f||g}return("noDatamapNameInURL"==c?"":c+"|")+dm_Tools.getNodePath(a,null,d,null,null,null,b)},dm_Tools.getNodeFromUniqueId=function(a,b){var b=b||dm_Datamap.currentDatamap,c=a;return"string"==typeof c?0==c.indexOf("$ref_")&&(c=c.substring("$ref_".length)):"object"==typeof c&&(c=c.dm_uniqueId),b.nodes.listByUniqueId[c]},dm_Tools.getNextNode=function(a,b){var c,d;if(!b&&a.children&&a.children.length>0)d=dm_Tools.getNonReducedChildren(a),c=d[0];else{var e=a.parent;if(e){d=dm_Tools.getNonReducedChildren(e);var f=d.indexOf(a);c=f>=0&&f<e.children.length-1?d[f+1]:dm_Tools.getNextNode(e,!0)}}return c},dm_Tools.getNodeFromPath=function(a,b,c,d,e,f){var f=f||dm_Tools.getParentNode4Config(b),g=!1;c&&(g=!0);var h,i,j,k,c=c||dm_Datamap.maps[f.dm_DatamapName]||dm_Datamap.currentDatamap,l=!1,m={lastFoundNode:b,dm:c,nextPath:a};j=dm_Tools.getIndexOfFirstPipe(a),j>0?(h=a.substring(0,j),a.length>j+1&&(i=a.substring(j+1))):""!=a&&(h=a);
var n,o;if("**"==h&&i&&(j=dm_Tools.getIndexOfFirstPipe(i),j>0?(o=i.substring(0,j),i.length>j+1&&(n=i.substring(j+1))):""!=i&&(o=i)),h){if("$dm_all"==h){i="$dm_all";var p=b||c.root||f;if(b){if(k=dm_Tools.getNonReducedChildren(b)){m.nodes=[],m.nodes.push(p);for(var q=0;q<k.length;q++)m.nodes.push(k[q])}}else k=[p],m.nodes=k;m.node=p}else if("$dm_leaf"==h)b&&dm_Tools.isLeaf(b)?(m.node=b,m.nodes=[],m.nodes.push(b)):(i=h,k=dm_Tools.getNonReducedChildren(b));else if(b&&b!=c.root&&b!=f||h!=c.root.name&&"$dm_root"!=h)if(b||h!=c.name){if("**"==h)l=!0,b?(o&&(k=dm_Tools.getChildren(b,o,d)),k||(k=dm_Tools.getNonReducedChildren(b),k&&(i="**"+(i?"|"+i:""))),k||"**"!=e||(k=[b])):(o&&(k=c.nodes.getObjects(o)),k||(k=c.nodes.getAll(),k&&(i="**"+(i?"|"+i:""))));else if(b)k="*"==h?dm_Tools.getNonReducedChildren(b):dm_Tools.getChildren(b,h,null,d);else if(k="*"==h?c.nodes.getAll():c.nodes.getObjects(h),!k&&f.parent){var r=dm_Tools.getParentNode4Config(f.parent);if(r)return dm_Tools.getNodeFromPath(a,b,null,d,e,r)}}else k=[b];else k=g?[b||c.root||f]:[b||f||c.root];if(k&&k.length>0){var s=function(a){a.node&&(m.node||(m.node=a.node,m.lastFoundNode=a.lastFoundNode,m.dm=a.dm)),a.lastFoundNode&&(!m.lastFoundNode||a.lastFoundNode.level>m.lastFoundNode.level)&&(m.lastFoundNode=a.lastFoundNode),a.nodes&&(m.nodes?m.nodes=m.nodes.concat(a.nodes):m.nodes=a.nodes)};if(i)for(var t,q=0;q<k.length;q++)t=dm_Tools.getNodeFromPath(i,k[q],c,d,h,f),s(t);i?l&&s({node:k[0],nodes:k}):(m.node=k[0],m.nodes=k)}}return m},dm_Tools.getNodeFromUrl=function(a){var b,c,d=a;if(c=d.indexOf("|"),c>0){var e=dm_Datamap.maps[a.substring(0,c)];e&&(d=d.substring(c+1),b=dm_Tools.getNodeFromPath(d,null,e).node)}return{datamap:e,node:b}},dm_Tools.escapeHtmlEntitiesTable={34:"quot",38:"amp",39:"apos",60:"lt",62:"gt",160:"nbsp",161:"iexcl",162:"cent",163:"pound",164:"curren",165:"yen",166:"brvbar",167:"sect",168:"uml",169:"copy",170:"ordf",171:"laquo",172:"not",173:"shy",174:"reg",175:"macr",176:"deg",177:"plusmn",178:"sup2",179:"sup3",180:"acute",181:"micro",182:"para",183:"middot",184:"cedil",185:"sup1",186:"ordm",187:"raquo",188:"frac14",189:"frac12",190:"frac34",191:"iquest",192:"Agrave",193:"Aacute",194:"Acirc",195:"Atilde",196:"Auml",197:"Aring",198:"AElig",199:"Ccedil",200:"Egrave",201:"Eacute",202:"Ecirc",203:"Euml",204:"Igrave",205:"Iacute",206:"Icirc",207:"Iuml",208:"ETH",209:"Ntilde",210:"Ograve",211:"Oacute",212:"Ocirc",213:"Otilde",214:"Ouml",215:"times",216:"Oslash",217:"Ugrave",218:"Uacute",219:"Ucirc",220:"Uuml",221:"Yacute",222:"THORN",223:"szlig",224:"agrave",225:"aacute",226:"acirc",227:"atilde",228:"auml",229:"aring",230:"aelig",231:"ccedil",232:"egrave",233:"eacute",234:"ecirc",235:"euml",236:"igrave",237:"iacute",238:"icirc",239:"iuml",240:"eth",241:"ntilde",242:"ograve",243:"oacute",244:"ocirc",245:"otilde",246:"ouml",247:"divide",248:"oslash",249:"ugrave",250:"uacute",251:"ucirc",252:"uuml",253:"yacute",254:"thorn",255:"yuml",402:"fnof",913:"Alpha",914:"Beta",915:"Gamma",916:"Delta",917:"Epsilon",918:"Zeta",919:"Eta",920:"Theta",921:"Iota",922:"Kappa",923:"Lambda",924:"Mu",925:"Nu",926:"Xi",927:"Omicron",928:"Pi",929:"Rho",931:"Sigma",932:"Tau",933:"Upsilon",934:"Phi",935:"Chi",936:"Psi",937:"Omega",945:"alpha",946:"beta",947:"gamma",948:"delta",949:"epsilon",950:"zeta",951:"eta",952:"theta",953:"iota",954:"kappa",955:"lambda",956:"mu",957:"nu",958:"xi",959:"omicron",960:"pi",961:"rho",962:"sigmaf",963:"sigma",964:"tau",965:"upsilon",966:"phi",967:"chi",968:"psi",969:"omega",977:"thetasym",978:"upsih",982:"piv",8226:"bull",8230:"hellip",8242:"prime",8243:"Prime",8254:"oline",8260:"frasl",8472:"weierp",8465:"image",8476:"real",8482:"trade",8501:"alefsym",8592:"larr",8593:"uarr",8594:"rarr",8595:"darr",8596:"harr",8629:"crarr",8656:"lArr",8657:"uArr",8658:"rArr",8659:"dArr",8660:"hArr",8704:"forall",8706:"part",8707:"exist",8709:"empty",8711:"nabla",8712:"isin",8713:"notin",8715:"ni",8719:"prod",8721:"sum",8722:"minus",8727:"lowast",8730:"radic",8733:"prop",8734:"infin",8736:"ang",8743:"and",8744:"or",8745:"cap",8746:"cup",8747:"int",8756:"there4",8764:"sim",8773:"cong",8776:"asymp",8800:"ne",8801:"equiv",8804:"le",8805:"ge",8834:"sub",8835:"sup",8836:"nsub",8838:"sube",8839:"supe",8853:"oplus",8855:"otimes",8869:"perp",8901:"sdot",8968:"lceil",8969:"rceil",8970:"lfloor",8971:"rfloor",9001:"lang",9002:"rang",9674:"loz",9824:"spades",9827:"clubs",9829:"hearts",9830:"diams",338:"OElig",339:"oelig",352:"Scaron",353:"scaron",376:"Yuml",710:"circ",732:"tilde",8194:"ensp",8195:"emsp",8201:"thinsp",8204:"zwnj",8205:"zwj",8206:"lrm",8207:"rlm",8211:"ndash",8212:"mdash",8216:"lsquo",8217:"rsquo",8218:"sbquo",8220:"ldquo",8221:"rdquo",8222:"bdquo",8224:"dagger",8225:"Dagger",8240:"permil",8249:"lsaquo",8250:"rsaquo",8364:"euro"},dm_Tools.convertAccent2html=function(a){return a.replace(/[\u00A0-\u2666<>\&]/g,function(a){return"&"+(dm_Tools.escapeHtmlEntitiesTable[a.charCodeAt(0)]||"#"+a.charCodeAt(0))+";"})},dm_Tools.hex_to_ascii=function(a){for(var b=a.toString(),c="",d=0;d<b.length;d+=2)c+=String.fromCharCode(parseInt(b.substr(d,2),16));return c},dm_Tools.atob=function(a){var b,c=function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b.split("");if(/(=[^=]+|={3,})$/.test(a))throw new Error("String contains an invalid character");a=a.replace(/=/g,"");var c=3&a.length;if(1===c)throw new Error("String contains an invalid character");for(var d=0,e=0,f=a.length/4,g=[];f>d;++d){var h=b.indexOf(a[e++]||"A"),i=b.indexOf(a[e++]||"A"),j=b.indexOf(a[e++]||"A"),k=b.indexOf(a[e++]||"A");if(0>(h|i|j|k))throw new Error("String contains an invalid character");g[g.length]=255&(h<<2|i>>4),g[g.length]=255&(i<<4|j>>2),g[g.length]=255&(j<<6|k)}return String.fromCharCode.apply(null,g).substr(0,g.length+c-4)};return window?window.atob?b=window.atob(a):(window.atob=c,b=c(a)):b=c(a),b},dm_Tools.btoa=function(a){var b,c=function(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=b.split(""),d=0,e=0,f=a.length/3,g=[];f>d;++d){var h=a.charCodeAt(e++),i=a.charCodeAt(e++),j=a.charCodeAt(e++);if((h|i|j)>255)throw new Error("String contains an invalid character");g[g.length]=c[h>>2]+c[h<<4&63|i>>4]+(isNaN(i)?"=":c[i<<2&63|j>>6])+(isNaN(i+j)?"=":c[63&j])}return g.join("")};return window?window.btoa?b=window.btoa(a):(window.btoa=c,b=c(a)):b=c(a),b},dm_Tools.hexToBase64=function(a){return btoa(String.fromCharCode.apply(null,a.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))},dm_Tools.base64ToHex=function(a){for(var b=0,c=dm_Tools.atob(a.replace(/[ \r\n]+$/,"")),d=[];b<c.length;++b){var e=c.charCodeAt(b).toString(16);1===e.length&&(e="0"+e),d[d.length]=e}return d.join(" ")},dm_Tools.searchFirstDomNodeFromPath=function(a,b,c){if(a&&b){var d;if(c)for(var e=a.firstChild;e&&!d;e=e.nextSibling)d=dm_Tools.searchFirstDomNodeFromPath(e,b);else{var f=b.indexOf("/"),g=b;if(f>=0?(g=b.substring(0,f),b=b.substring(f+1)):b=null,g&&1==a.nodeType&&(a.nodeName.toUpperCase()==g.toUpperCase()&&(d=a),d&&b&&a.firstChild)){d=null;for(var e=a.firstChild;e&&!d;e=e.nextSibling)d=dm_Tools.searchFirstDomNodeFromPath(e,b)}}return d}},dm_Tools.getDomNodeAttribute=function(a,b){var c,d;if(a&&b){for(var e=0;!c&&e<a.attributes.length;e++)d=a.attributes[e],d.name==b&&(c=d);return c}},dm_Tools.setDomNodeAttribute=function(a,b,c){if(a&&b){var d=dm_Tools.getDomNodeAttribute(a,b);d?d.value=c:a.setAttribute(b,c)}},dm_Tools.finishXmlTags=function(a){for(var b,c,d,e,f,g=a,h=g.indexOf("/>");h>0;)b=g.substring(0,h),c=g.substring(h+2),d=b.lastIndexOf("<"),e=b.substring(d+1),f=e.indexOf(" "),0>f&&(f=e.length),e=e.substring(0,f),g=b+"></"+e+">"+c,h=g.indexOf("/>");return g},dm_Tools.getMaxDepth=function(a,b){var b=b||0,c=b;if(a.children)for(var d=0;d<a.children.length;d++){var e=dm_Tools.getMaxDepth(a.children[d],b+1);e>c&&(c=e)}return c},dm_Tools.convertValue=function(a){return a||(a=""),a=dm_Tools.convertNumber(a)},dm_Tools.prop2obj=function(a,b){if(!b)return{};if("__dm_uniqueId"==b)return{};var b=b,c=a.rawNode||a;b.indexOf(".")>0&&(b=b.substring(0,b.indexOf(".")));var d=c[b],e=c[b+".dm_props"];e||(e={});var f=!1;for(var g in c)g!=b+".dm_props"&&0==g.indexOf(b+".")&&g.length>b.length+1&&(f=!0,e[g.substring(b.length+1)]=e[g.substring(b.length+1)]||c[g],delete c[g]);return f&&(c[b+".dm_props"]=e),"object"==typeof e&&(e.name=b,"image"==e.type&&(c[b+".dm_props"]||(c[b+".dm_props"]=e),e.imageName=d)),e},dm_Tools.scanAllProps=function(a,b){if(a){var c=a.rawNode||a;for(var d in c)b&&b(c,d);if(a[dm_Tools_dm_config_name]&&dm_Tools.scanAllProps(a[dm_Tools_dm_config_name],b),a.children)for(var e,f=0;f<a.children.length;f++)e=a.children[f],dm_Tools.scanAllProps(e,b);a.styles&&a.styles.forEach(function(a){dm_Tools.scanAllProps(a,b)}),a.aggregate&&a.aggregate.forEach(function(a){dm_Tools.scanAllProps(a,b)}),a.displayProps&&a.displayProps.forEach(function(a){dm_Tools.scanAllProps(a,b)})}},dm_Tools.prop2objAll=function(a){dm_Tools.scanAllProps(a,dm_Tools.prop2obj)},dm_Tools.setSpecificsFromConfig=function(a,b,c,d){var e=function(a,b,c){if(b.indexOf(".dm_props")<0)"__dm_uniqueId"!=b&&"dm_uniqueId"!=b&&(c[b+".dm_props"]&&c[b+".dm_props"].dontReplaceIfNotNull?null==a.rawNode[b]&&(a.rawNode[b]=dm_Tools.clone(c[b])):a.rawNode[b]=dm_Tools.clone(c[b]));else{a.rawNode[b]||(a.rawNode[b]={});for(var d in c[b])"__dm_uniqueId"!=d&&"dm_uniqueId"!=d&&"dontReplaceIfNotNull"!=d&&(c[b].dontReplaceIfNotNull?null==a.rawNode[b][d]?a.rawNode[b][d]=dm_Tools.clone(c[b][d]):"undefined"==a.rawNode[b][d]&&delete a.rawNode[b][d]:a.rawNode[b][d]=dm_Tools.clone(c[b][d]))}},f=function(a,b){if(a.rawNode||(a.rawNode={}),b.rawNode)for(var c in b.rawNode)e(a,c,b.rawNode);else for(var c in b)"name"!=c&&e(a,c,b)};b||(b=dm_Tools.getConfig(a));var g=b.specifics;if(g)for(var h=null,i=null,j=null,k=null,l=dm_Tools.getParentNode4Config(c),m=0;m<g.length;m++)if(h=g[m],i=h.name,j=dm_Tools.getNodeFromPath(i,a,d,!0,null,l),j&&j.nodes)if(c){var n=j.nodes.indexOf(c);n>=0&&f(c,h)}else for(var o=0;o<j.nodes.length;o++)k=j.nodes[o],f(k,h)},dm_Tools.sortAttributesFromOrder=function(a,b,c){var d=0;return 0>a&&(a=c.length+100-a),0>b&&(b=c.length+100-b),void 0!=a&&void 0==b&&(d=a<c.length?-1:1),void 0!=b&&void 0==a&&(d=b<c.length?1:-1),void 0!=a&&void 0!=b&&(d=b>a?-1:1),d},dm_Tools.onDisplayableRawNodeProps=function(a,b,c,d,e,f,g,h){var g=g||dm_Tools.getConfig(a),i=g.displayProps;g.adminProps;c||(c="");var j,k=[],l=function(a){if(!a.label||0!=a.label.indexOf("dm_hoTable_level_")){for(var b,c=null,d=0;d<k.length&&!c;d++)b=k[d],b.propObj.name==a.propObj.name&&(c=b.propObj);c?b.propObj=dm_Tools.inherit(a.propObj,c):k.push(a)}};if(a.rawNode){var m=function(b,c,d){var e=!0;for(var g in a.rawNode)if(e=!0,b&&(e=!1,dm_Tools.isArray(b)?b.indexOf(g)>=0&&(e=!0):g==b&&(e=!0)),c&&(dm_Tools.isArray(c)?c.indexOf(g)>=0&&(e=!1):g==c&&(e=!1)),e){g.indexOf(".")>0&&(g=g.substring(0,g.indexOf(".")));var h=d||dm_Tools.prop2obj(a,g),i=("true"==h.visible||1==h.visible||"true"==h.edit||1==h.edit)&&(f||1!=h.dontExport)&&(void 0!==a.rawNode[g]||h.displayEvenIfUndefined);1==i&&l({propObj:h,label:g,value:dm_Tools.convertValue(a.rawNode[g]),order:k.length+1})}},n=null;a.level<0&&(a.level=g.styles.length-1),i&&(n=i[a.level]),!n&&i&&a.level>i.length&&(n=i[i.length-1]);var o,p,q=!0;if(n&&n.children)for(var r=0;r<n.children.length&&q;r++)o=n.children[r],"icon"==o.name&&(o.visible===!1&&(q=!1),f||o.dontExport!==!0||(q=!1),p=dm_Tools.prop2obj(a,"icon"),p=dm_Tools.inherit(o,p));q&&m(["icon","image"],null,p);var s=g.styles[a.level];for(var t in s){var u=dm_Tools.prop2obj(s,t);u.visible&&!u.dontExport&&l({propObj:u,label:t,value:u[t],order:k.length+1})}if(n){if(1==n.visible||1==n.edit){var u;for(var v in a.rawNode)v.indexOf(".")<0&&(u=dm_Tools.prop2obj(a,v),n.edit&&null==u.edit&&(u.edit=n.edit),0!=u.visible&&"false"!=u.visible&&l({propObj:u,label:v,value:dm_Tools.convertValue(a.rawNode[v]),order:k.length+1}))}var w=null,x=n.children;if(x&&x.length>0&&(w=x),w)for(var y,z=w.length,r=0;z>r;r++)if(y=w[r]){var u=dm_Tools.prop2obj(a,y.name);for(var A in y)void 0==u[A]&&(u[A]=y[A]);if("false"!=u.visible&&0!=u.visible&&(a.rawNode[y.name]||null==y.value||void 0==y.value||(a.rawNode[y.name]=y.value,"graph"==y.type&&(a.rawNode[y.name]="")),f||1!=y.dontExport)){var B=y.label||y.name;void 0!=u.label&&(B=u.label);var C=k.length+1;void 0!=u.order&&(C=u.order),l({propObj:u,label:B,value:dm_Tools.convertValue(a.rawNode[y.name]),order:C})}}}m(null,["icon","image"])}k.sort(function(a,b){var c=0,d=a.propObj.order,e=b.propObj.order;return void 0==d&&(d=a.order),void 0==e&&(e=b.order),c=dm_Tools.sortAttributesFromOrder(d,e,k)});for(var D,E=null,r=0;r<k.length;r++)if(E=k[r],"__dm_uniqueId"!=E.label&&"dm_uniqueId"!=E.label&&(void 0===h||0===h||h>0&&(!E.propObj.order&&r>=h||E.propObj.order<0||E.propObj.order>=h))){if(j=b(E.propObj,a,d,E.label,E.value),void 0===h&&0==(""+j).indexOf("#dm_STOP_AND_REDRAW_ATTRIBUTES_PANEL#")){var h=0;return D=j.substring("#dm_STOP_AND_REDRAW_ATTRIBUTES_PANEL#".length),D&&(h=parseInt(D)),void dm_Tools.onDisplayableRawNodeProps(a,b,c,d,e,f,g,h)}c+=j?j:""}return c},dm_Tools.cos=function(a){return Math.cos(a*Math.PI/180)},dm_Tools.sin=function(a){return Math.sin(a*Math.PI/180)},dm_Tools.circle=function(a,b,c,d,e,f,g,h){var i,j=1,k="",l=0;if(k+=g(c+e*dm_Tools.cos(a),d+e*dm_Tools.sin(a),h),l++,b-a>j)for(i=a+j,i=a+j;b>i;i+=j)k+=g(c+e*dm_Tools.cos(i),d+e*dm_Tools.sin(i),h),l++;return k+=g(c+e*dm_Tools.cos(b),d+e*dm_Tools.sin(b),h),l++,f[0]=l,k},dm_Tools.pie=function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o,p,q,r,s,t,u=0,v=0,w=-90,x="",y=[2],z="";for(e-=h,n=c+e,o=d+e,u=0;u<f.length;u++)v+=f[u];for(r=360/v,u=0;u<f.length;u++){z="";var A;l&&(A=j(a,b,y,z,k,g[u],u,!0)),s=w+f[u]*r,t=w+(s-w)/2,p=n+h*dm_Tools.cos(t),q=o+h*dm_Tools.sin(t),z+=i(p,q,A),z+=dm_Tools.circle(w,s,p,q,e,y,i,A),z+=i(p,q,A),w=s,m&&(z=j(a,b,y,z,A,g[u],u,!1,!0)),x+=z}return x},dm_Tools.getParentNode4Config=function(a){var b,c=a;for(a||(a=dm_Datamap.currentDatamap.root);!b&&a;)b=a[dm_Tools_dm_config_name],c=a,a=a.parent;return c},dm_Tools.getConfig=function(a,b){var c,d=b||dm_Tools.getParentNode4Config(a);return d&&(c=d[dm_Tools_dm_config_name]),c||(c=dm_Tools.getDefaultConfigFile(),d&&(d[dm_Tools_dm_config_name]=c)),c},dm_Tools.getChildrenAtLevel=function(a,b){var c;if(a){if(!b||a.level<b)if(a.children)for(var d,e=a.children.length,f=0;e>f;f++){d=a.children[f];var g=dm_Tools.getChildrenAtLevel(d,b);if(g)if(c)for(var h,i=g.length,j=0;i>j;j++)h=g[j],c.push(h);else c=g}else b||(c=[],c.push(a));else a.level==b&&(c=[],c.push(a));return c}},dm_Tools.formatXml=function(a){var b="",c=/(>)(<)(\/*)/g;a=a.replace(c,"$1\r\n$2$3");var d=0;return jQuery.each(a.split("\r\n"),function(a,c){var e=0;c.match(/.+<\/\w[^>]*>$/)?e=0:c.match(/^<\/\w/)?0!=d&&(d-=1):e=c.match(/^<\w[^>]*[^\/]>.*$/)?1:0;for(var f="",g=0;d>g;g++)f+="  ";b+=f+c+"\r\n",d+=e}),b},dm_Tools.getColorInGradient=function(a,b,c){var d=parseInt(a.substring(1,3),16),e=parseInt(a.substring(3,5),16),f=parseInt(a.substring(5),16),g=parseInt(b.substring(1,3),16),h=parseInt(b.substring(3,5),16),i=parseInt(b.substring(5),16),j=Math.min(255,Math.round(d+(g-d)*c/100)),k=Math.min(255,Math.round(e+(h-e)*c/100)),l=Math.min(255,Math.round(f+(i-f)*c/100)),m=dm_Tools.hex2str(j);m.length<2&&(m="0"+m);var n=dm_Tools.hex2str(k);n.length<2&&(n="0"+n);var o=dm_Tools.hex2str(l);o.length<2&&(o="0"+o);var p="#"+m+n+o;return p},dm_Tools.getColorDifference=function(a,b){var c,d=parseInt(a.substring(1,3),16),e=parseInt(a.substring(3,5),16),f=parseInt(a.substring(5),16),g=parseInt(b.substring(1,3),16),h=parseInt(b.substring(3,5),16),i=parseInt(b.substring(5),16),j=100*(g-d)/d,k=100*(h-e)/e,l=100*(i-f)/f;return c=(j+k+l)/3},dm_Tools.getImageSrc=function(a,b){var c,d=a.imageName;return d.indexOf("data:image")<0&&"http"!=d.substring(0,4)&&(d="data/images/"+d),c=b?d||a.inlineSrc:a.inlineSrc||d},dm_Tools.getImageFromNode=function(a,b,c,d,e){var f,g,h,i=d?"_"+d:"",j=dm_Tools.getConfig(a);if(c)a.rawNode&&(f=a.rawNode[c+i],h=a.rawNode);else{var c="icon"+i;a.rawNode&&(h=a.rawNode,b?f=a.rawNode[c]:a.rawNode.image?(c="image"+i,f=a.rawNode[c]):f=a.rawNode[c])}if(!f&&h&&0!=h[c+".visible"]&&"false"!=h[c+".visible"]&&j&&j.styles&&j.styles.length>a.level&&(h=j.styles[a.level],c?f=h[c]:(c="image"+i,f=h[c],f||(c="icon"+i,f=h[c])),f&&(g=dm_Tools.prop2obj(h,c))),f){if(f=f.replace(/\\/g,"/"),g||(g={},g=dm_Tools.prop2obj(a,c)),e){var k,l=f.lastIndexOf("/");l>0?k=f.substring(0,l+1):l=0,k+=e+"/",k+=f.substring(l+1),f=k}if(g.imageName=f,j&&j.styles&&j.styles[a.level]){var m=dm_Tools.prop2obj(j.styles[a.level],c);g.inlineSrc||(g.inlineSrc=m.inlineSrc),g.width||(g.width=m.width),g.height||(g.height=m.height),g.scaleFactor||(g.scaleFactor=m.scaleFactor),g.panelMaxHeight||(g.panelMaxHeight=m.panelMaxHeight),g.textX||(g.textX=m.textX),g.opacity||(g.opacity=m.opacity),g.x||(g.x=m.x),g.y||(g.y=m.y)}}return g},dm_Tools.countNodes=function(a,b,c,d){var e=0,d=d||0;if(a&&(!c||a.children)&&(e=1,(!b||b>d)&&a.children))for(var f,g=a.children.length,h=0;g>h;h++)f=a.children[h],e+=dm_Tools.countNodes(f,b,c,d+1);return e},dm_Tools.random=function(a,b,c,d){var e=function(a){return Math.floor(Math.random()*Math.pow(10,a))},f=function(a,b){var c=e(a);if(b){for(var d=0;c>b&&d++<200;)c=e(a);c>b&&(c=b)}return c},g=(d||0)+f(a,c-(d||0));if(b)for(g=""+g;b&&g.length<a;)g="0"+g;return g},dm_Tools.trash,dm_Tools.randomString=function(a,b){for(var c="",d=b||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=0;a>e;e++)c+=d.charAt(Math.floor(Math.random()*d.length));return c},dm_Tools.distinct=function(a,b){var c;dm_Tools.trash||(dm_Tools.trash={}),dm_Tools.trash[b]||(dm_Tools.trash[b]={});for(var d=0;d++<1e3&&dm_Tools.trash[b][c=a()];);return d>=1e3&&console.log("Impossible to randomize a value for '"+b+"' different from : '"+c+"'"),dm_Tools.trash[b][c]=1,c},dm_Tools.getFirstLeaves=function(a,b,c){var d;if(a&&!a.children&&b>0&&c&&a.rawNode&&a.rawNode[c])d=[a];else if(a&&a.children&&b>0)for(var e,f=a.children.length,g=0;f>g;g++){e=a.children[g];var h=dm_Tools.getFirstLeaves(e,b,c);h&&(b-=h.length,d=d?d.concat(h):h)}return d},dm_Tools.hasParentWithName=function(a,b){return a&&a.name==b?a:a.parent?dm_Tools.hasParentWithName(a.parent,b):void 0},dm_Tools.html2rtf=function(a){if(!a)return a;a=a.replace(/[&]nbsp[;]/gi," ");var b=dm_Tools.html2dom(a),c=[!0],d=function(a){var b="",c=a.indexOf('style="text-align:');if(c>=0){var d=a.indexOf('"',c+7),e=a.substring(c+7,d);e.indexOf("center")>=0?b="\\qc ":e.indexOf("left")>=0?b="\\ql ":e.indexOf("right")>=0?b="\\qr ":e.indexOf("justify")>=0&&(b="\\qj ")}return b},e=function(){var a="\\par "+(c[0]?"\\pard ":"");return c[0]=!1,a},f=function(a){var b="",g="",h="";if(a)if("string"==typeof a)b+=a;else{if("u"==a.name)g+="{\\ul ",h+="}";else if("b"==a.name)g+="{\\b ",h+="}";else if("i"==a.name)g+="{\\i ",h+="}";else if("font"==a.name){var i=a.props.indexOf("size");if(i>=0){var j=a.props.indexOf('"',i),k=a.props.indexOf('"',j+1),l=a.props.substring(j+1,k);g+="{\\fs"+dm_Tools.rtfFontSize(l)+" ",h+="}"}}else if("ul"==a.name)g+="{\\ls1",h+="}";else if("li"==a.name){var m=d(a.props);""!=m&&(g+=m,c[0]=!0);for(var n=0,o=a.parent;o&&"ul"==o.name;)n++,o=o.parent;n-=1;var p=dm_Rtf.rtfBulletStyles[n];g+="\\ls1 "+(n>0?"\\ilvl"+n+" ":"")+p+" ",h+=e()}else if("div"==a.name||"p"==a.name){g+=e();var m=d(a.props);""!=m&&(g+=m,c[0]=!0)}if(b+=g,a.children)for(var q,r=a.children.length,s=0;r>s;s++)q=a.children[s],b+=f(q);b+=h}return b};return f(b)},dm_Tools.removeAndReplaceDiv=function(a,b,c,d){var e,f=d3.select("#"+b);return f&&(e=f.style("height"),f.remove()),f=d3.select("#"+a).append("div").attr("id",b).attr("height","100%").style("height",e).style("max-height",e),c&&f.attr("class","modal-body"),f},dm_Tools.getXhr=function(){var a=null;if(window.XMLHttpRequest||window.ActiveXObject)if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){a=new ActiveXObject("Microsoft.XMLHTTP")}else a=new XMLHttpRequest;else console.log("Your browser does not support XMLHttpRequest...");return a},dm_Tools.loadFromUrl=function(a,b){var c="xmlhttp";if("xmlhttp"==c){var d=dm_Tools.getXhr();d.onreadystatechange=function(){4==d.readyState&&200==d.status&&b&&b(d.responseText)},d.open("GET",a,!0),d.setRequestHeader("Access-Control-Allow-Origin","*"),d.setRequestHeader("Access-Control-Allow-Headers","Cache-Control, Pragma, Origin, Authorization, Content-Type, X-Requested-With"),d.setRequestHeader("Access-Control-Allow-Methods","GET, PUT, POST"),d.send()}else if("iframe"==c){$("#fake_iframe_to_load_url_content_and_avoid_cross_domain_check").off("load");var e=d3.selectAll("body").append("iframe").attr("src",a).attr("id","fake_iframe_to_load_url_content_and_avoid_cross_domain_check").style("display","none").style("visibility","hidden").style("position","absolute").style("left","0px").style("top","0px").style("z-index","-1000").attr("height","0px").style("height","0px").on("load",function(){var a=e[0][0],b=a.contentWindow||a.contentDocument;b.document.body;console.log(d3.selectAll("#fake_iframe_to_load_url_content_and_avoid_cross_domain_check"))})}else"yql"==c&&jQuery.get(a,function(a){a&&a.responseText&&console.log(a.responseText)})},dm_Tools.splitStr=function(a,b,c,d){for(var e,d=d||" ",f=a.split(d),g=0,h="",i="",j=0;j<f.length;j++)e=f[j],g+=e.length,i&&g>=b?(h+=c,i="",g=e.length):i&&(h+=d,i+=d,g++),h+=e,i+=e;return h},dm_Tools.defaultConfigFile=null,dm_Tools.configConfigFile=null,dm_Tools.getDefaultConfigFile=function(a,b){if(b){if(dm_Tools.configConfigFile)return a&&a(dm_Tools.clone(dm_Tools.configConfigFile)),dm_Tools.clone(dm_Tools.configConfigFile);d3.text("config/config.config.json","text/plain;charset=ISO-8859-15",function(b){dm_Tools.configConfigFile=dm_Tools.parseStringified(b).config,a&&a(dm_Tools.clone(dm_Tools.configConfigFile))})}else{if(dm_Tools.defaultConfigFile)return a&&a(dm_Tools.clone(dm_Tools.defaultConfigFile)),dm_Tools.clone(dm_Tools.defaultConfigFile);d3.text("config/default.config.json","text/plain;charset=ISO-8859-15",function(b){dm_Tools.defaultConfigFile=dm_Tools.parseStringified(b).config,a&&a(dm_Tools.clone(dm_Tools.defaultConfigFile))})}},dm_Tools.removePxAndParseInt=function(a){var b=null,a=a;if(a){var c=a.indexOf("px");c>=0&&(a=a.substring(0,c));try{b=parseInt(a)}catch(d){b=null}isNaN(b)&&(b=null)}return b},dm_Tools.loadLocalFile=function(a,b,c,d,e,f,g,h,i){var j=new XMLHttpRequest,f=f;f!==!1&&(f=!0),j.open("GET",a,f),j.overrideMimeType&&j.overrideMimeType(e||"text/plain; charset=x-user-defined"),j.setRequestHeader("Access-Control-Allow-Headers","*"),j.setRequestHeader("Access-Control-Allow-Headers","Cache-Control, Pragma, Origin, Authorization, Content-Type, X-Requested-With"),j.setRequestHeader("Access-Control-Allow-Methods","GET, PUT, POST"),j.withCredentials=!0,!g&&h&&(g="Basic "+btoa(h+":"+i)),j.setRequestHeader("Authorization",g),j.onreadystatechange=function(){4==this.readyState&&200==this.status&&(c&&dm_Tools.saveFile(this.response||this.responseText,a,d?d:"text/plain","x-user-defined"),null!=b&&b(this))},j.send()},dm_Tools.positiveHex=function(a){if(0>a){for(var b=a.toString(16),c="",d=0;d<b.length-1;d++)c+="f";a=parseInt(c,16)+a+1}return a},dm_Tools.hex2str=function(a){return dm_Tools.positiveHex(a).toString(16)},dm_Tools.distBetween2points=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},dm_Tools.arcCenter=function(a,b,c,d,e,f){var e=e||dm_Tools.distBetween2points(a,b,c,d),g=c-a>0?-1:1,h=2*Math.PI/3*(0==f?-1:1),i=Math.atan((d-b)/(c-a)),j=i+h;return{x:a+g*e*Math.cos(j),y:b+g*e*Math.sin(j)}},dm_Tools.circleIntersect=function(a,b,c,d,e,f){var g=d-a,h=e-b,i=Math.sqrt(g*g+h*h),j=(i*i+c*c-f*f)/(2*i),k=a+g*j/i+h/i*Math.sqrt(c*c-j*j),l=a+g*j/i-h/i*Math.sqrt(c*c-j*j),m=b+h*j/i-g/i*Math.sqrt(c*c-j*j),n=b+h*j/i+g/i*Math.sqrt(c*c-j*j);return{x1:k,y1:m,x2:l,y2:n}},dm_Tools.formatDuration=function(a,b,c,d){var e=function(a){var b="";return 10>a&&(b+="0"),b+=a},f=1e3,g=60*f,h=60*g,i=24*h,j=7*i,k=365*i,l=a,m=Math.floor(l/k);l-=m*k;var n=Math.floor(l/j);l-=n*j;var o=Math.floor(l/i);l-=o*i;var p=Math.floor(l/h);l-=p*h;var q=Math.floor(l/g);l-=q*g;var r=Math.floor(l/f);l-=r*f;var s=l,b=b||":",c=c||"-",t="";return t+=m>0?m+(d?"y ":c):"",t+=m>0?n+(d?"w ":c):n>0?n+(d?"w ":c):"",t+=m>0||n>0?o+(d?"d ":" "):o>0?o+(d?"d ":" "):"",t+=p>0?p+(d?"h ":b):"",t+=p>0?e(q)+(d?"mn ":b):q>0?q+(d?"mn ":b):"",t+=p>0||q>0?e(r)+(d&&0==s?"s":""):r>0||s>0?r+(d&&0==s?"s":""):"",s>0&&(t+="."+s+(d?"s":"")),t},dm_Tools.parseDuration=function(a,b){for(var c,d,e,f,g,h,i,b=b||":",j=(""+a).split(b),k=!1,l=1e3,m=60*l,n=60*m,o=24*n,p=7*o,q=365*o,r=j.length-1;r>=0;r--){var s;try{s=parseInt(j[r])}catch(t){}null!=s&&(k=!0,null==c?c=s:null==d?d=s:null==e?e=s:null==f?f=s:null==g?g=s:null==h&&(h=s))}return k&&(h=null!=h?h:0,g=null!=g?g:0,f=null!=f?f:0,e=null!=e?e:0,d=null!=d?d:0,c=null!=c?c:0,i=h*q+g*p+f*o+e*n+d*m+c*l),i},dm_Tools.addNodeInListOfNodes=function(a,b,c){if(a){var d=dm_Tools.getNodePath(a,null,c,null,null,null,!0);d&&""!=d?b[d]?dm_Tools.isArray(b[d])?b[d].concat(a):b[d]=[b[d],a]:b[d]=a:b[a.dm_uniqueId]=a}},dm_Tools.getAllNodesFromNode=function(a){for(var b=a;b.parent;)b=b.parent;var c={},d=function(a){if(dm_Tools.addNodeInListOfNodes(a,c,!0),a&&a.children)for(var b,e=a.children.length,f=0;e>f;f++)b=a.children[f],d(b)};return d(b),c},dm_Tools.bin2Array=function(a){var b,c=a.length,d=[];for(b=0;c>b;b++)d.push(255&a.charCodeAt(b));return d},dm_Tools.uint8ToString=function(a){var b,c,d="";for(b=0,c=a.length;c>b;b+=1)d+=String.fromCharCode(a[b]);return d},dm_Tools.dontAsk4server=!0,dm_Tools.testFileExist=function(a,b,c,d,e,f,g,h,i){if(!a)return void(c&&c());var j,d=null!=d?d:!0;a.indexOf(".")>0&&(j=a.substring(a.lastIndexOf(".")+1));var i=i||"GET";e&&(i="HEAD");var f=f||"text/plain";g&&(f+="; charset:"+g);var k={type:i,url:a,success:function(a){var c;!e&&a&&(c="object"==typeof a&&a.responseText?a.responseText:a),b&&b(c,"comes from local file")},error:function(d){if(200==d.status&&"OK"==d.statusText&&"json"==j){var e;d&&(e=d.responseText),b&&b(e,"comes from local file")}else{var f=!1;dm_Datamap&&dm_Datamap.currentDatamap&&dm_Datamap.currentDatamap.config&&dm_Datamap.currentDatamap.config.ask4server&&(f=!0),f?dm_IO.loadFileFromTheServer(a,function(a){b&&b(a,"comes from server")},c):c&&c()}},async:d,contentType:f};h&&(k.dataType=h),$.ajax(k)},dm_Tools.concat=function(a,b){if(a&&b)for(var c,d=b.length,e=0;d>e;e++)c=b[e],a.push(c);return a},dm_Tools.getSearchList=function(a,b,c,d){var b=b||dm_Tools.getParentNode4Config(a),e=dm_Tools.getConfig(a),f=e.props4globalSearch,c=c||" | ",d=d||{},g=function(a,b){var d;if(a&&(a.name&&(d||(d=""),d+=a.name),a.rawNode&&b))for(var e,f=b.length,g=0;f>g;g++)e=b[g],a.rawNode[e]&&(d?d+=c:d="",d+=a.rawNode[e]);return d&&(d=d.trim()),d},h=g(b,f);if(h&&(d[h]=b),b.children)for(var i,j=b.children.length,k=0;j>k;k++)i=b.children[k],i&&dm_Tools.getSearchList(i,i,c,d);return d},dm_Tools.getConfigProp=function(a,b,c){if(b&&a){var d,e=dm_Tools.getParentNode4Config(b);e&&(d=e[dm_Tools_dm_config_name]);var f;return d&&(f=d[a]),null==f&&(f=dm_Tools.getConfigProp(a,e.parent||c)),null==f&&(f=dm_Tools.clone(dm_Tools.defaultConfigFile[a])),f}},dm_Tools.getConfigPropInCascad=function(a,b){for(var c,d=a;d&&!c;)d=dm_Tools.getParentNode4Config(d),c=d[dm_Tools_dm_config_name][b],d=d.parent;return c||(c=dm_Tools.clone(dm_Tools.defaultConfigFile[b])),c},dm_Tools.getGaugeFromNode=function(a,b){var c;if(a&&a.rawNode){var d="gauge_"+b;if(c=a.rawNode[d+".dm_props"],!c)for(var e in a.rawNode)if(e.indexOf(d)>=0){var f=e.substring(d.length+1);f&&""!=f&&(c||(c={}),c[f]=a.rawNode[e])}}if(c){if(c=dm_Tools.clone(c),c.scale||(c.scale=1),c.width||(c.width=30),c.height||(c.height=8),c.stroke||(c.stroke="#000000"),c["stroke-width"]||(c["stroke-width"]=1),c.backgrdOpacity||(c.backgrdOpacity=.8),c.x||(c.x=0),c.y?c.y=-c.y:c.y=0,c.colorMin||(c.colorMin="#FF4040"),c.colorMax||(c.colorMax="#98C237"),c.invertColors){var g=c.colorMax;c.colorMax=c.colorMin,c.colorMin=g}(!c.max||c.max<=0)&&(c.max=100),c.value&&(c.value<0&&(c.value=0),c.value>c.max&&(c.value=c.max))}return c},dm_Tools.fastIsNaN=function(a){return!(0>=a||a>0)},dm_Tools.parseNumber=function(a){var b=a;if(a&&"string"==typeof a&&(a=(""+a).replace(/,/g,"."),a=a.replace(/ /g,""),1==a&&(b=1),0==a&&(b=0),1!=a&&0!=a&&!dm_Tools.fastIsNaN(a)))try{b=parseFloat(a)}catch(c){try{b=parseInt(a)}catch(d){b=null}}return b},dm_Tools.parseNumbersOfTree=function(a){var b=function(a){if(a.rawNode)for(prop in a.rawNode)a.rawNode[prop]=dm_Tools.parseNumber(a.rawNode[prop]);if(a.children)for(var c,d=a.children.length,e=0;d>e;e++)c=a.children[e],c&&b(c)};a&&b(a)},dm_Tools.isParentOfEachOther=function(a,b){for(var c=!1,d=a,e=b;d&&!c;)c=d==b,d=d.parent;for(;e&&!c;)c=e==a,e=e.parent;return c},dm_Tools.getTargetFromConnection=function(a,b,c){var d=null;return a&&(a.connectNodeUniqueId&&(!c&&b&&(c=dm_Datamap.maps[b.dm_DatamapName]),d=dm_Tools.getNodeFromUniqueId(a.connectNodeUniqueId,c),d&&(a.nodePath=dm_Tools.getNodePath(d,null,!0,null,null,null,!0))),!d&&a.nodePath&&(d=dm_Tools.getNodeFromPath(a.nodePath,b).node,d?a.connectNodeUniqueId="$ref_"+d.dm_uniqueId:console.log("Cannot resolve connection node path : ",a.nodePath))),d},dm_Tools.isAlreadyConnected=function(a,b,c,d,e,f,g){var h=a==b,f=f||dm_Tools.getParentNode4Config(a),g=g||dm_Datamap.maps[f.dm_DatamapName],i=e?dm_Tools_aggregatedConnected:dm_Tools_connected;if(!h&&a&&a.rawNode&&a.rawNode[i+d])for(var j,k,l=a.rawNode[i+d],m=l.length-1;m>=0&&!h;m--)j=l[m],k=dm_Tools.getTargetFromConnection(j,f,g),h=k==b,j.name&&c&&(h=h&&j.name==c);return h},dm_Tools.flatClone=function(a){var b;if(a){b={};for(var c in a)b[c]=a[c]}return b},dm_Tools.completeBothSidesOfConnection=function(a,b,c,d){if(a.rawNode){var c=c||dm_Tools.getParentNode4Config(a),d=d||dm_Datamap.maps[c.dm_DatamapName],e=a.rawNode[dm_Tools_connected+b];if(e)for(var f,g=e.length-1;g>=0;g--)if(f=e[g]){var h=dm_Tools.getTargetFromConnection(f,c,d);if(h){h.rawNode||(h.rawNode={});var i="From"==b?"To":"From";if(!dm_Tools.isAlreadyConnected(h,a,f.name,i,!1,c,d)){h.rawNode[dm_Tools_connected+i]||(h.rawNode[dm_Tools_connected+i]=[]);var j=dm_Tools.flatClone(f);j.nodePath=dm_Tools.getNodePath(a,null,!0,null,null,null,!0),j.connectNodeUniqueId="$ref_"+a.dm_uniqueId,h.rawNode[dm_Tools_connected+i].push(j)}h.rawNode[dm_Tools_connected+i+".dm_props"]||(h.rawNode[dm_Tools_connected+i+".dm_props"]={name:dm_Tools_connected+i,label:dm_Tools_connected+i,type:"transverse link",source:"user"})}}}},dm_Tools.completeBothSidesOfConnections=function(a,b,c){if(a){var b=b||dm_Tools.getParentNode4Config(a),c=c||dm_Datamap.maps[b.dm_DatamapName];if(a.children)for(var d,e=a.children.length-1;e>=0;e--)d=a.children[e],dm_Tools.completeBothSidesOfConnections(d,b,c);dm_Tools.completeBothSidesOfConnection(a,"To",b,c),dm_Tools.completeBothSidesOfConnection(a,"From",b,c)}},dm_Tools.removeOppositeConnection=function(a,b,c){var d=dm_Tools.getParentNode4Config(a),e=dm_Datamap.maps[d.dm_DatamapName],f=dm_Tools.getTargetFromConnection(b,d,e);if(f){var g=null,h=c.name.indexOf("To");if(0>h&&(h=c.name.indexOf("From")),h>=0&&(g=c.name.substring(0,h)+("To"==c.name.substring(h)?"From":"To")),g&&f.rawNode&&f.rawNode[g])for(var i,j,k=0;k<f.rawNode[g].length;)i=f.rawNode[g][k],j=dm_Tools.getTargetFromConnection(i,d,e),j!=a||b.name&&b.name!=i.name?k++:f.rawNode[g].splice(k,1)}},dm_Tools.doAggregatedConnection=function(a,b,c,d,e){var f;return a&&b&&(dm_Tools.isAlreadyConnected(a,b,c.name,d,!0)||(a.rawNode||(a.rawNode={}),a.rawNode[dm_Tools_aggregatedConnected+d]||(a.rawNode[dm_Tools_aggregatedConnected+d]=[]),f=dm_Tools.flatClone(c),f.nodePath=dm_Tools.getNodePath(b,null,!0,null,null,null,!0),f.connectNodeUniqueId="$ref_"+b.dm_uniqueId,e&&(f.originalConnection=e),a.rawNode[dm_Tools_aggregatedConnected+d].push(f))),f},dm_Tools.aggregateConnectionsBetweenParents=function(a,b,c,d){for(var e,f,g=a,h=b,i=dm_Tools.getDepth(g),j=dm_Tools.getDepth(h),k=function(){f=dm_Tools.doAggregatedConnection(g,h,c,d,e),e={source:"To"==d?g:h,target:"To"==d?h:g,connectionObj:f}};g&&i>j;)e||(e={source:"To"==d?g:h,target:"To"==d?h:g,
connectionObj:c}),g=g.parent,i--,k();for(;h&&j>i;)e||(e={source:"To"==d?g:h,target:"To"==d?h:g,connectionObj:c}),h=h.parent,j--,k();for(;g&&h&&g!=h;)e||(e={source:"To"==d?g:h,target:"To"==d?h:g,connectionObj:c}),g=g.parent,i--,h=h.parent,j--,k()},dm_Tools.aggregateConnection=function(a,b,c,d){if(a&&a.rawNode){var c=c||dm_Tools.getParentNode4Config(a),d=d||dm_Datamap.maps[c.dm_DatamapName];delete a.rawNode[dm_Tools_aggregatedConnected+b];var e=a.rawNode[dm_Tools_connected+b];if(e)for(var f,g=e.length-1,h="From"==b?"To":"From";g>=0;g--)if(f=e[g]){var i=dm_Tools.getTargetFromConnection(f,c,d);i?(dm_Tools.aggregateConnectionsBetweenParents(a,i,f,b),dm_Tools.aggregateConnectionsBetweenParents(i,a,f,h)):"To"==b?console.log('Failed to connect "'+dm_Tools.getNodeUrl(a,!0)+'" to "'+f.nodePath+'" : target not found'):console.log('Failed to connect "'+f.nodePath+'" to "'+dm_Tools.getNodeUrl(a,!0)+'" : source not found')}}},dm_Tools.aggregateConnections=function(a,b,c){if(a){var b=b||dm_Tools.getParentNode4Config(a),c=c||dm_Datamap.maps[b.dm_DatamapName];if(a.children)for(var d,e=a.children.length-1;e>=0;e--)d=a.children[e],dm_Tools.aggregateConnections(d,b,c);dm_Tools.aggregateConnection(a,"To",b,c),dm_Tools.aggregateConnection(a,"From",b,c)}},dm_Tools.removeConnectionUniqueIds=function(a){var b=function(a,b){if(a.rawNode){var c=a.rawNode["connected"+b];if(c)for(var d,e=c.length-1;e>=0;e--)d=c[e],delete d.connectNodeUniqueId}};dm_Tools.scanNodes(a,function(a){b(a,"To"),b(a,"From")})},dm_Tools.numberOfParents=function(a){var b=0;if(a)for(var c=a.parent;c;)b++,c=c.parent;return b},dm_Tools.removeSpecificProps=function(a,b,c){var d=function(a,b){var c=a===b;return c||(c=JSON.stringify(a)==JSON.stringify(b)),c},e=function(a,b){if(a.rawNode&&b.rawNode)for(var c in b.rawNode)if("itemsPie.dm_props"==c&&console.log(),c!=dm_uniqueId)if(c.indexOf(".dm_props")>0){var e=!1;for(var f in b.rawNode[c])"dm_uniqueId"!=f&&a.rawNode[c]&&(d(a.rawNode[c][f],b.rawNode[c][f])?delete a.rawNode[c][f]:void 0!=a.rawNode[c][f]&&(e=!0));e||delete a.rawNode[c]}else d(a.rawNode[c],b.rawNode[c])&&delete a.rawNode[c]},b=b;b||(b=dm_Tools.getConfig(a));var f=b.specifics;if(f)for(var g=null,h=null,i=null,j=null,k=0;k<f.length;k++)if(g=f[k],h=g.name,i=dm_Tools.getNodeFromPath(h,a,c,!0),i&&i.nodes)for(var l=0;l<i.nodes.length;l++)j=i.nodes[l],e(j,g)},dm_Tools.utf8AccentsToReplace=["Ã€","Ã‚","Ãƒ","Ã„","Ã…","Ã†","Ã‡","Ãˆ","Ã‰","ÃŠ","Ã‹","ÃŒ","ÃŽ","Ã‘","Ã’","Ã“","Ã”","Ã•","Ã–","Ã—","Ã˜","Ã™","Ãš","Ã›","Ãœ","Ãž","ÃŸ","Ã¡","Ã¢","Ã£","Ã¤","Ã¥","Ã¦","Ã§","Ã¨","Ã©","Ãª","Ã«","Ã¬","Ã­","Ã®","Ã¯","Ã°","Ã±","Ã²","Ã³","Ã´","Ãµ","Ã¶","Ã·","Ã¸","Ã¹","Ãº","Ã»","Ã¼","Ã½","Ã¾","Ã¿","Ã","â"],dm_Tools.utf8AccentsReplaceWith=["À","Â","Ã","Ä","Å","Æ","Ç","È","É","Ê","Ë","Ì","Î","Ñ","Ò","Ó","Ô","Õ","Ö","×","Ø","Ù","Ú","Û","Ü","Þ","ß","á","â","ã","ä","å","æ","ç","è","é","ê","ë","ì","í","î","ï","ð","ñ","ò","ó","ô","õ","ö","÷","ø","ù","ú","û","ü","ý","þ","ÿ","à","'"],dm_Tools.replaceUtf8Accents=function(a){if(!dm_Tools.utf8AccentsReplace){dm_Tools.utf8AccentsReplace={};for(var b=0;b<dm_Tools.utf8AccentsToReplace.length;b++)dm_Tools.utf8AccentsReplace[dm_Tools.utf8AccentsToReplace[b]]=dm_Tools.utf8AccentsReplaceWith[b]}var c=new RegExp(dm_Tools.utf8AccentsToReplace.join("|"),"g");return a.replace(c,function(a,b,c){var d=dm_Tools.utf8AccentsReplace[a];return d})},dm_Tools.removeSpecialChars=function(a){var a=a.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"");return a},dm_Tools.formatJSVarName=function(a){return dm_ServerTools.formatJSVarName(a)},dm_Tools.writeHTMLCanvasTxt=function(a,b,c,d,e,f,g,h,i){f&&(a.strokeStyle=f,a.shadowColor=f,a.shadowBlur=h,a.lineWidth=g||3,a.strokeText(b,c,d)),a.fillStyle=e,a.fillText(b,c,d),a.shadowColor=null,a.shadowBlur=0},dm_Tools.getDefaultFontSize=function(a){var b=document.body,c=document.createElement("div");c.style.cssText="display:inline-block; padding:0; line-height:1; position:absolute; visibility:hidden; font-size:1em",c.appendChild(document.createTextNode(a)),b.appendChild(c);var d={w:c.offsetWidth,h:c.offsetHeight};return b.removeChild(c),d},dm_Tools.parseDate=function(a){var b=/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/,c=b.exec(a),d=new Date(+c[3],+c[2]-1,+c[1],+c[4],+c[5],+c[6]);return d},dm_Tools.secondsToString=function(a){var b={};return b.years=Math.floor(a/31536e3),b.days=Math.floor(a%31536e3/86400),b.months=Math.round(b.days/30.5),b.hours=Math.floor(a%31536e3%86400/3600),b.minutes=Math.floor(a%31536e3%86400%3600/60),b.seconds=a%31536e3%86400%3600%60,b},dm_Tools.removeCommentsCLike=function(a){return a.replace(/\/\*.+?\*\/|\/\/.*(?=[\n\r])/g,"")},dm_Tools.removeCommentsHash=function(a){return a.replace(/#.*(?=[\n\r])/g,"")},dm_Tools.decodeValue=function(a,b){if(output=a,"string"==typeof a){if(output=""+output,output=output.trim(),b)try{output=decodeURIComponent(a)}catch(c){output=a}output=dm_Tools.parseNumber(output)}return output},dm_Tools.convertImgToBase64=function(a,b,c){var d=document.createElement("CANVAS"),e=d.getContext("2d"),f=new Image;f.crossOrigin="Anonymous",f.onload=function(){var a;d.height=f.height,d.width=f.width,e.drawImage(f,0,0),a=d.toDataURL(c),b.call(this,a),d=null},f.src=a},dm_Tools.arrayFromObj=function(a){var b=[];for(prop in a)b.push(prop);return b},dm_Tools.removeProps4nodes=function(a,b,c){for(var d,a=a,e=[a],f=function(b){c?delete a.rawNode[b]:delete a[b]};e.length>0;)if(a=e.pop()){if("string"==typeof b)f(b);else for(d=b.length-1;d>=0;d--)f(b[d]);if(a.children)for(d=a.children.length-1;d>=0;d--)e.push(a.children[d])}},dm_Tools.setProps4nodes=function(a,b,c){for(var d,a=a,e=[a];e.length>0;)if(a=e.pop()){if("string"==typeof b)a[b]=c;else for(d=b.length-1;d>=0;d--)a[b[d]]=c[d];if(a.children)for(d=a.children.length-1;d>=0;d--)e.push(a.children[d])}},dm_Tools.updateLevels=function(a){for(var b,a=a,c=[a];c.length>0;)if(a=c.pop(),a&&(dm_Tools.bestEffortLevel(a),a.children))for(b=a.children.length-1;b>=0;b--)c.push(a.children[b])},dm_Tools.mergeAttributes=function(a,b){for(var c in b)("undefined"===a[c]||null===a[c])&&(a[c]=b[c])},dm_Tools.isChild=function(a,b){if(a&&a.children)for(var c,d=a.children.length-1;d>=0;d--)if(c=a.children[d],c.name==b)return c},dm_Tools.merge=function(a,b,c,d){var e=null;if(a&&b&&(c||a.name==b.name)){e=a;if(b.children){var f,g,h=b.children.length-1;for(a.children||(a.children=[]);h>=0;h--)f=b.children[h],g=dm_Tools.isChild(a,f.name),g?dm_Tools.merge(g,f):(f.parent=a,a.children.push(f),f[dm_Tools_dm_config_name]=d)}a.rawNode&&dm_Tools.mergeAttributes(a.rawNode,b.rawNode),dm_Tools.mergeAttributes(a,b)}return e},dm_Tools.noShow=function(){var a=d3.select("#temporary_and_hidden");return a[0][0]||(a=d3.select(dm_UI_globalContainer).append("noshow").attr("id","temporary_and_hidden").style("position","absolute").style("top","-100000px").style("left","-100000px").style("display","none").style("z-index",-1e3)),a},dm_Tools.resetNoShow=function(){dm_Tools.noShow().html("")},dm_Tools.getParentWithClass=function(a,b){return a?a.getAttribute("class")==b?a:dm_Tools.getParentWithClass(a.parentNode):void 0},dm_Tools.isInModal=function(a){return $(a[0][0]).parents(".modal")[0]},dm_Tools.isInTooltip=function(a){return $(a[0][0]).parents(".popover")[0]},dm_Tools.tintImage=function(a,b,c,d){var e=dm_Tools.color2rgb(b),f=dm_Tools.noShow();f.selectAll("#dm_Tools_tintImage").remove();var g=f.append("canvas").attr("id","dm_Tools_tintImage")[0][0];if(g.width=a.offsetWidth||a.width,g.height=a.offsetHeight||a.height,g.width<=0||g.height<=0)return console.log("Warning: "+d+" has 0 width:"+g.width+" or height:"+g.height),a;var h=g.getContext("2d");h.drawImage(a,0,0);for(var i,j,k,l,m=h.getImageData(0,0,g.width,g.height),n=m.data,o=0,p=n.length;p>o;o+=4)i=n[o],j=n[o+1],k=n[o+2],l=Math.floor((i+j+k)/3),i=l+(e.r-127.5)*c/100,j=l+(e.g-127.5)*c/100,k=l+(e.b-127.5)*c/100,n[o]=Math.min(255,Math.max(i,0)),n[o+1]=Math.min(255,Math.max(j,0)),n[o+2]=Math.min(255,Math.max(k,0));return h.putImageData(m,0,0),h.globalCompositeOperation="lighter",h.globalAlpha=0,h.fillRect(0,0,g.width,g.height),a.src=g.toDataURL(),a},dm_Tools.tintImageSrc=function(a,b,c,d,e,f){var g=dm_Tools.noShow();g.selectAll("#dm_Tools_tintImageSrc").remove();var h=dm_Tools.noShow().append("img").attr("id","dm_Tools_tintImageSrc").attr("src",a);h.on("load",null),h.on("load",function(){d3.select(this).on("load",null),d.width||(d.width=this.width),d.height||(d.height=this.height);var g=this;f===!0||"true"===f||d.noTint===!0||"true"==d.noTint?d.tintedSrc=a:(g=dm_Tools.tintImage(this,b,c,a),d.tintedSrc=g.src),e&&e(g.src,g,this)})},dm_Tools.getImageSize=function(a,b,c,d){var e=dm_Tools.noShow();e.selectAll("#dm_Tools_getImageSizeImg").remove();var f=dm_Tools.noShow().append("img").attr("id","dm_Tools_getImageSizeImg").attr("src",a);f.on("load",null).on("error",null),f.on("load",function(){d3.select(this).on("load",null);var e=this.offsetWidth||this.width,f=this.offsetHeight||this.height;if(!c){var g=dm_Tools.noShow();g.selectAll("#dm_Tools_getImageSizeCanvas").remove();var h=g.append("canvas").attr("id","dm_Tools_getImageSizeCanvas")[0][0],i=1;d&&(i=e-d>f-d?d/e:d/f),h.width=e*i,h.height=f*i,(0==h.width||0==h.height)&&console.log("Warning: "+a+" has 0 width:"+h.width+" or height:"+h.height);var j=h.getContext("2d");j.drawImage(this,0,0),this.src=h.toDataURL()}b&&b(e,f,this)}).on("error",function(){b&&b(-1,-1,null)})},dm_Tools.inlineAndUpdateSizeOfAllImages=function(a,b,c){var d=[];dm_Tools.scanAllProps(a,function(a,b){if("icon"==b||"image"==b||a[b+".dm_props"]&&"image"==a[b+".dm_props"].type){var c=(a[b+".dm_props"]?a[b+".dm_props"].inlineSrc:null)||a[b]||(a[b+".dm_props"]?a[b+".dm_props"].imageName:null);d.push({parentObj:a,prop:b,imgSrc:c})}});var e=function(){var a=d.pop();if(a){var f=a.imgSrc;dm_Tools.getImageSize("data/images/"+f,function(c,d,g){if(g){a.parentObj[a.prop+".dm_props"]||(a.parentObj[a.prop+".dm_props"]={});var h=a.parentObj[a.prop+".dm_props"];h.type="image",h.imageName=f,h.width=c,h.height=d,b||(h.inlineSrc=g.src)}e()},b,c)}else console.log("after dm_Tools.inlineAndUpdateSizeOfAllImages",dm_Tools.getDelay("inlineAndUpdateSizeOfAllImages"))};e()},dm_Tools.getStyleSheets=function(){for(var a=[],b=0;b<document.styleSheets.length;b++){var c=document.styleSheets[b].href;c&&a.indexOf(c)<0&&a.push(c)}return a},dm_Tools.getIFrame=function(a,b,c,d,e){var f=a.append("iframe").attr("width",c?c+"px":"100%").attr("height",d?d+"px":"100%").style("border","none").style("scrolling","no").style("allowTransparency","true");return setTimeout(function(){var a=f[0][0].contentWindow||f[0][0].contentDocument,c=a.document,d=c.body,g=c.getElementsByTagName("head")[0],h=document.getElementsByTagName("style");if(g)for(var i=0;i<h.length;i++)g.appendChild(h[i].cloneNode(!0));var j=dm_Tools.getStyleSheets();if(j.forEach(function(a){var b=c.createElement("link");b.rel="stylesheet",b.type="text/css",b.href=a,d.appendChild(b)}),d3.select(d).style("background-color","transparent"),b){var k=d3.select(d).append("div").attr("align","center").append("table").attr("height","100%").append("tr").append("td").style("vertical-align","middle");k[0][0].appendChild(b[0][0])}e&&e(a)},10),f},dm_Tools.is3DgraphInAttributes=function(a){if(a.rawNode)for(var b in a.rawNode){var c=a.rawNode[b+".dm_props"];if(c&&"graph"==c.type&&c["3D"])return!0;var d=b.lastIndexOf(".3D");if(d>0&&a.rawNode[b]){var e=b.substring(0,d);if("graph"==a.rawNode[e+".type"])return!0}}},dm_Tools.getMinimumPath=function(a,b){var c=dm_Tools.getParentNode4Config(a),d=dm_Tools.getParentNode4Config(b),e=dm_Tools.getNodeUrl(c,!0,"noDatamapNameInURL"),f=dm_Tools.getNodeUrl(d,!0,"noDatamapNameInURL"),g=dm_Tools.getNodeUrl(b,!0,"noDatamapNameInURL");if(0==f.indexOf(e)){var h=e.lastIndexOf("|");h>=0&&(g=g.substring(h+1))}return g},dm_Tools.areNodePathEqual=function(a,b){var c=dm_Tools.getNodeUrl(b,!0,"noDatamapNameInURL",!0);return a==c?!0:(c=dm_Tools.getNodeUrl(b,!0,"noDatamapNameInURL"),a==c?!0:(c=dm_Tools.getNodeUrl(b,!0),a==c?!0:!1))},dm_Tools.getAllNodes=function(a,b){var b=b||[];if(b.push(a),a.children)for(var c,d=a.children.length-1;d>=0;d--)c=a.children[d],dm_Tools.getAllNodes(c,b);return b},dm_Tools.validateNodeWithStickerAndGauge=function(a,b,c){var d=[],c=c||1,e=function(a){a.rawNode["icon_"+c]="../../images/success_stamp.png",a.rawNode["icon_"+c+".dm_props"]={width:152,height:148,scaleFactor:7,imageName:"../../images/success_stamp.png"}},f=function(a){var g=function(a){if(a&&a.rawNode){var b=0,d=dm_Tools.getAllNodes(a),e=d.length;if(a.children?d.forEach(function(a){a&&a.rawNode&&a.rawNode["icon_"+c]&&b++}):a.rawNode["icon_"+c]&&(b=1),a.rawNode.nbOfValidatedNodes=b,b>0)a.rawNode["gauge_"+c+".dm_props"]={value:b,max:e,y:-21};else for(var f in a.rawNode)0==f.indexOf("gauge_"+c)&&delete a.rawNode[f]}a.parent&&!a.dm_config&&g(a.parent)};if(a&&a.rawNode){var h=!1;if(a.children){h=!0;for(var i,j=dm_Tools.getAllNodes(a),k=0;k<j.length&&h;k++)i=j[k],i.rawNode&&!i.rawNode["icon_"+c]&&(h=!1)}else h=!0;if(g(a),h){e(a);var l=function(a){var b=!1;return d.forEach(function(c){b||a!=c||(b=!0)}),b};d.push(a),a.rawNode&&a.rawNode.copyOf&&b.forEach(function(b){b&&b.rawNode&&b.rawNode.uid==a.rawNode.copyOf&&(l(b)||f(b))}),b.forEach(function(b){b&&b.rawNode&&b.rawNode.copyOf&&b.rawNode.copyOf==a.rawNode.uid&&(l(b)||f(b))}),f(a.parent)}}};e(a),f(a),dm_Datamap.currentDatamap.graph.init(null,"dont change node coords")},dm_Tools.iterOverObjProps=function(a,b,c){var d=dm_Tools.isArray(a),e=d?[]:{},f=0,c=c||{stopLoop:!1};if(d)for(f=0;f<a.length&&(e.push(b(a[f],f,f,a,c)),!c.stopLoop);f++);else for(var g in a)if(e[g]=b(a[g],g,f++,a,c),c.stopLoop)break;return e},dm_Tools.iterOverTable=function(a,b){return dm_Tools.iterOverObjProps(a,function(a,c,d,e,f){return dm_Tools.iterOverObjProps(a,b,f)})},dm_Tools.visitTree=function(a,b){if(a&&a.rawNode&&dm_Tools.iterOverObjProps(a.rawNode,b),a.children)for(var c=0;c<a.children.length;c++)dm_Tools.visitTree(a.children[c],b)},dm_Tools.iterOverColumn=function(a,b,c){return dm_Tools.iterOverObjProps(a,function(a,d,e,f,g){return c(a[b],e,a,g)})},dm_Tools.convertColumnsTreeIntoArray=function(a){var b=a;if(null!=a)if(dm_Tools.isArray(a)){b=[];for(var c=0;c<a.length;c++)b.push(dm_Tools.convertColumnsTreeIntoArray(a[c]))}else a&&a.name?b=a.name:a&&a.children&&(b=dm_Tools.convertColumnsTreeIntoArray(a.children));else b=Number(null);return b},dm_Tools.removeNodeProps=function(a,b){for(var c in a)b.indexOf(c)<0&&delete a[c]},dm_Tools.removeNodesProps=function(a,b,c){if(a&&(b.indexOf(a.name)>=0&&dm_Tools.removeNodeProps(a,c),a.children))for(var d,e=0;e<a.children.length;e++)d=a.children[e],dm_Tools.removeNodesProps(d,b,c)},dm_Tools.equalsOrRexgexpMatch=function(a,b,c){return dm_ServerTools.equalsOrRexgexpMatch(a,b,c)},dm_Tools.equalsOrRexgexpMatchInList=function(a,b,c){for(var d=!1,e=0;!d&&e<b.length;e++)d=dm_Tools.equalsOrRexgexpMatch(b[e],a,c);return d},dm_Tools.alignChildrenArrayIndex=function(a,b){if(a&&a.children&&a.children.length>0)for(var c,d=0;d<a.children.length;d++)c=a.children[d],b?(c.rawNode||(c.rawNode={}),c.rawNode["array index"]=d):c.rawNode&&c.rawNode.hasOwnProperty("array index")&&(c.rawNode["array index"]=d)},dm_Tools.sortChildrenByPos=function(a,b){if(a&&a.children&&a.children.length>0){for(var c,d,e,f,g=a.x,h=a.y,i=a.children.length-1,j=[];i>=0;i--)c=a.children[i],d=c.x-g,e=-(c.y-h),f=Math.PI/2-Math.atan(e/d)+(0>d?Math.PI:0),j.push({elt:c,ang:f});j.sort(function(a,b){return a.ang==b.ang?0:a.ang>b.ang?1:-1}),a.children=[];for(var k=0;k<j.length;k++)c=j[k].elt,a.children.push(c);dm_Tools.alignChildrenArrayIndex(a,b)}},dm_Tools.isEltEqualsSelector=function(a,b){return"#"==b[0]?$(a).attr("id")==b.substring(1):"."==b[0]?$(a).hasClass(b.substring(1).toLowerCase()):a.nodeName.toUpperCase()==b.toUpperCase()},dm_Tools.isEqualOrParents=function(a,b){var c=dm_Tools.isEltEqualsSelector(a,b),d=$(a).parent()[0];return!c&&d&&(c=dm_Tools.isEqualOrParents(d,b)),c},dm_Tools.isEventCoordsIn=function(a,b){var c=!1;if(b){var d=b.getBoundingClientRect();c=a.pageX>=d.left&&a.pageX<=d.left+d.width&&a.pageY>=d.top&&a.pageY<=d.top+d.height}return c},dm_Tools.visitObj=function(a,b,c){if(a){var d=[],e={},f={},g={},h={},i=null,j=null,k=null,l=function(a,c,i,j){var k=null,l=null,m={obj:a};a&&"object"==typeof a&&(a.__dm_uniqueId&&(k=e[a.__dm_uniqueId],k||(l=a.__dm_uniqueId,f[l]=a)),k||(a.__dm_uniqueId?m.id2use={}.dm_uniqueId:m.id2use=a.dm_uniqueId,h[a.dm_uniqueId]=m.id2use,l&&(g[m.id2use]=l),e[a.dm_uniqueId]=a,d.push(m)));b(m,c,i,j,k,l,f,g,h)};for(l(a);d.length>0;)if(i=d.pop(),a=i.obj,dm_Tools.isArray(a))for(k=a.length-1;k>=0;k--)l(a[k],i,null,k);else for(j in a)"dm_uniqueId"==j||"__dm_uniqueId"==j||dm_Tools.isInAvoidProps(j,c)||l(a[j],i,j)}},dm_Tools.cloneObj_deprecated=function(a,b,c,d){console.log("================================================ CLONEOBJ start ================================================"+dm_Tools.getDelay());var e,f={},g={};return dm_Tools.visitObj(a,function(a,b,d,h,i,j,k,l,m){if(i){if(b&&b.clone)if(c){var n=a.obj.dm_uniqueId,o=m[n],p=g[o].dm_uniqueId,q=b.clone,r="$ref_"+p;q&&(d&&(q[d]=r),null!==h&&void 0!=h&&(q[h]=r))}else{var n=a.obj.dm_uniqueId,o=m[n],q=b.clone,r=g[o];q&&(d&&(q[d]=r),null!==h&&void 0!=h&&(q[h]=r))}}else{var s=a.obj;if(null!=s&&(dm_Tools.isArray(s)?a.clone=[]:"object"==typeof s?a.clone={}:a.clone=s,g[a.id2use]=a.clone),null!=j&&(f[j]=a.clone),b){var q=b.clone;q&&(d&&(q[d]=a.clone),null!==h&&void 0!=h&&(q[h]=a.clone))}else e=a.clone}},b),dm_Tools.visitObj(e,function(a,b,c,e,g,h,i,j,k){var l=a.obj;if(null!=l&&"string"==typeof l&&0==l.indexOf("$ref_")){var m=l.substring("$ref_".length),n=i[m]||f[m];if(n){var o,p=b.obj;p&&(o=d?n:"$ref_"+n.dm_uniqueId,c&&(p[c]=o),null!==e&&void 0!=e&&(p[e]=o))}}}),console.log("================================================ CLONEOBJ end ================================================"+dm_Tools.getDelay()),e},dm_Tools.rebuildCircularRefs=function(a){var b={};dm_Tools.visitObj(a,function(a,c,d,e,f,g,h,i,j){a.obj&&a.obj.__dm_uniqueId&&(b[a.obj.__dm_uniqueId]=a.obj)}),dm_Tools.visitObj(a,function(a,c,d,e,f,g,h,i,j){var k=a.obj;if(null!=k&&"string"==typeof k&&0==k.indexOf("$ref_")){var l=b[k.substring("$ref_".length)];if(l&&(c.obj[d]=l),l){var m=c.obj;m&&(d&&(m[d]=l),null!==e&&void 0!=e&&(m[e]=l))}}})},dm_Tools.areObjEqual=function(a,b){var c=dm_Tools.clone(a,"__dm_uniqueId"),d=dm_Tools.clone(b,"__dm_uniqueId"),e=JSON.stringify(c),f=JSON.stringify(d),g=e==f;return g},dm_Tools.replaceNodePathConnections=function(a,b,c){var d=function(a,b,c){if(a&&dm_Tools.isArray(a))for(var d,e=a.length-1;e>=0;e--)if(d=a[e],d.nodePath&&""!=d.nodePath&&0==d.nodePath.indexOf(b)){var f="";d.nodePath.length>b.length&&(f=d.nodePath.substring(b.length)),d.nodePath=c+f}};dm_Tools.scanNodes(a,function(a){a.rawNode&&(a.rawNode.connectedTo&&d(a.rawNode.connectedTo,b,c),a.rawNode.connectedFrom&&d(a.rawNode.connectedFrom,b,c))})},dm_Tools.isChildAccordingToUniqueId=function(a,b){var c;if(b&&a&&a.children)for(var d,e=a.children.length-1;e>=0&&!c;e--)d=a.children[e],d&&d.dm_uniqueId==b.dm_uniqueId&&(c=e);return c},dm_Tools.alignConfigTreeToColumnsNumber=function(a,b,c){for(var d=function(a,c,d,e){var f=dm_Tools.clone(dm_Tools.defaultConfigFile[a]);if(f){var g=f[d];e&&(g=f[f.length-1]);var h=dm_Tools.clone(g,["dm_uniqueId","__dm_uniqueId","children","name"]);for(var i in h)"dm_uniqueId"!=i&&"__dm_uniqueId"!=i&&i.indexOf(".dm_props")<0&&(!b&&null!=c.rawNode[i]||null==h[i]||(c.rawNode[i]=h[i],!c.rawNode[i+".dm_props"]&&h[i+".dm_props"]&&(c.rawNode[i+".dm_props"]=h[i+".dm_props"])));c.rawNode["array index"]=d,c.rawNode.level=d}},e=function(a,c,e,g){var h=dm_Tools.getChild(a,c);if(h){h.children||(h.children=[]);var i,j,k=h.children.length;for(b&&(k=0);e>k;k++)i=k<h.children.length?h.children[k]:dm_Datamap.createNode(h,0==k?"root":"level "+k),j=k==e-1,d(c,i,k,j),g&&g(i,k,j);for(;h.children.length>e;)h.children.splice(h.children.length-1,1);for(var l=dm_Tools.clone(dm_Tools.defaultConfigFile[c]),k=0;k<h.children.length;k++){var m=l[k];k==h.children.length-1&&(m=l[l.length-1]),h.children[k].name=m.name||"level "+k}}else h=dm_Datamap.createNode(f,c)},f=a;f.parent;)f=f.parent;var g,h=dm_Tools.getChild(f,"columns");h&&h.children&&(g=h.children.length+1),g||(g=f.maxMapDepth),g&&(c?e(f,c,g):(e(f,"displayProps",g),e(f,"styles",g)))},dm_Tools.alignConfig2depth=function(a,b,c){if(a[b].length>c)a[b].splice(c-1,a[b].length-c);else if(c<dm_Tools.defaultConfigFile.length){var d=dm_Tools.clone(dm_Tools.defaultConfigFile);d.splice(c,d.length-c),d.splice(0,a[b].length),a[b]=a[b].concat(d)}},dm_Tools.alignConfig2columnsNumber=function(a,b){var c=a.columns.length+1;dm_Tools.alignConfig2depth(a,b,c)},dm_Tools.formatCodeStr=function(a){for(var b,c="",d=a.split("\n"),e=0;e<d.length;e++)b=d[e],c+="	"+e+"	"+b+"\n";return c},dm_Tools.removeAggregateProps=function(a,b){if(a){if(a.rawNode)for(var c,d=b.length-1;d>=0;d--)c=b[d].name,delete a.rawNode[c];if(a.children)for(var e,d=a.children.length-1;d>=0;d--)e=a.children[d],dm_Tools.removeAggregateProps(e,b)}},dm_Tools.removeNullNodes=function(a){if(a&&a.children)for(var b,c=a.children.length-1;c>=0;c--)b=a.children[c],b?dm_Tools.removeNullNodes(b):(console.log('Warning node : "'+dm_Tools.getNodeUrl(a,!1)+'" had a null child at index : '+c),a.children.splice(c,1))},dm_Tools.replaceByProperties=function(a,b){for(var c,d,b=b,e=b.indexOf("#replaceMeBy_");e>=0;)c=b.indexOf("#",e+1),d=b.substring(e+"#replaceMeBy_".length,c),b=""+b.substring(0,e)+a.rawNode[d]+b.substring(c+1),e=b.indexOf("#replaceMeBy_");return b},dm_Tools.getAllNumericOrTextProperties=function(a,b){var c,d,e,f,g=b,h=dm_Tools.getConfig(a),i={};if(h&&h.displayProps)for(var j=0;j<h.displayProps.length;j++)if(c=h.displayProps[j],c&&c.children){i[j]={};for(var k=0;k<c.children.length;k++)e=c.children[k],e&&"text"!=e.type&&"slider"!=e.type&&(i[j][e.name]=!0)}return dm_Tools.scanNodes(a,function(a){if(a.rawNode)for(var b in a.rawNode)(""+b).indexOf(".dm_props")<0&&0!=(""+b).indexOf("dm_")&&(!a.rawNode[b+".dm_props"]||"slider"==a.rawNode[b+".dm_props"].type||"text"==a.rawNode[b+".dm_props"].type)&&(d=!0,null!==a.level&&i[a.level]&&i[a.level][b]&&(d=!1),d&&(f=a.rawNode[b],null!==f&&(g||(g=[]),g.indexOf(b)<0&&g.push(b))))}),g},dm_Tools.feedPossibleProperties=function(a,b){for(var c=b,d=a;d.parent;)d=d.parent;var e=function(a){var b=dm_Tools.getChild(d,a);if(b&&b.children)for(var e,f=0;f<b.children.length;f++)e=b.children[f],c||(c=[]),c.indexOf(e.name)<0&&c.push(e.name)};console.log("feed possible properties start "+dm_Tools.getDelay("feedPossibleProperties")),e("aggregate"),console.log("feed possible properties after aggregate "+dm_Tools.getDelay("feedPossibleProperties")),e("columnNames"),console.log("feed possible properties after columnNames "+dm_Tools.getDelay("feedPossibleProperties"));var f=dm_Datamap.maps[d.rawNode.dm_DatamapName];return f&&dm_Tools.getAllNumericOrTextProperties(f.root,c),console.log("feed possible properties after numeric or text "+dm_Tools.getDelay("feedPossibleProperties")),c},dm_Tools.getDisplayPropsNames=function(a,b){var c=b||[],d=dm_Tools.configConfigGetDPRoot(a);if(d.children)for(var e,f=0;f<d.children.length;f++)if(e=d.children[f],e&&e.children)for(var g,h=0;h<e.children.length;h++)g=e.children[h],c.indexOf(g.name)<0&&c.push(g.name);return c},dm_Tools.getFirstDisplayProp=function(a,b){for(var c,d=a;d.parent;)d=d.parent;var e=dm_Tools.getChild(d,"displayProps");if(e.children)for(var f,g=0;!c&&g<e.children.length;g++)if(f=e.children[g],f&&f.children)for(var h,i=0;!c&&i<f.children.length;i++)h=f.children[i],h.name==b&&(c=h);return c},dm_Tools.copyRawNodeProps2ValueDmProps=function(a,b,c){b.rawNode["value.dm_props"]||(b.rawNode["value.dm_props"]={});for(var d in a.rawNode)(""+d).indexOf(".dm_props")<0&&"dm_uniqueId"!=d&&"__dm_uniqueId"!=d&&"array index"!=d&&"parent"!=d&&"children"!=d&&"visible"!=d&&"edit"!=d&&"label"!=d&&"order"!=d&&"value"!=d&&"loadPropsFromGdParent"!=d&&(b.rawNode["value.dm_props"][d]=a.rawNode[d],c&&"type"!=d&&delete a.rawNode[d]);b.rawNode["value.dm_props"].visible=!0,b.rawNode["value.dm_props"].edit=!0,b.rawNode["value.dm_props"].displayEvenIfUndefined=!0},dm_Tools.configConfigPrepareEltProps=function(a){var b=dm_Tools.configConfigGetDPRoot(a),c=dm_Tools.getFirstDisplayProp(b,a.rawNode.propertyAddName);c?(a.rawNode.visible=c.rawNode.visible,a.rawNode.edit=c.rawNode.edit,a.rawNode.label=c.rawNode.label,a.rawNode.type=c.rawNode.type,a.rawNode.value=c.rawNode.value,a.rawNode["value.dm_props"]={},dm_Tools.copyRawNodeProps2ValueDmProps(c,a),a.rawNode["value.dm_props"].order=150):(null==a.rawNode.visible&&(a.rawNode.visible=!0),null==a.rawNode.edit&&(a.rawNode.edit=!1),null==a.rawNode.label&&(a.rawNode.label=a.rawNode.propertyAddName),null==a.rawNode.type&&(a.rawNode.type="text"),a.rawNode["value.dm_props"]={label:"Value",order:150,visible:!0,edit:!0,type:a.rawNode.type,displayEvenIfUndefined:!0})},dm_Tools.changeDPLevelProps=function(a){var b=dm_Tools.getChild(a,"displayProps");if(b)for(var c,d=0;d<b.children.length;d++)c=b.children[d],c.rawNode.lvl_edit=c.rawNode.edit,c.rawNode.lvl_visible=c.rawNode.visible,delete c.rawNode.edit,delete c.rawNode.visible},dm_Tools.configConfigIsDPRootOrLevelOrDP=function(a){if(a){if("displayProps"==a.name)return"displayProps";if(a.parent&&"displayProps"==a.parent.name)return"dpLevel";if(a.parent&&a.parent.parent&&"displayProps"==a.parent.name)return"dp"}},dm_Tools.configConfigGetDPRoot=function(a){for(var b=a;b.parent;)b=b.parent;var c=dm_Tools.getChild(b,"displayProps");return c},dm_Tools.copyPropsFromOrderRange=function(a,b,c,d,e,f,g){for(var h in a.rawNode){var i,j;if(h.indexOf(".dm_props")>=0?(i=h,j=!0):(i=h+".dm_props",j=!1),(!f||!j)&&a.rawNode&&a.rawNode[i]){var k=a.rawNode[i].order;k>=b&&c>=k&&(d.rawNode||(d.rawNode={}),(e||null==d.rawNode[h]||g&&j)&&(d.rawNode[h]=dm_Tools.clone(a.rawNode[h])))}}},dm_Tools.deletePropsFromOrderRange=function(a,b,c){for(var d in a.rawNode){var e,f;d.indexOf(".dm_props")>=0?(e=d,f=!0):(e=d+".dm_props",f=!1);var g=a.rawNode[e].order;!f&&g>=b&&c>=g&&delete a.rawNode[d]}},dm_Tools.copyProps=function(a,b,c){var d=function(c){b[c]=dm_Tools.clone(a[c])};for(var e in a)c?"string"==typeof c?e!==c&&d(e):dm_Tools.isArray(c)?c.indexOf(e)<0&&d(e):d(e):d(e)},dm_Tools.scanNodes=function(a,b,c){for(var d,e,f,g={},h=[a];!e&&h.length>0;)if(d=h.pop(),void 0===g[d.dm_uniqueId]){if(e=b(d),f=!1,e&&e.skipChildrenOnly&&(e=null,f=!0),!e&&!f&&d){var i=d.children;if(c&&(i=dm_Tools.getNonReducedChildren(d)),i)for(var j=0;j<i.length;j++)h.push(i[j])}g[d.dm_uniqueId]=null}},dm_Tools.digNodes=function(a,b,c){var d;if(b&&(d=b(a)),!d&&a.children)for(var e=0;!d&&e<a.children.length;e++)d=dm_Tools.digNodes(a.children[e],b,c);return c&&(d=c(a)),d},dm_Tools.removeRawNodeProps=function(a,b){dm_Tools.scanNodes(a,function(a){if(a&&a.rawNode)if(dm_Tools.isArray())for(var c=b.length-1;c>=0;c--)delete a.rawNode[b[c]];else delete a.rawNode[b]})},dm_Tools.addIfNotSameName=function(a,b){if(b){for(var c,d=a.length-1;d>=0;d--)if(c=a[d],c&&c.name==b.name)return;a.push(b)}},dm_Tools.maxNumberOfChildren=20,dm_Tools.desiredNumberOfChildren=15,dm_Tools.groupNbCarMaxNameStartOrEnd=10,dm_Tools.reduceNumberOfChildren=function(a){if(!dm_Datamap.lastNodeNotInConfigurationMode){var b=function(a){return a.dm_reduceChildrenWeight=dm_Tools.countNodes(a),a.dm_reduceChildrenWeight};dm_Tools.scanNodes(a,function(a){if(a.children&&a.children.length>dm_Tools.maxNumberOfChildren&&(!a.rawNode||!a.rawNode.dontReduceNumberOfChildren)){for(var c,d={},e=a.children.length-1;e>=0;e--)c=a.children[e],(void 0===c.level||null===c.level)&&(c.level=dm_Tools.getLevel(c)),d[c.level]||(d[c.level]=[]),d[c.level].push(c);var f;for(var g in d)if(f=d[g],f.length>dm_Tools.maxNumberOfChildren){for(var h=f.length-1,i=0;h>=0;h--)i+=b(f[h]);f.sort(function(a,b){return a.name==b.name?0:a.name<b.name?1:-1});for(var j,k={},l=i/dm_Tools.desiredNumberOfChildren,m=0,n=0,h=0;h<f.length;h++)j=f[h],n>l&&(m++,i-=n,l=i/(dm_Tools.desiredNumberOfChildren-m),n=0),k[m]||(k[m]=[]),k[m].push(j),n+=j.dm_reduceChildrenWeight,delete j.dm_reduceChildrenWeight;var o,p,q,r;for(var s in k)if(o=k[s],o.length>1){var t="";o[o.length-1]&&(t=o[o.length-1].name||t);var u="";o[0]&&(u=o[0].name||u),p={},p.name=(""+t).substring(0,dm_Tools.groupNbCarMaxNameStartOrEnd)+"..."+(""+u).substring(0,dm_Tools.groupNbCarMaxNameStartOrEnd);var v=a.children.indexOf(o[0]);v>=0&&a.children.splice(v,1,p),p.children=o,p.level=o[0].level,p.dm_isReducedNode=!0;for(var w=0;w<o.length;w++)q=o[w],q.parent=p,r=a.children.indexOf(q),r>=0&&a.children.splice(r,1),p.rawNode&&!p.rawNode.icon&&q.rawNode&&q.rawNode.icon&&(p.rawNode.icon=q.rawNode.icon,p.rawNode["icon.dm_props"]=q.rawNode["icon.dm_props"])}}}})}},dm_Tools.getNonReducedChildren=function(a,b,c,d,e){var f,g,e=e||[];if(g=d?dm_Tools.getAbsoluteLevel(a,"dontCountReduced"):dm_Tools.bestEffortLevel(a),0>b?e.push(a):b>=g&&(0==g||g!=b&&!c||e.push(a)),a&&a.children)for(var h=0;h<a.children.length;h++)f=a.children[h],f.dm_isReducedNode||b>g||0>b?dm_Tools.getNonReducedChildren(f,b,c,d,e):e.push(f);return e},dm_Tools.detectCsvSeparator=function(a){var b=!1,c=(a.match(/,/g)||[]).length,d=(a.match(/;/g)||[]).length;return d>c&&(b=!0),b},dm_Tools.cleanUpD3StufInNodes=function(a){dm_Tools.scanNodes(a,function(a){delete a.x,delete a.y,delete a.px,delete a.py,delete a.weight,delete a.fixed,delete a.index})},dm_Tools.cleanUpRemovePropsAtSave=function(a,b){dm_Tools.scanNodes(a,function(a){var c,d,e;for(var f in a.rawNode){if(c=!1,b)for(var g=0;!c&&g<b.length;g++)d=b[g],c=d==f,c||(e=d.indexOf("*"),e>0&&(d=d.substring(0,e),c=d==f.substring(0,Math.min(f.length,d.length))));c||f.indexOf(".dm_props")>0&&a.rawNode[f].removeAtSave||a.rawNode[f+".dm_props"]&&a.rawNode[f+".dm_props"].removeAtSave?(delete a.rawNode[f],f.indexOf(".dm_props")>0?delete a.rawNode[f.split(".dm_props")[0]]:delete a.rawNode[f+".dm_props"]):(f.indexOf(".dm_props")>0&&a.rawNode[f].removeDmPropsAtSave||a.rawNode[f+".dm_props"]&&a.rawNode[f+".dm_props"].removeDmPropsAtSave)&&(f.indexOf(".dm_props")>0?delete a.rawNode[f]:delete a.rawNode[f+".dm_props"])}})},dm_Tools.cleanUpAggregateToExecute=function(a){if(a.aggregate)for(var b,c=0;c<a.aggregate.length;c++)b=a.aggregate[c],delete b.toExecute},dm_Tools.alignDmNodesToTree=function(a){var b=dm_Tools.getParentNode4Config(a),c=dm_Datamap.maps[b.dm_DatamapName];c&&(c.nodes=dm_Tools.getNodesFromRoot(b)),b.parent&&dm_Tools.alignDmNodesToTree(b.parent)},dm_Tools.loadCssPalette=function(){for(var a,b=[".color-secondary-2-",".color-secondary-1-",".color-complement-",".color-primary-"],c=[],d=function(a){var b=dm_BeforeAll.getStyleSheetRule("palette_color",a),c=b.color,d=dm_Tools.rgbParse(c);return dm_Tools.rgb2hex(d)},e=0;4>e;e++)a=b[e],c.push(d(a+0));for(var e=0;4>e;e++)a=b[e],c.push(d(a+4));for(var e=0;4>e;e++)a=b[e],c.push(d(a+2));for(var e=0;4>e;e++)a=b[e],c.push(d(a+3));c=c.concat(c).concat(c),dm_Tools.colors2=c,dm_Tools.colorsRGB2=[];for(var e=0;e<dm_Tools.colors.length;e++){var f=dm_Tools.colors[e],g=dm_Tools.color2rgb(f);dm_Tools.colorsRGB2.push(g)}},dm_Tools.createColorPalette=function(){var a=["#ca9e69","#466b81","#ca7969","#4c9266","#894c00","#053957","#891800","#006425","#eccfac","#708896","#ecb7ac","#7dab8e","#a8712e","#22506b","#a8432e","#217a42","#ca9e69","#466b81","#ca7969","#4c9266","#894c00","#053957","#891800","#006425","#eccfac","#708896","#ecb7ac","#7dab8e","#a8712e","#22506b","#a8432e","#217a42","#ca9e69","#466b81","#ca7969","#4c9266","#894c00","#053957","#891800","#006425","#eccfac","#708896","#ecb7ac","#7dab8e","#a8712e","#22506b","#a8432e","#217a42"];a=a.concat(a).concat(a),dm_Tools.colors2=a,dm_Tools.colorsRGB2=[];for(var b=0;b<dm_Tools.colors.length;b++){var c=dm_Tools.colors[b],d=dm_Tools.color2rgb(c);dm_Tools.colorsRGB2.push(d)}},dm_Tools.removeDirectoryPartOfFilename=function(a){var b=a,c=a.lastIndexOf("/");return c>=0&&(b=a.substring(c+1)),b},dm_Tools.decodeNonUTF84JsZip=function(a,b,c){var d=new FileReader,e=new Blob([a]);d.onload=function(a){c(null,a.target.result)},d.onerror=function(a){c(a.error,null)},d.readAsText(e,b)},dm_Tools.reduceDotDotDirectoryPath=function(a){
for(var b,c="",d=a.split("/"),e=[],f=d.length-1;f>=0;f--){b=d[f];for(var g=0;f>=0&&".."==b;)e.push(f),g++,f--,b=d[f];for(;f>=0&&g>0;)e.push(f),g--,g>0&&f--}var h;for(e.reverse();e.length>0;)h=e.pop(),d.splice(h,1);for(var f=0;f<d.length;f++)b=d[f],c+=(f>0?"/":"")+b;return c},dm_Tools.cleanUpConfigBeforeSave=function(a){if(null!==a&&"object"==typeof a){var b,c;for(var d in a)d=""+d,c=d.indexOf(".dm_props"),c>0&&c==d.length-".dm_props".length&&(d=d.substring(0,d.length-".dm_props".length)),b=a[d+".dm_props"],b&&!b.dontDeleteWhenCleanUpConfig&&(!b||"action"!=b.type&&"rich text"!=b.type&&"execute"!=b.type&&"music"!=b.type||delete a[d],delete a[d+".dm_props"]),dm_Tools.cleanUpConfigBeforeSave(a[d]);for(var d in a)a[d+".dm_props"]&&delete a[d+".dm_props"].dontDeleteWhenCleanUpConfig}},dm_Tools.cleanUpConfigTreeAfterAdminMode=function(a){var b,c,d,e=dm_Tools.getChild(a,"displayProps");if(e&&e.children)for(var f=0;f<e.children.length;f++)if(b=e.children[f],dm_Tools.removeNodeProps(b.rawNode,["dm_uniqueId","__dm_uniqueId","lvl_edit","lvl_visible","edit","visible","displayName"]),void 0!==b.rawNode.lvl_edit?b.rawNode.edit=b.rawNode.lvl_edit:delete b.rawNode.edit,delete b.rawNode.lvl_edit,void 0!==b.rawNode.lvl_visible?b.rawNode.visible=b.rawNode.lvl_visible:delete b.rawNode.visible,delete b.rawNode.lvl_visible,b.children)for(var g=0;g<b.children.length;g++)if(c=b.children[g],c.rawNode&&(d=c.rawNode["value.dm_props"]))for(var h in d)"dm_uniqueId"!=h&&"__dm_uniqueId"!=h&&"edit"!=h&&"visible"!=h&&"order"!=h&&"displayEvenIfUndefined"!=h&&"name"!=h&&"label"!=h&&(c.rawNode[h]=c.rawNode["value.dm_props"][h]);var i,j=dm_Tools.getChild(a,"styles");if(j&&j.children)for(var f=0;f<j.children.length;f++)i=j.children[f],i.rawNode&&i.rawNode.icon&&i.rawNode["icon.dm_props"]&&(i.rawNode["icon.dm_props"].dontDeleteWhenCleanUpConfig=!0),i.rawNode&&i.rawNode.backgroundImage&&i.rawNode["backgroundImage.dm_props"]&&(i.rawNode["backgroundImage.dm_props"].dontDeleteWhenCleanUpConfig=!0);var k,l=dm_Tools.getChild(a,"aggregate");if(l&&l.children)for(var f=0;f<l.children.length;f++)k=l.children[f],k.rawNode&&delete k.rawNode.toExecute;var m,n=dm_Tools.getChild(a,"specifics"),o=function(a){for(var b in a)(""+b).indexOf(".dm_props")>0&&(a[b].dontDeleteWhenCleanUpConfig=!0)};if(n&&n.children)for(var f=0;f<n.children.length;f++)m=n.children[f],m.children&&(n.children[f].rawNode=m.children[0].rawNode,delete n.children[f].children),m=n.children[f],o(m),o(m.rawNode)},dm_Tools.getChildFromNumber=function(a,b,c){var d;if(a&&a.children&&a.children.length>0&&null!==b&&"number"==typeof b)for(var e,f,g,h,i=0;!d&&i<a.children.length;i++){e=a.children[i],f=e.name;try{f=f.split(c),g=(""+f[0]).trim(),h=(""+f[1]).trim(),g=parseFloat(g),h=parseFloat(h),b>=g&&h>b&&(d=e)}catch(j){}}return d},dm_Tools.splitWithoutGoingIntoStrings=function(a,b){for(var c,d,e,f,g,h=[],a=""+a,i="",j=function(b,d){h.push(b),d&&(a=""),i="",c=null};a.length>0;)d=a.indexOf(b),0>d?j(i+a,!0):(f=a.indexOf('"'),g=a.indexOf("'"),e='"'==c?f:"'"==c?g:0>f&&g>=0?g:0>g&&f>=0?f:Math.min(f,g),null!=c&&0>e?j(i+a,!0):!c&&(0>e||e>d)?(j(i+a.substring(0,d)),a=a.substring(d+b.length)):(c=c?null:e==f?'"':"'",i+=a.substring(0,e+1),a=a.substring(e+1)));return i&&j(i),h},dm_Tools.visitHtml=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=[];for(a=a.trim();(""+a).length>0;)if(c=a.indexOf("<"),e=o.length>0?o[o.length-1]:null,0>c)b(o,a),a="";else{if(c>0&&b(o,a.substring(0,c)),h="/"==a[c+1],d=a.indexOf(">",c),g=d+1,h)e&&(e.isClosing=!0),b(o),o.pop();else{i="/"==a[d-1],i&&d--,j=dm_Tools.splitWithoutGoingIntoStrings(a.substring(c+1,d)," "),f={tagName:j[0]},"br"==j[0]&&1==j.length&&(i=!0);for(var p=1;p<j.length;p++)k=j[p].split("="),l=k[0],m=null,k.length>1&&(m=k[1],m.length>2&&("'"==m[0]&&"'"==m[m.length-1]||'"'==m[0]&&'"'==m[m.length-1])&&(m=m.substr(1,m.length-2))),f[l]=m;o.push(f),i?(n=o.length>0?o[o.length-1]:null,n.openingAndClosing=!0,b(o),o.pop()):b(o)}a=a.substring(g)}},dm_Tools.removeSubMaps=function(a,b){var c=b,d=!1;if(c||(d=!0,c={}),d||null==a.dm_DatamapName&&null==a.dm_config||a.rawNode&&a.rawNode.dm_parentAggregateTraverseSubMaps){if(a.children)for(var e=0;e<a.children.length;e++)dm_Tools.removeSubMaps(a.children[e],c)}else a.children&&(c[a.dm_uniqueId]=a.children,a.children=null);return c},dm_Tools.restoreChildrenOfSubMaps=function(a,b){Object.keys(b).length>0&&dm_Tools.scanNodes(a,function(a){if(a){var c=b[a.dm_uniqueId];if(c){a.children=c;for(var d=0;d<a.children.length;d++)a.children[d]&&(a.children[d].parent=a);return{skipChildrenOnly:!0}}}})},dm_Tools.prettyDisplayNameFromColumn=function(a,b,c){var c=c||4,b=b||dm_Tools.getConfig(a);dm_Tools.scanNodes(a,function(a){a.rawNode||(a.rawNode={}),a.rawNode.dm_columnName&&!b.noColNameInShortDisplayName&&(b.emptyFieldsAsNodes&&a.name==b.emptyFieldsAsNodes||(""+a.name).length<=c||!dm_Tools.fastIsNaN(dm_Tools.parseNumber(""+a.name)))&&(a.rawNode.displayName=a.rawNode.dm_columnName+": "+a.name)})},dm_Tools.cloneAndConvert2strCircularRefs=function(a,b,c,d,e,f){var g={key:null},h=[{obj:a,parent:null,key:"key",clonedParent:g,parents:[]}],c=c||{oldIds:{}};c.oldIds||(c.oldIds={});var d=d||{oldObjs:{}};d.oldObjs||(d.oldObjs={}),e&&!e.existingRefs&&(e.existingRefs=[]);for(var i,j,k,l,m,n;h.length>0;)if(i=h.pop(),j=i.obj,f&&(j=f(j,i.parent,i.key,i.parents)),null===j||"object"!=typeof j)i.clonedParent[i.key]=j,e&&null!=j&&"string"==typeof j&&0==j.indexOf("$ref_")&&e.existingRefs.push({parentObj:i.clonedParent,key:i.key,refId:j.substring("$ref_".length)});else{void 0!=j.__dm_uniqueId&&j.__dm_uniqueId>dm_tools_NameIdList.idCounter&&(dm_tools_NameIdList.idCounter=j.__dm_uniqueId),l=!1;var o=c.oldIds[j.dm_uniqueId];if(o&&(l=!0,i.clonedParent[i.key]="$ref_"+o.dm_uniqueId),!l){m=j.constructor()||{},i.clonedParent[i.key]=m,d.oldObjs[m.dm_uniqueId]=j,c.oldIds[j.dm_uniqueId]=m;for(var p in j)"__dm_uniqueId"!=p&&!dm_Tools.isInAvoidProps(p,b)&&Object.prototype.hasOwnProperty.call(j,p)&&(k=j[p],f&&(n=i.parents.slice(0),n.push(j)),h.push({obj:k,parent:j,key:p,clonedParent:m,parents:n}))}}return g.key},dm_Tools.clone=function(a,b){if(null===a||void 0===a)return a;var c=JSON.parse(dm_Tools.stringify(a,b));return c},dm_Tools.clone_deprecated=function(a,b,c,d,e,f){var g={},f=f||{},h={},i=dm_Tools.cloneAndConvert2strCircularRefs(a,b,g,f,h,c);if(h.existingRefs)for(var j,k,l=h.existingRefs.length-1;l>=0;l--)j=h.existingRefs[l],k=g.oldIds[j.refId],k&&(d?j.parentObj[j.key]=k:j.parentObj[j.key]="$ref_"+k.dm_uniqueId);if(e)for(var m in g.oldIds)g.oldIds[m].__dm_uniqueId=m;return i},dm_Tools.cleanUpConnectionBeforeJsonSave=function(a){dm_Tools.scanNodes(a,function(a){a.rawNode&&(delete a.rawNode.aggregatedConnectedTo,delete a.rawNode.aggregatedConnectedFrom,a.rawNode.connectedTo&&a.rawNode.connectedTo.connectNodeUniqueId&&typeof a.rawNode.connectedTo.connectNodeUniqueId===object&&(a.rawNode.connectedTo.connectNodeUniqueId="$ref_"+a.rawNode.connectedTo.connectNodeUniqueId.dm_uniqueId))})},dm_Tools.copyUniqueId=function(a){dm_Tools.scanNodes(a,function(a){a.dm_tmpUniqueId4aggreg=a.dm_uniqueId})},dm_Tools.replaceTmpUniqueId=function(a){dm_Tools.scanNodes(a,function(a){a.__dm_uniqueId=a.dm_tmpUniqueId4aggreg})},dm_Tools.generateReport=function(a,b,c){var d=dm_Tools.getConfig(a);dm_UI.openWorkInProgress(!0,function(){new dm_Odt(a,d,b,c).save(function(a){console.log("saveas operation"),saveAs(a,dm_IO.saveOdtFilename()),console.log("saveas finished"),dm_IO.onSaveComplete()})})},dm_Tools.feedDropDownAttribute=function(a,b,c){var d=d3.select("#attributesEdit-modal"),e="#attributeValue-"+dm_Tools.formatJSVarName(b),f=d.select(e),g=f.select("select");dm_Attributes.feedDropDown(g,c,a,a.rawNode[b+".dm_props"])},dm_Tools.getImageXYWH=function(a,b,c,d){var e=c/a,f=d/b,g=Math.max(e,f),h={x:0,y:0};h.w=a*g,h.h=b*g;var i=0,j=0;return h.w>c&&(i=h.w-c,h.x=Math.ceil(i/2/g)),h.h>d&&(j=h.h-d,h.y=Math.ceil(j/2/g)),h.w=Math.round(h.w/g),h.h=Math.round(h.h/g),h},dm_Tools.stringsDistance=function(a,b,c){var d=function(a,b,c){if(!a||!a.length)return b?b.length:0;if(!b||!b.length)return a.length;for(var d=a.length,e=b.length,c=c||Math.min(d,e),f=0,g=0,h=0,i=0;d>f&&e>g;){if(a.charAt(f)==b.charAt(g))i++;else{h+=i,i=0,f!=g&&(f=g=Math.max(f,g));for(var j=0;c>j&&(d>f+j||e>g+j);j++){if(d>f+j&&a.charAt(f+j)==b.charAt(g)){f+=j,i++;break}if(e>g+j&&a.charAt(f)==b.charAt(g+j)){g+=j,i++;break}}}f++,g++}return h+=i,Math.round(Math.max(d,e)-h)};if(a==b)return 0;if(!a)return(""+b).length;if(!b)return(""+a).length;var a=""+a,b=""+b;return c&&(a=a.toLowerCase(),b=b.toLowerCase()),d(a,b)},dm_Tools.setDmProps=function(a,b,c){var d=JSON.parse(c);a.rawNode[b+".dm_props"]||(a.rawNode[b+".dm_props"]={});for(var e in d)a.rawNode[b+".dm_props"][e]=a.rawNode[b+".dm_props"][e]||d[e]},dm_Tools.scanNodesBacktrackCallback=function(a,b){if(a.children)for(var c,d=0;d<a.children.length;d++)c=a.children[d],dm_Tools.scanNodesBacktrackCallback(c,b);b&&b(a)},dm_Tools.addRawNode=function(a){dm_Tools.scanNodes(a,function(a){a.rawNode||(a.rawNode={})})},dm_Tools.executeAggregateProp=function(node,propName){for(var configNode=dm_Tools.getParentNode4Config(node),config=configNode[dm_Tools_dm_config_name],aggregates=config.aggregate,aggregate,aggrI,i=0;i<aggregates.length&&!aggregate;i++)aggrI=aggregates[i],aggrI.name==propName&&(aggregate=aggrI);var dm=dm_Datamap.maps[configNode.dm_DatamapName],nodes=dm.nodes,funcName=dm_Tools.formatJSVarName(propName)+"_aggrFnc",toExecute="var n ;\nfunction "+funcName+"(node, nodes, propName) { \n"+dm_Tools.indent(1)+"if(!node.rawNode) { node.rawNode = {} ; } \n"+dm_Tools.indent(1)+aggregate.value+"\n}\n\n";dm_Tools.scanNodesBacktrackCallback(node,function(a){toExecute+="n = nodes.listByUniqueId['"+a.dm_uniqueId+"'] ; // "+a.name+"\nif(n) { n.rawNode[propName] = "+funcName+"(n, nodes, propName) ; }\n"});try{eval(toExecute)}catch(error){console.log("ERROR during eval of aggregation !\n"+error.stack)}},dm_Tools.createCarouselFromChildren=function(a,b,c,d,e,f,g,h){var i=dm_Tools.getNonReducedChildren(a,b,c,e),j="",k="",l="";if(i){i=i.reverse();var f=f||"freeDatamapCarousel_"+a.dm_uniqueId;j+="<div id= '"+f+"' class='carousel slide' style='max-width: 670px; max-height: 379px;'>\n",k+="   <ol class='carousel-indicators' hidden>\n",l+="   <div class='carousel-inner'>\n";for(var m,n,o=0,p=0;p<i.length;p++)m=i[p],g&&m==a||h&&m.children||(m.rawNode&&m.rawNode[d]&&(k+="      <li data-target='#"+f+"' data-slide-to='"+o+"'"+(0==o?" class='active'":"")+"></li>\n",l+="      <div class='item"+(0==o?" active":"")+"'>\n",n=m.rawNode[d],l+=n.indexOf("data:image")<0&&"http"!=n.substring(0,4)?"         <img src='data/images/"+n+"' alt=''/>\n":"         <img src='"+n+"' alt=''/>\n",l+="      </div>\n"),o++);k+="   </ol>\n",l+="   </div>\n",j+=k,j+=l,j+="   <a class='left carousel-control' href='#"+f+"' data-slide='prev'>&lsaquo;</a>\n   <a class='right carousel-control' href='#"+f+"' data-slide='next'>&rsaquo;</a>\n</div>"}return j},dm_Tools.onPreEditRichText=function(a,b){a.rawNode[b.name+".dm_props"].type="text";var c=a.rawNode[b.name+".dm_props"].value||a.rawNode[b.name];a.rawNode[b.name]=c?c.replace(/<br\/>/g,"\n"):"",a.rawNode[b.name+".dm_props"].value=null,b.value=a.rawNode[b.name],b.type=a.rawNode[b.name+".dm_props"].type},dm_Tools.onPostChangeRichText=function(a,b,c,d){if(a.rawNode[b.name]||(a.rawNode[b.name]=a.rawNode[b.name+".dm_props"].value),"rich text"!=a.rawNode[b.name+".dm_props"].type){a.rawNode[b.name+".dm_props"].type="rich text";var e=a.rawNode[b.name+".dm_props"].value||a.rawNode[b.name];e?(a.rawNode[b.name+".dm_props"].value=e?e.replace(/\n/g,"<br/>"):"",a.rawNode[b.name]=c+a.rawNode[b.name+".dm_props"].value+d):a.rawNode[b.name]=""}b.value=a.rawNode[b.name],b.type=a.rawNode[b.name+".dm_props"].type},dm_Tools.forceAllOnPostChange=function(node){var prop;for(var p in node.rawNode)node.rawNode[p+".dm_props"]&&node.rawNode[p+".dm_props"].onPostChange&&(prop={name:p},eval(node.rawNode[p+".dm_props"].onPostChange))},dm_Tools.dmSeparator="##dm_separator##",dm_Tools.dmSeparator2="##dm_separator2##",dm_Tools.bigTree2refs=function(a,b,c,d){var e=b||{},c=c||{},f={};e[a.dm_uniqueId]=f;var g=["__dm_uniqueId"];if(d&&(g=g.concat(d)),c[a.dm_uniqueId]=dm_Tools.stringifyNodeWithFilterOnRootObjOnly(a,["parent","children"],g),a.children)for(var h=0;h<a.children.length;h++)dm_Tools.bigTree2refs(a.children[h],f,c,d);return{refTree:e,all:c}},dm_Tools.bigTree2str=function(a,b){var c=dm_Tools.bigTree2refs(a,null,null,b),d="";d+=JSON.stringify(c.refTree);for(var e in c.all)d+=dm_Tools.dmSeparator,d+=e+dm_Tools.dmSeparator2+c.all[e];return d},dm_Tools.rebuildBigTree=function(a,b,c){var d,c=c||{};for(var e in a)d=b[e],d.parent=c,c.children||(c.children=[]),c.children.push(d),dm_Tools.rebuildBigTree(a[e],b,d);return c},dm_Tools.parseBigTreeStr=function(a){for(var b,c=a.split(dm_Tools.dmSeparator),d=c[0],e=(c[1],JSON.parse(d)),f={},g=1;g<c.length;g++)b=c[g].split(dm_Tools.dmSeparator2),f[b[0]]=dm_Tools.parseStringified(b[1]);var h=dm_Tools.rebuildBigTree(e,f),i=h.children[0];return delete i.parent,i},dm_Tools.leafletMap,dm_Tools.leafletMap_tileLayer,dm_Tools.leafletMap_lastLayer,dm_Tools.leafletMap_d3_svg,dm_Tools.leafletMap_d3_svg_g,dm_Tools.leafletMap_zoom,dm_Tools.leafletMap_zoomFactor,dm_Tools.leafletMap_avoidDoubleReset,dm_Tools.geoPreprocessTable=function(a,b){for(var c,d=-1,e=-1,f=a[0].length,g=0;f>g;g++)c=a[0][g],("lat"==(""+c).toLowerCase()||"latitude"==(""+c).toLowerCase()||b&&b.latColName&&c==b.latColName)&&(d=g),("long"==(""+c).toLowerCase()||"lng"==(""+c).toLowerCase()||"longitude"==(""+c).toLowerCase()||b&&b.lngColName&&c==b.lngColName)&&(e=g);var h=!1;if(d>=0&&e>=0){h=!0,a[0].push("dm_geometry_type"),a[0].push("dm_geometry_coords");for(var g=1;g<a.length;g++)a[g][f]="Point",a[g][f+1]=[a[g][e],a[g][d]]}return h},dm_Tools.geoMapResize=function(){if(dm_Tools.leafletMap){var a=d3.select("#geoMap"),b=$(a[0][0]).closest("#graphArea"),c=b.width(),d=b.height();a.style("width",c+"px").style("height",d+"px"),dm_Tools.leafletMap.invalidateSize()}},dm_Tools.geoMapInitD3SvgG=function(){dm_Tools.leafletMap_d3_svg_g&&dm_Tools.leafletMap_d3_svg_g.remove(),dm_Tools.leafletMap_d3_svg_g=dm_Tools.leafletMap_d3_svg.append("g").attr("class","leaflet-zoom-hide")},dm_Tools.geoMapInitializeLeafletMap=function(a){if(a||!dm_Tools.leafletMap){dm_BootFreedatamap.loadScript("https://maps.googleapis.com/maps/api/js?key=AIzaSyBSq8d-DRL5Bz_gznrkN9IQvt87gON9Dyw&v=3.exp&signed_in=true&callback=dm_Tools.googleStreetViewInitialized",null,{async:null,defer:null,id:"GoogleStreetViewJavaScriptInclude"},"async");var b=d3.select("#geoMap"),c=$(b[0][0]).closest("#graphArea");b.style("visibility","visible");var d=$(b[0][0]).width(),e=$(b[0][0]).height();(0==d||0==e)&&b.style("width",c.width()+"px").style("height",c.height()+"px"),dm_Tools.leafletMap||(dm_Tools.leafletMap=L.map("geoMap",{zoomControl:!1})),dm_Tools.leafletMap_tileLayer=L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{maxZoom:18,minZoom:3,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',id:"freedatamap.012a63c5",accessToken:"pk.eyJ1IjoiZnJlZWRhdGFtYXAiLCJhIjoiNWFlNDNjODY2YjAyNzNmZTBmNmZmZGNmNGRkZDA3YWUifQ.3B4tSQMnl6Gu11xPLEZgYQ"}),dm_Tools.leafletMap_tileLayer.addTo(dm_Tools.leafletMap),L.TopoJSON=L.GeoJSON.extend({addData:function(a){if("Topology"===a.type)for(key in a.objects)geojson=topojson.feature(a,a.objects[key]),L.GeoJSON.prototype.addData.call(this,geojson);else L.GeoJSON.prototype.addData.call(this,a)}}),dm_Tools.leafletMap_d3_svg=d3.select(dm_Tools.leafletMap.getPanes().overlayPane).append("svg").style("position","relative"),dm_Tools.geoMapInitD3SvgG()}var f=dm_Datamap.currentDatamap.graph.center,g=dm_Tools.getConfig(f),h=g.mapOpacity,i=dm_Tools.getStyle(f,g);i&&(h=i.mapOpacity||h),(null===h||void 0===h)&&(h=.5),d3.select("#geoMap").style("opacity",h)},dm_Tools.removeLeafletMap=function(){d3.select("#geoMap").style("visibility","hidden"),dm_Tools.leafletMap&&dm_Tools.leafletMap.remove(),dm_Tools.leafletMap=null},dm_Tools.geoMapGetDistance=function(a,b,c){var d=function(a){return a*Math.PI/180},e=6378137,f=c?a[1]:a[0],g=c?a[0]:a[1],h=c?b[1]:b[0],i=c?b[0]:b[1],j=d(h-f),k=d(i-g),l=Math.sin(j/2)*Math.sin(j/2)+Math.cos(d(f))*Math.cos(d(h))*Math.sin(k/2)*Math.sin(k/2),m=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),n=e*m;return n},dm_Tools.geoMapCalculateLinear=function(a,b){var c,d;if(a&&a.length>1){c=0;for(var e=1;e<a.length;e++)d=a[e-1],c+=dm_Tools.geoMapGetDistance(d,a[e],b)}return c},dm_Tools.geoMapGetMinMax=function(a,b,c,d){var e=b,a=a;if(a&&a.length>0){if("Polygon"==d){for(var f=[],g=0;g<a.length;g++)for(var h=0;h<a[g].length;h++)f.push(a[g][h]);a=f}if("MultiPolygon"==d){for(var f=[],g=0;g<a.length;g++)for(var h=0;h<a[g].length;h++)for(var i=0;i<a[g][h].length;i++)f.push(a[g][h][i]);a=f}e||(e=[[Number.MAX_VALUE,Number.MAX_VALUE],[-Number.MAX_VALUE,-Number.MAX_VALUE]]);for(var j,k,l,g=a.length-1;g>=0;g--)l=a[g],dm_Tools.isArray(l)?(j=c?l[1]:l[0],k=c?l[0]:l[1]):(j=c?a[1]:a[0],k=c?a[0]:a[1],g=-1),j&&k&&!isNaN(j)&&!isNaN(k)?(e[1][0]=Math.max(e[1][0],j),e[1][1]=Math.max(e[1][1],k),e[0][0]=Math.min(e[0][0],j),e[0][1]=Math.min(e[0][1],k)):console.log("WARNING: some coordinates are not numbers... ",j,k)}return!e||e[1][0]!=-Number.MAX_VALUE&&e[1][1]!=-Number.MAX_VALUE&&e[0][0]!=Number.MAX_VALUE&&e[0][1]!=Number.MAX_VALUE||(console.log("geoMap min max problem ... ",e),e=null),e},dm_Tools.geoMapReverseLatLng=function(a){return[a[1],a[0]]},dm_Tools.geoMapReverseLatLngCoords=function(a){for(var b=[],c=0;c<a.length;c++)b.push(dm_Tools.geoMapReverseLatLng(a[c]));return b},dm_Tools.geoMapCalculateCenter=function(a,b,c){if(a){if("Point"==c||a.length<2&&!dm_Tools.isArray(a[0]))return b?dm_Tools.geoMapReverseLatLng(a[0]):a[0];(c&&"Point"!=c||a.length>1||dm_Tools.isArray(a[0]))&&(a=dm_Tools.geoMapGetMinMax(a,null,null,c));var d=[(a[0][0]+a[1][0])/2,(a[0][1]+a[1][1])/2];return b!==!1&&(d=[dm_Tools.correctLongitudMiddle(a[0][0],a[1][0]),(a[0][1]+a[1][1])/2]),b?dm_Tools.geoMapReverseLatLng(d):d}},dm_Tools.correctLongitudMiddle=function(a,b){var c=(0>a?360+a:a)+(0>b?360+b:b);return c/=2,c=c>180?c-360:c},dm_Tools.geoMapRelativeBaryCenter=function(a,b){var c,d,e,f,g,h,i,j=function(a){var b,c,d;return a.rawNode&&(a.rawNode.dm_geoMapCoordsMinMax?(c=a.rawNode.dm_geoMapCoordsMinMax,d=[(c[0][0]+c[1][0])/2,dm_Tools.correctLongitudMiddle(c[0][1],c[1][1])]):a.rawNode.dm_geometry_coords&&(c=a.rawNode.dm_geometry_coords,d=dm_Tools.geoMapCalculateCenter(c,null,a.rawNode.dm_geometry_type)),b=d),b};if(a.children&&a.children.length>0){g=0,h=0,i=0;for(var k=0;k<a.children.length;k++)if(e=a.children[k],e.rawNode){if(d=j(e),f=0,!isNaN(a.rawNode[b]))try{f=parseFloat(a.rawNode[b])}catch(l){f=0}i+=f,g+=d[0]*f,h+=(d[1]<0?360+d[1]:d[1])*f}c=[g/i,h/i>180?h/i-360:h/i]}else c=j(a);return c},dm_Tools.geoMapReduceCoords=function(a,b){var c=a;if(a.length>2){c=[],c.push(a[0]);for(var d=1/b,e=d;e<a.length-1;)c.push(a[Math.round(e)]),e+=d;c.push(a[a.length-1])}return c},dm_Tools.geoMapAggregateGeometry=function(a,b,c){var d=[],c=c||1;if(a.children)for(var e,f,g,h,i=0;i<a.children.length;i++){e=a.children[i],f=JSON.parse(e.rawNode[b]);for(var j=0;j<f.length;j++)g=f[j],h=g.geometry.coordinates,1>c&&(h=dm_Tools.geoMapReduceCoords(g.geometry.coordinates,c)),d.push({type:"Feature",properties:{node_name:e.name,node_orig_path:g.properties.node_orig_path,leaf_name:g.properties.leaf_name},geometry:{type:g.geometry.type,coordinates:h}})}else d.push({type:"Feature",properties:{node_name:a.name,node_dm_uniqueId:a.dm_uniqueId,node_orig_path:dm_Tools.getNodePath(a,null,!0,null,null,null,!0),leaf_name:a.name},geometry:{type:a.rawNode.dm_geometry_type,coordinates:a.rawNode.dm_geometry_coords}});return JSON.stringify(d)},dm_Tools.geoMapReduceGeoJson=function(a,b,c,d){options={"coordinate-system":"auto",quantization:c||500,"simplify-proportion":d||1e-4};var e=topojson.topology({collection:{type:"FeatureCollection",features:JSON.parse(a.rawNode[b])}},options);topojson.simplify(e,options);var f;for(var g in e.objects)f=topojson.feature(e,e.objects[g]);return{topoJson:e,geoJson:f}},dm_Tools.geoMapReduceAllGeoJson=function(a){console.log("--------- reducing GeoJson...",dm_Tools.getDelay()),dm_Tools.scanNodes(a,function(a){if(a.rawNode&&a.rawNode.dm_geoMapAggregatedGeoJson){var b=dm_Tools.geoMapReduceGeoJson(a,"dm_geoMapAggregatedGeoJson");a.rawNode.dm_geoMapReducedAggregatedTopoJson=JSON.stringify(b.topoJson),a.rawNode.dm_geoMapReducedAggregatedGeoJson=JSON.stringify(b.geoJson.features)}}),console.log("--------- finished reducing GeoJson...",dm_Tools.getDelay())},dm_Tools.geoMapGetLayer=function(a){var b,c=dm_Tools.getColorInGradient("#000000",dm_Tools.getConfig(a).styles[a.level].color,80),d=Math.max(1.5,.7*a.level),e={weight:d,color:c,stroke:!0,opacity:1},f=function(b){var c=dm_Tools.getChildIndexAndObj(a,b.properties.node_name).index;return c},g=function(a){var b=dm_Tools.clone(e),c=f(a);return c/2!=Math.round(c/2)&&(b.weight=1.4*e.weight),b.color=dm_Tools.getColorInGradient("#000000",dm_Tools.colors[c],90),b};return a.rawNode.dm_leafletMapLayer?b=a.rawNode.dm_leafletMapLayer:a.rawNode.dm_geoMapReducedAggregatedTopoJson?(b=new L.TopoJSON,b.addData(JSON.parse(a.rawNode.dm_geoMapReducedAggregatedTopoJson)),b.setStyle({style:g})):(a.rawNode.dm_geoMapReducedAggregatedGeoJson||a.rawNode.dm_geoMapAggregatedGeoJson)&&(b=L.geoJson(JSON.parse(a.rawNode.dm_geoMapReducedAggregatedGeoJson||a.rawNode.dm_geoMapAggregatedGeoJson),{style:g,pointToLayer:function(a,b){var c=f(a),d=L.icon({iconUrl:dm_Tools.geoMapTintedMarkers[c][0],iconRetinaUrl:dm_Tools.geoMapTintedMarkers[c][0],iconSize:[25,41],iconAnchor:[12,41],shadowUrl:"libs/leaflet/images/marker-shadow.png",shadowRetinaUrl:"libs/leaflet/images/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[13,40]});return L.marker(b,{icon:d})}})),a.rawNode.dm_leafletMapLayer=b,b},dm_Tools.geoMapCalculateZoom=function(){dm_Tools.leafletMap_zoom=dm_Tools.leafletMap.getZoom(),dm_Tools.leafletMap_zoomFactor=1.2*(2+dm_Tools.leafletMap_zoom-12)},dm_Tools.geoMapMakeSvgId=function(a,b){var b=b||"";return"dm_geoMap_"+b+dm_Tools.formatJSVarName(a)},dm_Tools.geoMapDrawGeoJsonInD3=function(a){function b(){dm_Tools.geoMapCalculateZoom(),o.style("stroke-width",function(a,b){var c;if("Point"==a.geometry.type)c=.5;else{0==b&&dm_Tools.geoMapCalculateZoom(),c=Math.max(1.5,.4*dm_Tools.leafletMap_zoomFactor);var d=k(a);d/2!=Math.round(d/2)&&(c=1.4*c)}return c+"px"});var a=d.node.rawNode.dm_geoMapCoordsMinMax,b=dm_Tools.leafletMap.latLngToLayerPoint(a[0]),c=dm_Tools.leafletMap.latLngToLayerPoint(a[1]),e=[b.x,c.y],f=[c.x,b.y],g=10;e[0]-=g,e[1]-=g,f[0]+=g,f[1]+=g,dm_Tools.leafletMap_d3_svg.attr("width",f[0]-e[0]).attr("height",f[1]-e[1]).style("left",e[0]+"px").style("top",e[1]+"px"),dm_Tools.leafletMap_d3_svg_g.attr("transform","translate("+-e[0]+","+-e[1]+")"),q.attr("d",n).on("mousemove",function(a){var b=dm_Tools.getNodeFromPath(a.properties.node_orig_path);if(b){b=b.node;for(var c=b,d=dm_Datamap.currentDatamap.graph.allDisplayedNodes;c&&d.indexOf(c)<0;)c=c.parent;console.log("mouse over : "+b.name+" with displayed parent : "+(c?c.name:null))}}).on("mousedown",function(a){dm_UI.eventCaughtAnotherLayer=!1;var b;console.log("go to > "+a.properties.node_orig_path),b=dm_Tools.getNodeFromPath(a.properties.node_orig_path),b&&(b=b.node);for(var c=b,d=dm_Datamap.currentDatamap.graph.allDisplayedNodes;c&&d.indexOf(c)<0;)c=c.parent;if(c||(c=b),console.log("mouse over : "+b.name+" with displayed parent : "+(c?c.name:null)),c){var e=d3.mouse(this),f=e[0],g=e[1];c.rawNode.dm_geoMapDisplayStreetView=dm_Tools.geoMapGetLatLngFromPixelPoint(f,g),dm_UI.lastMouseOverNode!=c?(dm_UI.resetMouseOverSelection(),dm_Datamap.currentDatamap.graph.mouseOverSelectNodeAndPutCircle(c)):(dm_Datamap.focusNode(c),dm_Datamap.refreshGraph(c)),dm_Attributes.updateAttributesPanel()}})}function c(a,b){try{var c=dm_Tools.leafletMap.latLngToLayerPoint(new L.LatLng(b,a));this.stream.point(c.x,c.y)}catch(d){console.log("WARNING: some coordinates are not valid... ",d)}}dm_Tools.geoMapInitD3SvgG();var d={type:"FeatureCollection",node:a};d.features=JSON.parse(a.rawNode.dm_geoMapReducedAggregatedGeoJson||a.rawNode.dm_geoMapAggregatedGeoJson);for(var e,f,g,h,i,j,k=function(a){var b=0,c=dm_Tools.getChildIndexAndObj(d.node,a.properties.node_name);if(c)b=c.index;else if(d.node.name==a.properties.node_name){var e=dm_Tools.getChildIndexAndObj(d.node.parent,d.node.name);e&&(b=e.index)}return b},l=function(a){var b=k(a);b>=dm_Tools.colors.length&&(b%=dm_Tools.colors.length);var c=dm_Tools.getColorInGradient("#000000",dm_Tools.colors[b],90);return c},m=d3.geo.transform({point:c}),n=d3.geo.path().projection(m).pointRadius(function(a){var b=Math.max(2,dm_Tools.leafletMap_zoomFactor);return b}),o={},p=0;p<d.features.length;p++)e=d.features[p],f=e.properties.node_name,g=o[f],g||(h=null,"Point"==e.geometry.type&&(h=l(e)),i=0,i="Point"==e.geometry.type?1:"LineString"==e.geometry.type?0:.5,j=null,j="Point"==e.geometry.type?"#000000":dm_Tools.getColorInGradient(l(e),"#000000",50),g=o[f]=dm_Tools.leafletMap_d3_svg_g.append("g").attr("id",dm_Tools.geoMapMakeSvgId(f)).attr("dm_geoMap_color",l(e)).style("fill",function(){var a;return a="LineString"==e.geometry.type?h:d3.select(this).attr("dm_geoMap_color")}).style("fill-opacity",i).style("stroke",j).datum(e)),g.append("path").datum(e);var o=dm_Tools.leafletMap_d3_svg_g.selectAll("g"),q=dm_Tools.leafletMap_d3_svg_g.selectAll("path");dm_Tools.leafletMap.on("viewreset",function(a){a.dm_uniqueId==dm_Tools.leafletMap_avoidDoubleReset&&b(),dm_Tools.leafletMap_avoidDoubleReset=a.dm_uniqueId}),b()},dm_Tools.geoMapGetLatLngFromPixelPoint=function(a,b){var c=dm_Tools.leafletMap.layerPointToLatLng(L.point(a,b));return c},dm_Tools.geoMapDrawMarker=function(a,b){var c=dm_Tools.geoMapGetLatLngFromPixelPoint(a,b);dm_Tools.geoMapDrawMarkerFromLatLng(c.lat,c.lng)},dm_Tools.geoMapDrawMarkerFromLatLng=function(a,b){$(".leaflet-map-pane").find(".leaflet-marker-pane").empty(),$(".leaflet-map-pane").find(".leaflet-shadow-pane").empty(),L.marker([a,b]).addTo(dm_Tools.leafletMap)},dm_Tools.geoMapHighlightGeometryOfNode=function(a){var b=function(a){var a=a||dm_Tools.leafletMap_d3_svg_g.selectAll("g");a.style("stroke-width",function(){var a,b=d3.select(this);b.attr("id");b.classed("dm_geoMap_animating")||(a=b.attr("previousStrokeWidth"));var c=b.style("stroke-width");return a||c}).style("stroke",function(){var a,b=d3.select(this);b.attr("id");b.classed("dm_geoMap_animating")||(a=b.attr("previousStroke"));var c=b.style("stroke");return a||c})},c=function(a){var a=a||dm_Tools.leafletMap_d3_svg_g.selectAll("g");a.classed("dm_geoMap_animating",!1).transition()};if(dm_Tools.leafletMap_d3_svg_g){var d,e=dm_Tools.leafletMap_d3_svg_g.selectAll("#"+dm_Tools.geoMapMakeSvgId(a.name)),f=30;if(e[0].length<100){d=(new Date).getTime(),e.attr("previousStrokeWidth",function(){var a=d3.select(this),b=a.attr("previousStrokeWidth");return b||(b=a.style("stroke-width")),b}).attr("previousStroke",function(){var a=d3.select(this),b=a.attr("previousStroke");return b||(b=a.style("stroke")),b}).attr("previousOpacity",function(){var a=d3.select(this),b=a.attr("previousOpacity");return b||(b=a.style("opacity")),b});var g=function(){var g=!0;return(a&&dm_UI.lastMouseOverNode&&a.name!=dm_UI.lastMouseOverNode.name||(new Date).getTime()-d>1e3*f)&&(g=!1,c(e),b(e)),g},h=function(){g()&&e.classed("dm_geoMap_animating",!0).transition().style("stroke-width","6px").style("stroke",function(){return dm_Tools.getColorInGradient(d3.select(this).attr("dm_geoMap_color"),"#000000",40)}).ease("linear").duration(600).each("end",i)},i=function(){g()&&e.transition().style("stroke-width",function(){return d3.select(this).attr("previousStrokeWidth")}).style("stroke",function(){return dm_Tools.getColorInGradient(d3.select(this).attr("dm_geoMap_color"),"#000000",90)}).ease("linear").duration(600).each("end",h)};h()}}},dm_Tools.geoMapTableCoords2Node,dm_Tools.geoMapConnectCoords=function(a){dm_Tools.geoMapTableCoords2Node={},dm_Tools.scanNodes(a,function(a){if(a.rawNode&&a.rawNode.dm_geometry_coords){var b=a.rawNode.dm_geometry_coords[0];if(dm_Tools.isArray(b))for(var c,d=a.rawNode.dm_geometry_coords.length-1;d>=0;d--)c=a.rawNode.dm_geometry_coords[d],dm_Tools.geoMapTableCoords2Node[JSON.stringify(c)]=a;else 2==a.rawNode.dm_geometry_coords.length&&(dm_Tools.geoMapTableCoords2Node[a.rawNode.dm_geometry_coords]=a)}}),dm_Tools.scanNodes(a,function(a){if(a.rawNode&&a.rawNode.dm_geometry_coords)for(var b,c,d=a.rawNode.dm_geometry_coords.length-1,e={type:"transverse link",visible:!1,edit:!1,arrow:!1};d>=0;d--)b=a.rawNode.dm_geometry_coords[d],c=dm_Tools.geoMapTableCoords2Node[JSON.stringify(b)],c&&c!=a&&!dm_Tools.isParentOfEachOther(c,a)&&(a.rawNode.connectedFrom||(a.rawNode.connectedFrom=[]),a.rawNode.connectedFrom.push({connectNodeUniqueId:"$ref_"+c.dm_uniqueId}),a.rawNode["connectedFrom.dm_props"]=JSON.parse(JSON.stringify(e)),c.rawNode.connectedTo||(c.rawNode.connectedTo=[]),c.rawNode.connectedTo.push({connectNodeUniqueId:"$ref_"+a.dm_uniqueId}),c.rawNode["connectedTo.dm_props"]=JSON.parse(JSON.stringify(e)))})},dm_Tools.geoMapGetClosest2center=function(a){var b;if(a.rawNode&&!a.dm_isReducedNode){var c=a.rawNode.dm_geometry_coords;if(c)if(dm_Tools.isArray(c[0])){var d=dm_Tools.geoMapCalculateCenter(c,null,a.rawNode.dm_geometry_type);if(b=d,"Point"==a.rawNode.dm_geometry_type||"LineString"==a.rawNode.dm_geometry_type){for(var e,f,g=c[0],h=dm_Tools.geoMapGetDistance(g,d),i=0;i<c.length;i++)f=c[i],e=dm_Tools.geoMapGetDistance(f,d),h>e&&(g=f,h=e);b=g}}else b=c}return b},dm_Tools.getClosestDistance=function(a,b){var c;if(a.rawNode){var d=a.rawNode.dm_geometry_coords;if(d){var e;if(dm_Tools.isArray(d[0]))for(var f,g,h=Number.MAX_VALUE,i=0;i<d.length;i++)f=d[i],g=dm_Tools.geoMapGetDistance(f,b),h>g&&(e=f,h=g);else e=d;c=dm_Tools.geoMapGetDistance(e,b)}}return c},dm_Tools.geoMapGetNodeFromCoords=function(a){var b={},c=function(a,c){b[""+a[0]+","+a[1]]={lng:a[0],lat:a[1],node:c}};return dm_Tools.scanNodes(a,function(a){if(a.rawNode){var b,d=a.rawNode.dm_geometry_coords;if(d)if(dm_Tools.isArray(d[0]))for(var e=0;e<d.length;e++)b=d[e],c(b,a);else c(d,a)}}),b},dm_Tools.geoMapGetClosestLeaf=function(a,b,c,d){var c=c||dm_Tools.geoMapGetNodeFromCoords(a),e=c[""+b[1]+","+b[0]];if(e&&(d[""+b[1]+","+b[0]]=e,e=e.node),!e&&d&&(e=d[""+b[1]+","+b[0]]),!e){var f,g,h,i,j,k,l=Number.MAX_VALUE;for(var m in c)f=c[m].lat,g=c[m].lng,h=b[0]-f,i=b[1]-g,j=h*h+i*i,l>j&&(l=j,e=c[m].node,k=""+f+","+g);d[""+b[1]+","+b[0]]=e,console.log("WARNING : unresolved : "+b[0]+", "+b[1]+"     closest node : "+e.name+" "+k)}return e},dm_Tools.node2geojson=function(a,b,c,d,e,f,g){var h={type:"FeatureCollection",features:[]},i={},j={};dm_Csv.node2csvValues(a,b,c,null,e,f,g,i,j,null,null,!0,"only leaves");var k,l,m=null,n=null,o=function(){for(var a in j)k=a,0==a.indexOf("dm_hoTable_level_")&&(k=""+a.substring("dm_hoTable_".length)),n=m[a],0==a.indexOf("dm_geometry")?(l.geometry||(l.geometry={}),0==a.indexOf("dm_geometry_type")?l.geometry.type=n:0==a.indexOf("dm_geometry_coords")&&(l.geometry.coordinates=n)):a.indexOf(".dm_props")>=0||0==a.indexOf("dm_geoMap")||"array index"==a||0==a.indexOf("gauge_")&&!isNaN(a.substring("gauge_".length))||0==a.indexOf("icon_")&&!isNaN(a.substring("icon_".length))||n&&(l.properties[dm_Tools.formatJSVarName(k)]="object"==typeof n?JSON.stringify(n):n)};for(var p in i)l={type:"Feature",properties:{}},h.features.push(l),m=i[p],o();return JSON.stringify(h)},dm_Tools.geoMapConvertProj2CRS84=function(a,b){var c=function(a){var c=a;return c=proj4(b,"WGS84",a)},d=function(a,b,e){if(dm_Tools.isArray(e))if(2!=e.length||isNaN(e[0])||isNaN(e[1]))for(var f=0;f<e.length;f++)d(e,f,e[f]);else a.splice(b,1,c(e))},e=[a];d(e,0,a)},dm_Tools.geoMapIsInPolygon=function(a,b,c){var d,e,f,g,h=!1;f=a[a.length-1][0],g=a[a.length-1][1];for(var i=0;i<a.length;i++)d=a[i][0],e=a[i][1],(c>e&&g>=c||c>g&&e>=c)&&(b>=d||b>=f)&&b>d+(c-e)/(g-e)*(f-d)&&(h=!h),
f=d,g=e;return h},dm_Tools.googleStreetViewInitialized=function(){console.log("google maps loaded !...")},dm_Tools.nullOrUndefined="dm_null_or_undefined",dm_Tools.nullOrUndefinedDisplayStr="undefined",dm_Tools.getStatsAndSortedValues=function(a){var b=[],c={},d=function(b){var c,d=!0,e=0,f=0,g=0,h=0,i=0;for(var j in a[b])j!=dm_uniqueId&&j!=__dm_uniqueId&&(j==dm_Tools.nullOrUndefined?f+=a[b][j]:(g+=a[b][j],e++,h+=a[b][j]),i++);var k;if(i>0&&(c=h/i,d)){k=0;for(var j in a[b])j!=dm_Tools.nullOrUndefined&&(k+=Math.pow(a[b][j]-c,2));k=Math.sqrt(k/i)}return{empty:f,diff:e,coverage:g,deviance:k,average:c}};for(p in a)b.push(p),c[p]=d(p);return b.sort(function(a,b){var d=c[a],e=c[b],f=.9,g=1-f,h=f*d.diff+g*d.empty,i=f*e.diff+g*e.empty;return h-i}),{sortedValues:b,stats:c}},dm_Tools.getUnderlyingRawValuesPerNode=function(a,b){var c,d,e,f,g,h=["icon","backgroundImage","dm_columnName","displayName","dm_goto","dm_goto_config","order","array index","connectedTo","connectedFrom","dm_lastAggregationStamp","items","dm_twinOf","dm_parents"],i=function(a,b,c){(null===b||""===b||void 0===b)&&(b=dm_Tools.nullOrUndefined),"object"!=typeof b&&(d||(d={}),elt=d[a],elt||(elt={},d[a]=elt),elt[b]=elt[b]||0,c=c||1,elt[b]+=c)},j=function(a){var c,d;if(a.rawNode)if(a.rawNode[b])for(var e in a.rawNode[b].values){d=a.rawNode[b].values[e];for(var f in d)i(e,f,d[f])}else for(var e in a.rawNode)e!=dm_uniqueId&&e!=__dm_uniqueId&&e.indexOf(".dm_props")<0&&(!h||h.indexOf(e)<0)&&(!g||0!=e.indexOf(g))&&(!a.rawNode[e+".dm_props"]||"execute"!=a.rawNode[e+".dm_props"].type&&"action"!=a.rawNode[e+".dm_props"].type&&"image"!=a.rawNode[e+".dm_props"].type&&"javascript"!=a.rawNode[e+".dm_props"].type&&"music"!=a.rawNode[e+".dm_props"].type&&"slider"!=a.rawNode[e+".dm_props"].type&&"rich text"!=a.rawNode[e+".dm_props"].type&&"transverse link"!=a.rawNode[e+".dm_props"].type&&"graph"!=a.rawNode[e+".dm_props"].type)&&(c=a.rawNode[e],i(e,c))},k=dm_Tools.getNonReducedChildren(a);if(k&&0!=k.length){for(var l,m=0;m<k.length;m++)l=k[m],j(l);if(d){var n,o,p=a.rawNode.items;for(var q in d)if(q!=dm_uniqueId&&q!=__dm_uniqueId){n=0,o=0;for(var r in d[q])r!=dm_uniqueId&&r!=__dm_uniqueId&&(n+=d[q][r],r!=dm_Tools.nullOrUndefined&&(o+=d[q][r]));0==o?delete d[q]:p>n&&(d[q][dm_Tools.nullOrUndefined]=d[q][dm_Tools.nullOrUndefined]||0,d[q][dm_Tools.nullOrUndefined]+=p-n)}var s=dm_Tools.getStatsAndSortedValues(d);e=s.sortedValues,f=s.stats}}else j(a);return c={values:d,sortedValues:e,stats:f}},dm_Tools.getUnderlyingRawValues=function(a,b,c,d){var e,f=0;if(dm_Tools.scanNodes(a,function(a){if(!(d!==!1&&a.children&&a.children.length>0)){var g,h;if(f++,a.rawNode)for(var i in a.rawNode)i!=dm_uniqueId&&i!=__dm_uniqueId&&i.indexOf(".dm_props")<0&&(!b||b.indexOf(i)<0)&&(!c||0!=i.indexOf(c))&&(!a.rawNode[i+".dm_props"]||"execute"!=a.rawNode[i+".dm_props"].type&&"action"!=a.rawNode[i+".dm_props"].type&&"image"!=a.rawNode[i+".dm_props"].type&&"javascript"!=a.rawNode[i+".dm_props"].type&&"music"!=a.rawNode[i+".dm_props"].type&&"slider"!=a.rawNode[i+".dm_props"].type&&"rich text"!=a.rawNode[i+".dm_props"].type&&"transverse link"!=a.rawNode[i+".dm_props"].type&&"graph"!=a.rawNode[i+".dm_props"].type)&&(g=a.rawNode[i],(null===g||""===g||void 0===g)&&(g=dm_Tools.nullOrUndefined),"object"!=typeof g&&dm_Tools.fastIsNaN(g)&&(e||(e={}),h=e[i],h||(h={},e[i]=h),h[g]=h[g]||0,h[g]++))}}),e){var g,h;for(var i in e)if(i!=dm_uniqueId&&i!=__dm_uniqueId){g=0,h=0;for(var j in e[i])j!=dm_uniqueId&&j!=__dm_uniqueId&&(g+=e[i][j],j!=dm_Tools.nullOrUndefined&&(h+=e[i][j]));0==h?delete e[i]:f>g&&(e[i][dm_Tools.nullOrUndefined]=e[i][dm_Tools.nullOrUndefined]||0,e[i][dm_Tools.nullOrUndefined]+=f-g)}}return e},dm_Tools.selectUnderlyingRawValues=function(a,b,c,d){var b=b||[];if(c!==!1){var e=dm_Tools.getConfig(a),f=e.aggregate;if(f)for(var g=0;g<f.length;g++)b=b.concat(f[g].name)}b=b.concat(["icon","backgroundImage","dm_columnName","displayName","dm_goto","dm_goto_config","order","array index","connectedTo","connectedFrom","dm_lastAggregationStamp","dm_twinOf","dm_parents","dm_geoMapAggregatedGeoJson","dm_geoMapCoordsMinMax","dm_geoMapDisplayStreetView","dm_geoMapRelativeBaryCenter","dm_geometry_coords","dm_geometry_type"]);var h=dm_Tools.getUnderlyingRawValues(a,b,d),i=dm_Tools.getStatsAndSortedValues(h);return{sortedValues:i.sortedValues,values:h,stats:i.stats}},dm_Tools.getStyle=function(a,b,c){var c=c||0,b=b||dm_Tools.getConfig(a),d=b.styles[a.level+c];return!d&&a.level+c>=b.styles.length&&(d=b.styles[b.styles.length-1]),d},dm_Tools.isLeaf=function(a,b){var c,b=b||dm_Tools.getConfig(a),d=dm_Tools.getStyle(a,b);return d&&(c="leaf"==d.name||b.styles.indexOf(d)==b.styles.length-1),c},dm_Tools.buildCharts4underlyingRawValues=function(a,b,c,d,e,f){if(!a.dm_isReducedNode){var g=dm_Tools.getConfig(a);if(!dm_Tools.isLeaf(a,g)){var h=g.drawUnderlyingRawValuesCharts,i=dm_Tools.getStyle(a,g);if(i&&(h=void 0!==i.drawUnderlyingRawValuesCharts?i.drawUnderlyingRawValuesCharts:h),h!==!1&&"false"!==h){var j="rawValueChart_",d=d||[];"string"==typeof d&&(d=[d]);var k=a.rawNode[b];k||(k=dm_Tools.selectUnderlyingRawValues(a,d,e,j));var l,m,n,o,p,q,r=1010,s=dm_Tools.getParentNode4Config(a),c=c||12;for(var n in a.rawNode)0==n.indexOf(j)&&(delete a.rawNode[n],delete a.rawNode[n+".dm_props"]);var t=dm_Tools.getLocalDepth(a,s),u=function(a){var b,c;if(g&&g.columns)for(var d=0;!b&&d<g.columns.length;d++)c=g.columns[d],c&&c.name==a&&(b=d);return b};if(k.sortedValues)for(var c=Math.min(c,k.sortedValues.length),v=0;c>v;v++){n=k.sortedValues[v];var w=u(n),x=k.stats[n],y=!1;if(1==x.diff?y=!0:x.deviance<.01&&Math.abs(1-x.diff/x.coverage)<.01&&Math.abs(1-x.average)<.01&&(y=!0),null!==w&&t>=w)c=Math.min(c+1,k.sortedValues.length);else if(!y){l=k.values[n],o=j+"borderIn_"+v,a.rawNode[o]=o,a.rawNode[o+".dm_props"]={visible:!0,order:++r,type:"borderIn",dontExport:!0,removeAtSave:!0},o=j+"title_"+v,a.rawNode[o]='<div class="dm_txtShadow dm_center"><b>'+n+"</b></div><br/>",a.rawNode[o+".dm_props"]={visible:!0,order:++r,type:"rich text",dontExport:!0,removeAtSave:!0},q=[];for(var m in l)(m!=dm_Tools.nullOrUndefined||f)&&(p={},q.push(p),p.name=m,m==dm_Tools.nullOrUndefined&&(p.name=g.nullOrUndefinedLegend||g.emptyFieldsAsNodes||dm_Tools.nullOrUndefinedDisplayStr),p.value=l[m]);o=j+"values_"+v,a.rawNode[o]=q,a.rawNode[o+".dm_props"]={dontExport:!0,removeAtSave:!0},o=j+"chart_"+v,a.rawNode[o]=0,a.rawNode[o+".dm_props"]={visible:!0,order:++r,type:"graph",graphModel:"discreteBarChart",input:q,precision:".0f",doSort:!0,doTransition:!0,textInPie:!1,namesInPie:!1,rotateLegend:!0,muteInPie:3,dontExport:!0,removeAtSave:!0};var x=k.stats[n];x.deviance<1&&Math.abs(1-x.diff/x.coverage)<.2&&Math.abs(1-x.average)<.2&&(delete a.rawNode[o+".dm_props"].graphModel,a.rawNode[o+".dm_props"].graph="pie"),o=j+"borderOut_"+v,a.rawNode[o]=o,a.rawNode[o+".dm_props"]={visible:!0,order:++r,type:"borderOut",dontExport:!0,removeAtSave:!0}}}}}}},dm_Tools.twin2sameObj=function(a){var b=function(a){var b=a,c=a.lastIndexOf("|");return c>0&&(b=a.substring(0,c)),b},c=a;dm_Tools.scanNodes(a,function(a){if(a.dm_twinOf){var d=dm_Tools.getNodeFromPath(a.dm_twinOf,null,null,null,null,c).node;if(d){var e=a.parent;if(e){var f=e.children.indexOf(a);if(f>=0){var g;d.dm_parents||(d.dm_parents={},g=b(dm_Tools.getNodePath(d,null,!0,null,null,null,!0)),d.dm_parents[g]=null),a.name=d.name,g=b(dm_Tools.getNodePath(a,null,!0,null,null,null,!0)),d.dm_parents[g]=null,e.children.splice(f,1,d)}}}}})},dm_Tools.cleanupTwins=function(a){},dm_Tools.scanAncestors=function(a,b,c){for(var d,e,f={},g=[a];!e&&g.length>0;)if(d=g.pop(),void 0===f[d.dm_uniqueId]){if(c&&d.dm_isReducedNode||b(d),d){var h,i=d.dm_parents;if(i)for(var j in i)h=dm_Tools.getNodeFromPath(j).node,g.push(h);else d.parent&&g.push(d.parent)}f[d.dm_uniqueId]=null}},dm_Tools.inherit=function(a,b,c,d){if(!b)return dm_Tools.clone(a,c);var e,f=dm_Tools.clone(b,c);for(var g in a)e=a[g],d&&f[g]&&"object"==typeof e&&!dm_Tools.isArray(e)?f[g]=dm_Tools.inherit(e,f[g]):f[g]=dm_Tools.clone(e);return f},dm_Tools.getDmPropFromStyleOrNode=function(a,b,c,d){var e,d=d||dm_Tools.getConfig(a);if(a.rawNode&&a.rawNode[b+".dm_props"]&&(e=a.rawNode[b+".dm_props"][c]),void 0==e){var f=dm_Tools.bestEffortLevel(a),g=d.displayProps[f];if(d.displayProps&&g)for(var h,i=!1,j=0;!i&&j<g.children.length;j++)h=g.children[j],h.name==b&&(i=!0,e=h[c])}return e},dm_Tools.exportJS=function(a,b){var b=b||dm_Tools.getConfig(a),a=a||dm_Datamap.currentDatamap.graph.center,c=""+a.name+" = (function() {\n",d=function(a){for(var b="_",c=a.name,d=a.parent;d;)c=d.name+b+c,d=d.parent;return c},e=function(a){for(var b,c=0,d=a.split("\n"),e=!1,f=0;f<d.length&&!e;f++)b=(""+d[f]).trim(),0==b.indexOf("//")?(b=(""+b.substring("//".length)).trim(),0==b.indexOf("arg")&&c++):e=!0;return c};return dm_Tools.scanNodes(a,function(a){var f=d(a);if(a.rawNode.code){c+="var "+f+" = function(";for(var g=e(a.rawNode.code),h=0;g>h;h++)c+=(h>0?", ":"")+"arg"+(h+1);c+=") {\n";for(var i in a.rawNode)i!=__dm_uniqueId&&"displayName"!=i&&"array index"!=i&&("transverse link"==dm_Tools.getDmPropFromStyleOrNode(a,i,"type",b)||(c+="var "+i+" = "+a.rawNode[i]+" ;\n"));c+=a.rawNode.code,c+="} ;"}}),c+="})() ;"},dm_Tools.aggregSum=function(a,b,c){var d,e=0;if(a.children&&a.children.length>0){var f=a.children.length-1;for(e=0;f>=0;f--)d=a.children[f],d.rawNode[b]?e+=d.rawNode[b]:d.rawNode[c]&&(e+=d.rawNode[c])}else a.rawNode[c]&&(e=a.rawNode[c]);return e},dm_Tools.aggregPie=function(a,b,c,d){var e,f;if(a.children&&a.children.length>0&&!a.dm_isReducedNode){var g=(dm_Tools.getDepth(a),function(a){a.rawNode[b]&&(e||(e=[]),f={},e.push(f),f.value=a.rawNode[b],f.name=a.displayName||a.name,f.unit=c)}),h=dm_Tools.getDepth(a),d=d||1,i=function(a){if(a){var b=dm_Tools.getDepth(a);b==h+d?g(a):dm_Tools.getDepth(a)<h+d&&a.children&&a.children.forEach(function(a){i(a)})}};i(a)}return e},dm_Tools.querySparql=function(a,b,c,d){b=b.replace(/\n/g," ");var e=a+"?query="+encodeURIComponent(b)+"&format=csv";console.log("#################"),console.log(""+e),console.log("#################"),dm_Tools.testFileExist(e,function(a){console.log("#################"),console.log(JSON.stringify(a)),console.log("#################");var b=!1;b&&dm_Tools.saveFile(a,c.name+".csv","text/csv, text/plain","x-user-defined");new dm_Datamap(d+"/"+c.name+".csv",null,null,null,function(a){if(a.graph=dm_Datamap.currentDatamap.graph,c.dm_config=a.root.dm_config,c.children=a.root.children,c.children)for(var b,d=0;d<c.children.length;d++)b=c.children[d],b.parent=c;c.rawNode=dm_Tools.inherit(a.root.rawNode,c.rawNode),c.dm_DatamapName=a.name,c.level=0,dm_UI.autoResize()},null,null,dm_Datamap.currentDatamap.graph,null,a)},function(a){console.log("#################"),console.log(e),console.log("failure"),console.log("#################")},!0,!1,"application/sparql-query")},dm_Tools.test=function(){var a="http://217.13.50.2:8080/fuseki/TestUpload/sparql",b=["SELECT *","FROM <http://gayatech/analytics>","WHERE {","  ?v ?x ?z","}"].join(" "),c=a+"?query="+encodeURIComponent(b)+"&format=csv";console.log("#################"),console.log(""+c),console.log("#################"),setTimeout(function(){dm_Tools.testFileExist(c,function(a){console.log("#################"),console.log(JSON.stringify(a)),console.log("#################")},function(a){console.log("#################"),console.log(c),console.log("failure"),console.log("#################")},!0,!1,"application/sparql-query")},3e3)},dm_Tools.getDomFieldContent=function(a,b){var c=dm_Attributes.getId("attribute_text_",{name:b},a),d=dm_Attributes.getId("attribute_text_",{name:b},a,{isInModal:"attributes_modal"}),e=$("#"+c).val();return e=e||$("#"+d).val()},dm_Tools.enableOrDisableButton=function(a,b,c,d){a.rawNode[b+".dm_props"]["class"]=d+(c?"":" disabled");var e=dm_Attributes.getId("attribute_action_",{name:b},a),f=dm_Attributes.getId("attribute_action_",{name:b},a,{isInModal:"attributes_modal"});c?($("#"+e+"_btn").removeClass("disabled"),$("#"+f+"_btn").removeClass("disabled")):($("#"+e+"_btn").addClass("disabled"),$("#"+f+"_btn").addClass("disabled"))},dm_Tools.validateSearchQueryField=function(a,b){var c=dm_Attributes.getId("attribute_text_",{name:b},a),d=dm_Attributes.getId("attribute_text_",{name:b},a,{isInModal:"attributes_modal"});dm_Datamap.searchQueryDone(c,!0,null,!0,!0),dm_Datamap.searchQueryDone(d,!0,null,!0,!0)},dm_Csv.removeEmptyColumns=function(a){for(var b,c=a.length-1;c>=0;c--)b=a[c],b&&""!=b||a.splice(c,1);return a},dm_Csv.extension="csv",dm_Csv.nodeI=0,dm_Csv.nodeJ=0,dm_Csv.dontExportProps=["__dm_uniqueId","dm_uniqueId","icon","order","dm_goto","dm_goto_config","dm_sourceFile","connectedTo","connectedFrom","aggregatedConnectedTo","aggregatedConnectedFrom","backgroundImage","dm_lastAggregationStamp"],dm_Csv.isPropExportable=function(a,b){if(!b||""==b)return!1;for(var c=!0,d=dm_Csv.dontExportProps.length-1;d>=0&&c;d--)dm_Csv.dontExportProps[d]==b&&(c=!1);c&&(b.indexOf(".dm_props")>=0||b.indexOf(".")>=0)&&(c=!1);var e;return c&&a[""+b+".dm_props"]&&(e=a[""+b+".dm_props"],e&&null!=e.dontExport&&void 0!=e.dontExport?c=!1:null!=a[""+b+".dontExport"]&&void 0!=a[""+b+".dontExport"]&&(c=!1)),c&&e&&"boolean"!=e.type&&"rich text"!=e.type&&"text"!=e.type&&(c=!1),c},dm_Csv.getValue=function(a,b){if(a&&dm_Csv.isPropExportable(a,b)){var c=a[b];return c}},dm_Csv.enrichColumnsOnTheFly=function(a,b){for(var c in a)dm_Csv.isPropExportable(a,c)&&!b[c]&&(b[c]=null)},dm_Csv.node2csv=function(a,b,c,d,e,f,g,h,i){var j="",k=h?[]:{},l={};dm_Csv.node2csvValues(a,b,c,null,e,f,g,k,l,null,h,i);var m="",n=0==c.csvSepIsSemicolon?",":";",c=c||dm_Tools.getConfig(a),o=null,p=!1,q=null;for(var r in l)m+=0==r.indexOf("dm_hoTable_level_")?"level "+r.substring("dm_hoTable_level_".length)+n:r+n;j=m+"\n"+j;var s=function(){p=!0;for(var a in l)p||(j+=n),p=!1,q=o[a],j+=q?q:"";j+="\n"};if(h)for(var t=0;t<k.length;t++)o=k[t],s();else for(var u in k)o=k[u],s();return j},dm_Csv.node2table=function(a,b,c,d){var e=b?[]:{};return console.time("node2csv"),dm_Csv.node2csvValues(a,null,null,null,null,null,null,e,c,null,b,!0),console.timeEnd("node2csv"),e},dm_Csv.cloneAndConvertRichText2flatText=function(a){var b=dm_Tools.getConfig(a),a=dm_Tools.deepCopyDmNode(a,"parent");return dm_Tools.restoreParentsInTree(a),dm_Tools.visitTree(a,function(a,c,d,e){if("string"==typeof a){if(e[c+".dm_props"]&&"rich text"==e[c+".dm_props"].type||"rich text"==e[c+".type"])try{a=jQuery(a).text()}catch(f){a=""}a=0==b.csvSepIsSemicolon?a.replace(/,/g,";"):a.replace(/;/g,","),a=a.replace(/\n/g," "),a=a.replace(/\r/g,""),e[c]=a}}),a},dm_Csv.node2csvValues=function(a,b,c,d,e,f,g,h,i,j,k,l,m){dm_Csv.nodeI++,dm_Csv.nodeJ++,dm_Csv.nodeJ>f&&(dm_Csv.nodeJ=0,null!=g&&g(dm_Csv.nodeI));var e=e||0;c=c||dm_Tools.getConfig(a),b||0===b||(b=dm_Tools.getMaxDepth(a));var n=c.columnNames;j=j||!n;var h=h||(k?[]:{});if(b>=e){if(n){i||(i={});for(var o=0;o<n.length;o++)i[""+n[o]]=null}if((!i||0==Object.keys(i).length)&&(i||(i={}),l))for(var o=0;b>=o;o++)i["dm_hoTable_level_"+o]=null;if(dm_Csv.enrichColumnsOnTheFly(a.rawNode,i),a.rawNode||(a.rawNode={}),m&&a.children||(k?h.push(a.rawNode):h[""+Object.keys(h).length]=a.rawNode),l)for(var p=dm_Tools.getNodePathNames(a),o=0;b>=o;o++)o<p.length&&(a.rawNode["dm_hoTable_level_"+o]=p[o]);if(a.children)for(var q,r=a.children.length,o=0;r>o;o++)q=a.children[o],dm_Csv.node2csvValues(q,b,c,d,e+1,f,g,h,i,j,k,l,m)}},dm_Csv.getColumnValuesFromTable=function(a,b){for(var c,d,e,f={},g=0;g<a.length;g++)if(c=a[g])if(dm_Tools.isArray(b))for(var h=0;h<b.length;h++)e=b[h],f[e]||(f[e]=[]),dm_Tools.isArray(c)?(d=c[h],d&&f[e].indexOf(d)<0&&f[e].push(d)):(d=c[e],d&&f[e].indexOf(d)<0&&f[e].push(d));else for(var i in b)if(f[i]||(f[i]=[]),dm_Tools.isArray(c)){var h=Object.keys(b).indexOf(i);d=c[h],d&&f[i].indexOf(d)<0&&f[i].push(d)}else d=c[i],d&&f[i].indexOf(d)<0&&f[i].push(d);return f},dm_LDIF.extension="ldif",dm_LDIF.parse=function(a,b){this.nodes=new dm_tools_NameIdList,this.root=b.parentNode||{name:b.name,rawNode:{discardNodeAfterPaste:!0}},this.columnNames={};var c=this,d=function(){if("string"!=typeof a)b.data=a;else{b.data=[];for(var c,d,e,f,g,h,i,j,k,l,m=a.split(/\r?\n\r?\n/g),n=function(){h&&(d||(d={},k={}),l=k[h],null!=l?k[h]=++l:k[h]=0,d[h+(l>0?"."+l:"")]=j)},o=0;o<m.length;o++){if(c=m[o],e=c.split(/\r?\n/g),e.length>0){h=null,j="",d=null,k=null;for(var p=0;p<e.length;p++)f=e[p],f.trim().indexOf("#")<0&&(f=dm_Tools.removeCommentsHash(f)," "!=f[0]&&"	"!=f[0]?(h&&(n(),j=null),g=f.indexOf(":"),g>0&&(h=f.substring(0,g),h=h.trim())):g=-1,i=f.substring(g+1),i&&(j||(j=""),j+=i.trim()));n()}d&&b.data.push(d)}}},e=function(a,b){if(a&&a.children)for(var c,d=0;d<a.children.length;d++)if(c=a.children[d],c.name==b)return c},f=function(a,b,d){if(!a)return console.log("found an object without 'dn:' field."),void console.log(dm_Tools.stringify(b));for(var f,h,i=a.length-1,k=c.root;i>=0;i--){f=a[i],h=e(k,f);d[i-1];h?0==i&&g(h,b,d[i-1]):(h=j(k,f,0==i?b:null,d[i-1]),k.children||(k.children=[]),k.children.push(h)),k=h}return k},g=function(a,d,e){"l"==e?a.level=b.config.styles.length-2:"st"==e&&(a.level=b.config.styles.length-3);var f;for(var g in d)f=d[g],f&&0==f.indexOf(": ")&&(f=f.substring(2)),a.rawNode[g]=f,"uid"==g&&f&&b.config&&b.config.styles&&(a.level=b.config.styles.length-1),h(a,g),c.columnNames[g]||(c.columnNames[g]=1),a.rawNode[g+".visible"]=!0,a.rawNode[g+".edit"]=!0},h=function(a,c){var d=!0;if(b.config.props2query&&b.config.props2query.length>0&&(d=!1,b.config.props2query.indexOf(c)>=0&&(d=!0)),b.config.notProps2query&&b.config.notProps2query.length>0&&b.config.notProps2query.indexOf(c)>=0&&(d=!1),d){b.props2query||(b.props2query={}),b.props2query[c]||(b.props2query[c]={});var e=a.rawNode[c];e&&!b.props2query[c][e]&&(b.props2query[c][e]=1)}},i=function(){var a;for(a in b.props2query)b.props2query[a]=dm_Tools.arrayFromObj(b.props2query[a])},j=function(a,b,d,e){var f={parent:a,name:b,rawNode:{}};return g(f,d,e),c.nodes.addObject(f),f},k=function(a){for(var b,c,d=a.split(","),e=0;e<d.length;e++){c=d[e];var f=c.split("=")[1];f&&(f=f.trim(),b||(b=[]),b.push(f))}return b},l=function(){for(var a,c,d,e,g,h=0;h<b.data.length;h++){if(g={},a=b.data[h],d=[],a.dn&&(d=k(a.dn)),g=[],b.config.attributes2tree)for(var i,j=0;j<b.config.attributes2tree.length;j++)i=b.config.attributes2tree[j],e=a[i],e&&(g.splice(0,0,i),d&&d.splice(1,0,e));c=f(d,a,g)}};console.log("start generating the tree "+dm_Tools.getDelay()),d(),l(),b.root=c.root,b.setNodes(c.nodes),i(),b.config.columnNames=dm_Tools.arrayFromObj(c.columnNames),console.log("finished doing the tree "+dm_Tools.getDelay())},dm_LDIF.node2ldif=function(a,b,c,d,e,f,g){var h="",i={},j={};dm_Csv.node2csvValues(a,b,c,null,e,f,g,i,j,null,null,!0);var k,l=null,m=null,n=function(){for(var a in j)k=a,0==a.indexOf("dm_hoTable_level_")&&(k=""+a.substring("dm_hoTable_".length)),m=l[a],m&&(h+=dm_Tools.formatJSVarName(k)+": "+m+"\n");h+="\n"};for(var o in i)l=i[o],n(),h+="\n\n";return h},dm_Freemind.mmOpenNode=function(a,b,c,d){return b=b||!1,c=c||!1,a=dm_Freemind.mmFormatText(a),'<node TEXT="'+a+'" FOLDED="'+b+'" '+(d?'COLOR="'+d+'" ':"")+'STYLE="'+(c?"bubble":"fork")+'">\n'},dm_Freemind.mmFormatText=function(a){return a=""+a,a=a.replace(/&/g,"+"),a=a.replace(/"/g,"'")},dm_Freemind.mmCloseNode=function(){return"</node>\n"},dm_Freemind.nodeI=0,dm_Freemind.nodeJ=0,dm_Freemind.node2mm=function(a,b,c,d,e,f,g,h){if(a[dm_Tools_dm_config_name]&&(c=a[dm_Tools_dm_config_name]),dm_Freemind.nodeI++,dm_Freemind.nodeJ++,dm_Freemind.nodeJ>g&&(dm_Freemind.nodeJ=0,null!=h&&h(dm_Freemind.nodeI)),dm_Tools.isAdminConfigTreeNode(a))return"";var i=function(a,b,c,d,e){var f="",e=e,g=dm_Csv.isPropExportable(b.rawNode,d);return!g||a.graph||(null==e||""==e)&&a.dontDisplayNull||("rich text"==a.type&&(e=e.replace(/<br>/g," "),e=e.replace(/<br\/>/g," "),e=e.replace(/<[^>]*>/g,"")),f+=dm_Freemind.mmOpenNode(d,!1),f+=dm_Freemind.mmOpenNode(e,!1),f+=dm_Freemind.mmCloseNode(),f+=dm_Freemind.mmCloseNode()),f},b=b||0,j="",k=b>0;if(e>=b&&(a.children||!f))if("number"==typeof a||"string"==typeof a)j+=dm_Freemind.mmOpenNode(dm_Tools.convertValue(a),k),j+=dm_Freemind.mmCloseNode();else{if(j+=dm_Freemind.mmOpenNode(a.name,k,a.children?!0:!1,d(a)),j=dm_Tools.onDisplayableRawNodeProps(a,i,j,null,!0,!1,c),a.children)for(var l=0;l<a.children.length;l++)j+=dm_Freemind.node2mm(a.children[l],b+1,c,d,e,f,g,h);j+=dm_Freemind.mmCloseNode()}return j},dm_Json2tree.reservedProps=["id","name","parent","children","style","rawNode","children","dm_children","dm_DatamapName","level","x","y","px","py","weight","index","fixed","selected","dm_config","__dm_uniqueId","dm_uniqueId","$circularRefs","dm_leafletMapLayer","dm_sourceFile","dm_lastAggregationStamp"],dm_Json2tree.obj2tree=function(a,b,c,d,e,f){var g,h=function(a){return!dm_Tools.isArray(a)&&!("number"==typeof a||"string"==typeof a||"boolean"==typeof a)},i=function(a,d,e,f){if(a||(a={parent:null}),dm_Tools.isArray(e)){a.children||(a.children=[]);var g=a;d&&"children"!=d&&(g={name:d,parent:a,children:[]},a.children.push(g));for(var j,k=0;k<e.length;k++)if(j=e[k],null!=j){var l;h(j)?l=g:(l={parent:g,rawNode:{"array index":k}},g.children.push(l)),i(l,null,j,k)}}else if(null==e||"number"==typeof e||"string"==typeof e||"boolean"==typeof e)d?(a.rawNode||(a.rawNode={}),a.rawNode[d]=e,!b||d.indexOf(".dm_props")>=0||(a.rawNode[d+".dm_props"]||(a.rawNode[d+".dm_props"]={}),a.rawNode[d+".dm_props"].visible=!0),!c||d.indexOf(".dm_props")>=0||(a.rawNode[d+".dm_props"]||(a.rawNode[d+".dm_props"]={}),a.rawNode[d+".dm_props"].editable=!0)):a.name=e;else if(d&&d.indexOf(".dm_props")>=0)a.rawNode||(a.rawNode={}),a.rawNode[d]=e;else{a.children||(a.children=[]);var g={name:d,parent:a};isNaN(f)||(g.rawNode||(g.rawNode={}),g.rawNode["array index"]=f),a.children.push(g);for(var m in e)"name"==m?d||(g.name=e[m]):"parent"!=m&&"__dm_uniqueId"!=m&&i(g,m,e[m],f)}return a};return d?g=i(d,e,a):(g=i(null,a.name,a),h(a)&&(g=g.children[0],g.parent=null)),g},dm_Json2tree.tree2obj=function(a,b){var c,d,e=function(a,b){var c;if(a.children&&a.children.length>0)for(var d=0;d<a.children.length;d++){var e=dm_Json2tree.tree2obj(a.children[d],b);c||(c=[]),c.push(e)}return c};if(a.rawNode){var f=!1;for(var g in a.rawNode)0==g.indexOf("dm_hoTable_level_")?delete a.rawNode[g]:"dm_uniqueId"!=g&&(f=!0);f||delete a.rawNode}if(!a.rawNode&&a.name&&b)d=e(a,c),d?b[a.name]=d:a.name&&(c||(c={}),c.name=a.name);else{a.name&&(c||(c={}),c.name=a.name);for(var h in a.rawNode)c||(c={}),c[h]=a.rawNode[h];d=e(a,c),d&&(c||(c={}),c.children=d)}return c},dm_Json2tree.tree2realObjNotChildren=function(a){var b={};if(a.name&&(b.name=a.name,a.rawNode||a.children||(b=dm_ServerTools.parseAtomic(a.name))),a.rawNode)for(var c in a.rawNode)b[c]=a.rawNode[c];if(a.children){var d,e;a.children.forEach(function(c){!c.rawNode&&c.children?(e=dm_Json2tree.tree2realObjNotChildren(c),e&&(e[c.name]?b[c.name]=e[c.name]:b[c.name]=[])):(d||(d=b[a.name||"children"]=[]),e=dm_Json2tree.tree2realObjNotChildren(c),d.push(e))})}return b},dm_Json2tree.node2json_deprecated=function(a,b,c,d,e,f,g,h,i){var j=[];i||(j=dm_Json2tree.dontExportProps),c&&c.length>0&&(j=j.concat(c));var k=(dm_Tools.getConfig(a),dm_Tools.clone(a,j));return h(99),k},dm_Json2tree.geoJson2Table=function(a,b){"string"==typeof a&&(a=dm_Tools.parseStringified(a));var c;a.crs&&a.crs.properties&&(c=a.crs.properties.name);var d,e=[[]],f={},g=[],h=function(a,b){void 0===f[a]&&(f[a]=null,e[0].push(a)),g[Object.keys(f).indexOf(a)]=b};for(var i in a.features){if(d=a.features[i],g=[],d.properties)for(var j in d.properties)h(j,d.properties[j]);else for(var j in d)"type"!=j&&"geometry"!=j&&h(j,d[j]);d.geometry&&d.geometry.type&&(void 0===f.dm_geometry_type&&(f.dm_geometry_type=null,e[0].push("dm_geometry_type")),g[Object.keys(f).indexOf("dm_geometry_type")]=d.geometry.type),d.geometry&&d.geometry.coordinates&&(void 0===f.dm_geometry_coords&&(f.dm_geometry_coords=null,e[0].push("dm_geometry_coords")),c&&"urn:ogc:def:crs:OGC:1.3:CRS84"!=c&&"CRS84"!=c&&(0==c.indexOf("urn:ogc:def:crs:")&&(c=c.substring("urn:ogc:def:crs:".length)),c=c.replace(/::/g,":"),dm_Tools.geoMapConvertProj2CRS84(d.geometry.coordinates,c)),g[Object.keys(f).indexOf("dm_geometry_coords")]=b?dm_Tools.geoMapReverseLatLngCoords(d.geometry.coordinates):d.geometry.coordinates),e.push(g)}return e},dm_AggregationWorker_workerListener=function(e){var data=e.data;switch(data.cmd){case"aggregate":self.postMessage({admin:"aggregListener: start aggregation work: "+data.cmd});for(var aggregCodeParts=dm_Tools.parseStringified(data.aggregCodeParts),progressBarUpdates=200,bulkLength=aggregCodeParts.length>progressBarUpdates?Math.floor(aggregCodeParts.length/progressBarUpdates):1,bulkIdx=1,bulkOfCodeParts="",root=dm_Tools.parseBigTreeStr(data.root),nodes=dm_Tools.getNodesFromRoot(root),todoOnError=function(a){console.log("ERROR during eval of aggregation !\n"+a.stack);try{for(var b=a.stack.split("<anonymous>:")[1].split(":"),c=b[0],d=b[1].split(")")[0],e=(data.aggregDeclaration+"\n"+bulkOfCodeParts).split("\n"),f="",g=0;c>=g;g++)f+=e[g]+"\n";var h=f.lastIndexOf("_aggregateFunc("),i=data.aggregDeclaration.substring(0,h),j=i.lastIndexOf(" "),k=i.substring(j+1);console.log('during aggregation of property : "'+k+'"'),console.log("line : "+c+", col : "+d),c=parseInt(c)-1,console.log("  --> "+e[c]),console.log("in : ");for(var l=3,m=Math.max(0,c-l),n=Math.min(e.length-1,c+l),g=m;n>=g;g++)console.log((g==c?"  --> ":">     ")+e[g]);console.log("\n\n")}catch(o){}},aggregCodePartIdx=0;aggregCodePartIdx<aggregCodeParts.length;aggregCodePartIdx++)if(bulkOfCodeParts+=aggregCodeParts[aggregCodePartIdx],bulkIdx==bulkLength){try{var code=data.aggregDeclaration+"\n"+bulkOfCodeParts;eval(code)}catch(error){todoOnError(error)}bulkOfCodeParts="",bulkIdx=1;var progressPercent=100*(aggregCodePartIdx/aggregCodeParts.length);self.postMessage({percent:progressPercent})}else bulkIdx++;if(bulkOfCodeParts&&""!=bulkOfCodeParts)try{eval(data.aggregDeclaration+"\n"+bulkOfCodeParts)}catch(error){todoOnError(error)}self.postMessage({admin:"aggregListener: removeEventListener aggregListener"}),self.removeEventListener("message",dm_AggregationWorker_workerListener,!1);var stringifiedRoot=dm_Tools.bigTree2str(root);self.postMessage({percent:100,root:stringifiedRoot});break;case"save":self.postMessage({admin:"saveListener: start save work: "+data.cmd});var root=dm_Tools.parseStringified(data.root);root&&delete root.selected;var localConfig=data.config?dm_Tools.parseStringified(data.config):null,dontExportProps=["style","dm_children","x","y","px","py","weight","index","fixed","selected","repulseX","repulseY","dm_leafletMapLayer","parent","aggregatedConnectedTo","aggregatedConnectedFrom","connectNodeUniqueId","__dm_uniqueId","dm_uniqueId"];localConfig&&localConfig.saveInlineImages!==!0&&"true"!=localConfig.saveInlineImages&&dontExportProps.push("tintedSrc"),root&&dm_AggregationWorker_removeProps(root,dontExportProps,localConfig);var nbOfNodes=dm_Tools.countNodes(root,data.maxDepth,data.noLeafInReport),fileFormat=data.fileFormat,updateProgress=function(a){var b=100*(a/nbOfNodes);100>b&&self.postMessage({percent:b,admin:"saving "+fileFormat+" "+b+" %, node number: "+a})},updatePercent=function(a){100>a&&self.postMessage({percent:a,admin:"saving "+fileFormat+" "+a+" %"})},nbOfNodesPerBulk=nbOfNodes/100,file2saveContent=0,getColorFromNode=function(a){var b;localConfig.styles&&localConfig.styles[a.level]&&(b=localConfig.styles[a.level].txtCol);var c;localConfig.styles&&localConfig.styles[a.level]&&(c=localConfig.styles[a.level].color);var d=b||c;return d};if("mm"==fileFormat)self.postMessage({admin:"saving "+fileFormat+" "+nbOfNodes+" nodes, "+nbOfNodesPerBulk+" nodesPerBulk"}),dm_Freemind.nodeI=0,dm_Freemind.nodeJ=0,file2saveContent=dm_Freemind.node2mm(root,0,localConfig,getColorFromNode,data.maxDepth,data.noLeafInReport,nbOfNodesPerBulk,updateProgress);else if("csv"==fileFormat)self.postMessage({admin:"saving "+fileFormat+" "+nbOfNodes+" nodes, "+nbOfNodesPerBulk+" nodesPerBulk"}),dm_Csv.nodeI=0,dm_Csv.nodeJ=0,dm_Tools.restoreParentsInTree(root),file2saveContent=dm_Csv.node2csv(root,data.maxDepth,localConfig,null,null,nbOfNodesPerBulk,updateProgress,!0,!0);else if("ldif"==fileFormat)self.postMessage({admin:"saving "+fileFormat+" "+nbOfNodes+" nodes, "+nbOfNodesPerBulk+" nodesPerBulk"}),dm_LDIF.nodeI=0,dm_LDIF.nodeJ=0,dm_Tools.restoreParentsInTree(root),file2saveContent=dm_LDIF.node2ldif(root,data.maxDepth,localConfig,null,null,nbOfNodesPerBulk,updateProgress);else if("geojson"==fileFormat)self.postMessage({admin:"saving "+fileFormat+" "+nbOfNodes+" nodes, "+nbOfNodesPerBulk+" nodesPerBulk"}),dm_Tools.restoreParentsInTree(root),file2saveContent=dm_Tools.node2geojson(root,data.maxDepth,localConfig,null,null,nbOfNodesPerBulk,updateProgress);else if("json"==fileFormat||"json no config"==fileFormat){self.postMessage({admin:"saving "+fileFormat+" "+nbOfNodes+" nodes, "+nbOfNodesPerBulk+" nodesPerBulk"}),localConfig&&"json no config"!=fileFormat&&(root.dm_config=localConfig),dm_Tools.cleanUpD3StufInNodes(root),"json no config"==fileFormat&&delete root.dm_config;var data=JSON.stringify(root);data=dm_Tools.changeNewLinesFromJSONStrings(data,"re-set new-lines!"),updatePercent(99),file2saveContent='{\n    "$schema": "http://www.freedatamap.com/jsonSchema/schema#",\n    "$charset": "UTF-8",\n    "root":'+data+"\n}"}else"config"==fileFormat&&(self.postMessage({admin:"saving "+fileFormat}),data=JSON.stringify(localConfig),data=dm_Tools.changeNewLinesFromJSONStrings(data,"re-set new-lines!"),file2saveContent='{\n    "$schema": "http://www.freedatamap.com/jsonConfigSchema/schema#",\n    "$charset": "UTF-8",\n    "config": '+data+"\n}");self.postMessage({admin:"saveListener: removeEventListener saveListener"}),self.removeEventListener("message",dm_AggregationWorker_workerListener,!1),self.postMessage({percent:100,file2saveContent:file2saveContent});break;default:self.postMessage({admin:"listener: Unknown command: "+data.cmd})}},dm_AggregationWorker_removeProps=function(a,b,c){var c=c||dm_Tools.getConfig(a),b=b||[];"string"==typeof b&&(b=[b]),dm_Tools.scanNodes(a,function(a){if(a.rawNode){var d;for(var e in a.rawNode)b.indexOf(e)>=0?(delete a.rawNode[e],delete a.rawNode[e+".dm_props"]):a.rawNode[e+".dm_props"]&&a.rawNode[e+".dm_props"].dontExport?(delete a.rawNode[e],delete a.rawNode[e+".dm_props"]):(d=e.indexOf(".dm_props"),d>0&&a.rawNode[e].dontExport&&(delete a.rawNode[e.substring(0,d)],delete a.rawNode[e]));var f,g,h=dm_Tools.bestEffortLevel(a);if(c.displayProps&&(f=c.displayProps[h]),f&&f.children)for(var i=0;i<f.children.length;i++)g=f.children[i],g.dontExport&&(delete a.rawNode[g.name],delete a.rawNode[g.name+".dm_props"])}})},dm_AggregationWorker_workerAdminListener=function(a){var b=a.data;switch(b.cmd){case"start":self.postMessage({admin:"adminListener: WORKER STARTED"}),b.imports.forEach(function(a){self.postMessage({admin:"adminListener: WORKER IMPORT : "+a}),importScripts(a)});break;case"addListener":self.postMessage({admin:"adminListener: addEventListener"}),self.addEventListener("message",dm_AggregationWorker_workerListener);break;case"stop":self.postMessage({admin:"adminListener: WORKER STOPPED: "+b.msg}),self.close();break;default:try{self.postMessage({admin:"adminListener: Unknown command: "+(b&&"object"==typeof b?b.cmd:b)})}catch(c){"forge.setImmediate"!=b&&(console.log("adminListener: Unknown command: "+(b&&"object"==typeof b?b.cmd:b)),console.log(c))}}},self.addEventListener("message",dm_AggregationWorker_workerAdminListener);